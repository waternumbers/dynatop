---
title: "Banding of HSUs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Banding of HSUs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
--- 

# Banding

This document tries to explain the logic in the process of combining
computational bands. The computational bands provide the order needed to solve
the saturated zone kinematic wave routing. That is by proceeding through the
bands in sequence (low to high) ensures the correct inflows are available for
the soltuion of downslope HSUs. 

Simplification by merging the computational bands is not possible without
altering the connectivity of the hillslope representation. However the banding
may increase the lengh of the HSU representations which, ofr a given
computational timestep may result in an improved capturing og kinematic
effects. 
The level of banding, resulting simplification and impact on the solutions is
best determined by experimentation.

# Banding Implimentation

The method of combining the computational bands is as follows

1. Split the surface and saturated zone bands into groups using the `cut`
function on both the surface and saturated zone band values
1. Merge the properties of the HSUs by unique combination of `class`, surface
and saturated zone band groups, using for topographic index and gradient area based
weighting. The for botht he durface ans saturated zones the new band is taken
to minimium of the respective ofiginal bands within the group.
1. Using a perterbation matrix $\mathbf{K}$ compute intitial estimates of the
surface and saturated zone redistribution matrices $\hat{\mathbf{F}_{*}} =
\mathbf{K}^{'}\mathbf{F}_{*}\mathbf{K}$, for both surface and saturated zones.
1. Set all values in the $\hat{\mathbf{F}}_{*}$ matrices that imply flow to an
earlier or equivilent band to zero.
1. Merge all HSUs with no flow redistriubtion; that is they do not contribute to a
downslope HSU; with the next downslope HSU of the same class. In this case
downslope is determined by the saturated zone band. If there is no potential
HSU with which to merge issue a warning.
1. Repeat Steps 4 and 5 until a valid redistribution matrix is acheived.

# A simple simulation experiment

```{r}
require(dynatop)
data(Swindale)
bmdl <- band_model(Swindale$model,5)
check_model(bmdl)
bmdl$hillslope[,'pet'] <- bmdl$channel[,'pet'] <- "PET"
bmdl$hillslope[,'precip'] <- bmdl$channel[,'precip'] <- "Rainfall"
btmp <- dynatop(bmdl,Swindale$obs,0.000001)
```
