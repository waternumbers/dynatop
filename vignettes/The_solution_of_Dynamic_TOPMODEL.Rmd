---
title: "Towards a better Numerical Solution of Dynamic TOPMODEL"
output: 
  bookdown::pdf_document2:
    number_sections: false
    toc: true
    toc_depth: 2
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Towards a better Numerical Solution of Dynamic TOPMODEL}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
#output: rmarkdown::html_vignette
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

** This is a working document outlining the improved numerical solution for Dynamic TOPMODEL**

The dynamic TOPMODEL R package implements a set of numerical solutions to the
governing equations of the dynamic TOPMODEL formulation. One of the underlying
principles of dynamic TOPMODEL is that the landscape can be broken up into
hydrologically similar regions, or Hydrological Response Units (HRUs), where
all the area within an HRU behaves in a hydrologically similar fashion.

While a Hydrological Response Unit (HRU) has typically been thought of as an
area of hillslope the idea may be generalised more broadly. 
This documents considers two types of HRU. The first termed
"hill slope" solves the surface, root, unsaturated and saturated zones
for 'similar' areas of the catchment a each time step.
The second termed "channel" represents a length of river channel. 
In the following the "hill slope" HRU is considered in detail. The "channel"
HRU is refered to only to the extent that an outcome of the computation is the
integral of the flux from the catchment hillslopes to each "channel" HRU.

# Notation and nomenclature

Table \@ref(tab:hru-notation) outlines the notation used for describing a
"hill slope" HRU.


  Quantity type                                   Symbol                   Description                                        unit
  ------------------------------------ -----------------------------       -------------------------------------------- -----------------
  Storage                                        $s_{ex}$                  Surface excess storage                               m
                                                 $s_{rz}$                  Root zone storage                                    m
                                                 $s_{uz}$                  Unsaturated zone storage                             m
                                                 $s_{sz}$                  Saturated zone storage deficit                       m
  Vertical fluxes within HRU               $q_{ex \rightarrow rz}$         Flow from the surface excess store to the     (m$^3$/s)/m$^2$
                                                                           root zone
                                           $q_{rz \rightarrow uz}$         Flow from the root zone to the unsaturated    (m$^3$/s)/m$^2$
                                                                           zone                        
                                           $q_{rz \rightarrow ex}$         Flow from the root zone to the surface        (m$^3$/s)/m$^2$ 
                                                                           excess storage                  
                                           $q_{uz \rightarrow sz}$         Flow from unsaturated to saturated zone       (m$^3$/s)/m$^2$                        
                                           $q_{sz \rightarrow ex}$         Flow from saturated zone to surface           (m$^3$/s)/m$^2$
                                                                           excess storage                    
  Lateral down slope fluxes from HRU             $l_{ex}$                  Total lateral flux from surface excess store  (m$^3$/s)/m$^2$
                                                 $l_{sz}$                  Total lateral flux from saturated zone        (m$^3$/s)/m$^2$
  Other HRU properties                               a                     Area                                              m$^2$
                                         $w^{\left[i,j\right]}_{ex}$       Fraction of $l_{ex}$ going from $j$th to           -
                                                                           $i$th "hill slope" HRU
                                         $w^{\left[i,j\right]}_{sz}$       Fraction of $l_{sz}$ going from $j$th to           - 
                                                                           $i$th "hill slope" HRU
                                         $f^{\left[k,j\right]}_{ex}$       Fraction of $l_{ex}$ going from $j$th              -
                                                                           hill slope HRU to $k$th channel HRU
                                         $f^{\left[k,j\right]}_{sz}$       Fraction of $l_{sz}$ going from $j$th              -
                                                                           hill slope HRU to $k$th channel HRU
                                                $q_{exmax}$                Maximum flow rate from surface excess to      (m$^3$/s)/m$^2$
                                                                           root zone
                                                $s_{rzmax}$                Maximum root zone storage                          m
                                                   $T_d$                   Unsaturated zone time constant per m of 
                                                                           saturated storage deficit.                        h/m
                                                 $l_{szmax}$               Maximum lateral flux from saturated zone      (m$^3$/s)/m$^2$         
                                                 $T_{ex}$                  Surface excess storage time constant               h
                                                    $m$                    Exponential transmissivity constant                -
                                                    
  Table: (\#tab:hru-notation) Outline of notation for describing "hill slope"
  HRUs

All fluxes $q_{* \rightarrow *}$ and $l_{*}$ are considered to be greater or
equal to zero.
Table \@ref(tab:ch-notation) outlines
the additional notation for properties of the channel HRU which are used.

                                   Symbol              Description                                                unit
  ---------------------- ----------------------------- ------------------------------------------------------ ----------------
  Other HRU properties              $a_{ch}$               Area                                                    m$^2$
                                    $v$                   Total inflow from hillslope                           m$^3$/s)/m$^2$
                                    $v_{ex}$              Total inflow from surface excess                      m$^3$/s)/m$^2$
                                    $v_{sz}$              Total inflow from saturated zone                      m$^3$/s)/m$^2$
                                    
  Table: (\#tab:ch-notation) Outline of notation for describing "channel"
  HRUs


From the above a mass conservative system will redirect all flows within the
defined catchment hence:
\[
\sum\limits_{j} w^{\left[j,i\right]} +
    \sum\limits_{k} f^{\left[k,i\right]} =1
\]

Inputs to the system are given in Table \@ref(tab:inputs). 

   Symbol  Description                     unit
  -------- ------------------------------ ------
    $p$    Precipitation rate              m/h
   $e_p$   Potential evapotranspiration    m/h

  Table: (\#tab:inputs) Eternal inputs to HRUs

Later we make use of the following:

-   Superscript notation $^{\left[i\right]}$ to indicate the property of
    the $i$th HRU

-   Bold lower case letter to indicate the column vector of quantities from all
    HRUs, e.g.
    $\mathbf{s}_{rz} = \left(s_{rz}^{\left[1\right]},\ldots,s_{rz}^{\left[n\right]}\right)^{T}$

-   Bold uppercase letters to indicate matrices which may be diagonal if
    the underlying variables is a vector (e.g. $\mathbf{A}$ is a
    diagonal matrix of area) or dense (e.g. $W_{sz}$ where the $j$th
    element of the $i$th row is $w_{sz}^{\left[i,j\right]}$). 
	
-	The identity matrix is written as $\mathbf{I}$. The notation $\mathbf{0}$
     is used to indicate a matrix or vector of zeros whose size can be inferred
     from its location.

-   The notation $\left.x\right\rvert_t$ to indicate the value of the
    variable $x$ at time $t$
	
-	To illustrate some calculations intermediate evaluations variables are
     computed. To distinguish these a $\tilde{}$ is used. For example
	 $\tilde{s}_{rz}$ is an intermediate value in the computation of
     $s_{rz}$. In some cases these values may evolve across multiple
     steps.

# Total Flux to channel HRUs

It is presumed that, from the perspective of the hillslope the channel acts as
a sink. That is there is no feedback from the channel to the hillslope. 
For a single reach:
\[
a^{\left[k\right]} \frac{dv^{\left[k\right]}}{dt} = 
    \sum\limits_{j} f^{\left[k,j\right]}_{ex}a^{\left[j\right]}l^{\left[j\right]}_{ex}
    + \sum\limits_{j} f^{\left[k,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a_{ch}^{\left[k\right]}p
\]
	
For all channel reaches this can be written in matrix form as
\[
\mathbf{A}_{ch}\frac{d\mathbf{v}}{dt} = 
\mathbf{F}_{ex}\mathbf{A}\mathbf{l}_{ex}
+ \mathbf{F}_{sz}\mathbf{A}\mathbf{l}_{sz}
+ \mathbf{A}_{ch}\mathbf{p}
\]
or using the subsitution for the component terms of the flow to the channel
\[
\mathbf{A}_{ch}\frac{d\mathbf{v}}{dt} = 
\mathbf{A}_{ch}\frac{d\mathbf{v}_{ex}}{dt}
+ \mathbf{A}_{ch}\frac{d\mathbf{v}_{sz}}{dt}
+ \mathbf{A}_{ch}\mathbf{p}
\]

The integral of each of the componet terms is evaluated individually to
give $\left.\mathbf{v}\right\rvert_{t+\Delta t} -
      \left.\mathbf{v}\right\rvert_{t}$, 
the total flux to the channel over the timestep.

# Numerical Solution of the Hill slope HRUs

The numerical solution implemented in the dynamic TOPMODEL code is based
on solving the ODE(s) governing the evolution of each of the stores in the
HRUs sequentially while approximating the flux between them.

The following sections present the solutions to the governing equations
in the order they are currently solved in the code for given time
step $\Delta t$ (hr) starting at time $t$ over which the input fluxes ($p$ and $e_p$) are
taken to be constant.

## Step 1: Surface excess redistribution

For the $i$th hill slope HRU the alteration of the surface excess store is
given by
\[ a^{\left[i\right]}\frac{ds^{\left[i\right]}_{ex}}{dt} =  \left(w^{\left[i,i\right]}_{ex}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{ex}
    + \sum\limits_{j \neq i} w^{\left[i,j\right]}_{ex}a^{\left[j\right]}l^{\left[j\right]}_{ex}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz \rightarrow ex}
	+ a^{\left[i\right]}q^{\left[i\right]}_{rz \rightarrow ex}
    - a^{\left[i\right]}q^{\left[i\right]}_{ex \rightarrow rz}
\]
	
For all the hill slope HRU this can be expressed as:
\[
\mathbf{A}\frac{d\mathbf{s}_{ex}}{dt} =  \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{ex}
+ \mathbf{A}\mathbf{q}_{sz \rightarrow ex}
+ \mathbf{A}\mathbf{q}_{rz \rightarrow ex}
- \mathbf{A}\mathbf{q}_{ex \rightarrow rz}
\]

The surface excess store also passes water to the channel. Let 
\[
\mathbf{x} = \left[ \begin{array}{c} \mathbf{s}_{ex} \\
    \frac{d\mathbf{v}_{ex}}{dt} \end{array}\right] 
\]

This allows the evolution of $\mathbf{x}$ to be written as
\[
\left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
         \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]
     \frac{d\mathbf{x}}{dt} =
	      \left[ \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A} \\
              \mathbf{F}_{ex}\mathbf{A} \end{array}\right]
          \mathbf{l}_{ex} +
          \left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
                   \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]
			   \left[ \begin{array}{c} \mathbf{q}_{sz \rightarrow ex} +
                   \mathbf{q}_{rz \rightarrow ex} - \mathbf{q}_{ex \rightarrow rz} \\
                       \mathbf{0} \end{array}\right]
\]

Assuming that there are minimal non-linearities the surface excess stores of
the hill slope HRUs are taken to be linear tanks with
$l^{\left[i\right]}_{ex} = \frac{1}{T_{ex}} s^{\left[i\right]}_{ex}$

Substitution of the flow storage relationship and rearrangement gives
\[
     \frac{d\mathbf{x}}{dt} =
	 \left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
         \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]^{-1}
	      \left[ \begin{array}{cc}
		  \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{T}^{-1}_{ex} \\
              \mathbf{F}_{ex}\mathbf{A}\mathbf{T}^{-1}_{ex} \end{array} & \mathbf{0} \end{array}
			  \right]
          \mathbf{x} +
			   \left[ \begin{array}{c} \mathbf{q}_{sz \rightarrow ex} + \mathbf{q}_{rz \rightarrow ex}- \mathbf{q}_{ex \rightarrow rz}\\
                       \mathbf{0} \end{array}\right]
\]
	
The solution of this is approximated through two stages. 
The first stage redistributes the surface excess storage
$\left.\mathbf{s}_{ex}\right\rvert_{t}$
between the hill slope and channel HRUs ignoring the potential
vertical flux within the HRUs. 
The second stage, carried out in Step 6 corrects for the vertical fluxes.

Specifically letting
\[
\tilde{\mathbf{x}} = \left[ \begin{array}{c} \tilde{\mathbf{s}}_{ex} \\
    \frac{d\mathbf{v}_{ex}}{dt} \end{array}\right]
\]
the ODE initial condition problem
\[
\frac{d\mathbf{x}}{dt}=\left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
         \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]^{-1}
	      \left[ \begin{array}{cc}
		  \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{T}^{-1}_{ex} \\
              \mathbf{F}_{ex}\mathbf{A}\mathbf{T}^{-1}_{ex} \end{array} & \mathbf{0} \end{array}
			  \right]
          \mathbf{x} \quad \mathbf{x}_{0} = \left[\begin{array}{c}
                                                    \left.\mathbf{s}_{ex}\right\rvert_t
                                                    \\ \mathbf{0}\end{array}\right]
\]

is solved (see appendix) to give
\[
\left[\begin{array}{c} \left.\tilde{s}_{ex}\right\rvert_{t+\Delta t} \\
    \left.\mathbf{v}_{ex}\right\rvert_{t+\Delta t} -
    \left.\mathbf{v}_{ex}\right\rvert_{t}
  \end{array}\right]
\]
This represents an intermediate solution to the surface excess storage and
approximation to the total flux from the surface excess store to the channel HRUs.

## Step 2: Root Zone

For a single HRU
\[
\frac{ds_{rz}}{dt}=p + q_{ex \rightarrow rz}
-\frac{s_{rx}}{s_{rzmax}}e_{p}-q_{rz \rightarrow ex} - q_{rz \rightarrow uz}
\]
Assuming all the water in the surface excess store is available to the root
zone so long as $q_{ex \rightarrow rz} \leq q_{exmax}$ the integral of the
flow from the surface excess store can be approximated by
\[
\int\limits_{\Delta t} q_{ex \rightarrow rz} dt =
\min\left(q_{exmax}\Delta t,\left.\tilde{s}_{ex}\right.\rvert_{t+\Delta t}\right)
\]
Using this the root zone is solved as a two step process. Firstly the ODE
\[
\frac{d\tilde{s}_{rz}}{dt} = p
+ \frac{1}{\Delta t}\int\limits_{\Delta t} q_{ex \rightarrow rz} dt
- \frac{e_{p}}{s_{rzmax}}\tilde{s}_{rz} \quad
\left. \tilde{s}_{rz}\right\rvert_{t} = \left. s_{rz}\right\rvert_{t}
\]
is solved to give
\[
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} = 
\left. s_{rz}\right\rvert_{t} \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta
t\right)
+ \left(p
+ \frac{1}{\Delta t}\int\limits_{\Delta t} q_{ex \rightarrow rz} dt \right)
\frac{s_{srmax}}{e_p}
\left(1 - \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta t\right)\right)
\]
which is the root zone storage not allowing for losses to the surfce excess
store or unsaturated zone. From this
\[
\left. s_{rz}\right\rvert_{t + \Delta t} =
\min\left(\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t}, s_{rzmax}\right)
\]
and the total water passed from the root zone is
\[
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\]

The water passed from the root zone can be passed either to the surface excess
storage or the unsaturated zone. If $\left. s_{sz}\right\rvert_{t} = 0$ the
flux from the root zone is passed to the
surface excess store giving 
\[
\int_{\Delta t} q_{rz \rightarrow ex} dt =
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\]
and $\int_{\Delta t} q_{rz \rightarrow uz} dt = 0$.
If $\left. s_{sz}\right\rvert_{t} > 0$ then the flux from the root zone is
passed to the unsaturated zone store by taking
\[
\int_{\Delta t} q_{rz \rightarrow uz} dt =
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\] 
and $\int_{\Delta t} q_{rz \rightarrow ex} dt = 0$.

## Step 4: Unsaturated Zone

For a single HRU the unsaturated zone representation of a non-linear tank whose time
constant is dependent upon the saturation deficit:
\[
\frac{ds_{uz}}{dt}=q_{rz \rightarrow uz}-\frac{s_{uz}}{s_{sz}T_{d}}
\]

In keeping with the root zone the
solution to the governing ODE is approximated by
\[
\frac{d\tilde{s}_{uz}}{dt} =
\frac{1}{\Delta t}\int_{\Delta t} q_{rz \rightarrow uz} dt
- \frac{\tilde{s}_{uz}}{\left.s_{sz}\right\rvert_{t}T_{d}} \quad
\left.\tilde{s}_{uz}\right\rvert_{t} = \left.s_{uz}\right\rvert_{t}
\]

which is given by 
\[
\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t} =
\left.s_{uz}\right\rvert_{t}\exp\left(-\frac{\Delta
  t}{\left.s_{sz}\right\rvert_{t}T_d}\right)
+ \frac{1}{\left.s_{sz}\right\rvert_{t}T_{d}\Delta t}
\int_{\Delta t} q_{rz \rightarrow uz} dt
 \left(1 -
 \exp\left(-\frac{\Delta t}{\left. s_{sz}\right\rvert_{t}T_{d}}\right)\right)
\]
Mass balance then gives
\[
\int_{\Delta t} q_{uz \rightarrow sz} dt =  \left.s_{uz}\right\rvert_{t} + \int_{\Delta t}
q_{rz \rightarrow uz} dt - \left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}
\]

The above solution ensures that $\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}$
equals 0 if $\left.s_{sz}\right\rvert_{t}=0$. However to ensure that
$\left.s_{uz}\right\rvert_{t+\Delta t} =0$ if $\left.s_{sz}\right\rvert_{t+\Delta
  t}=0$ the estimate $\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}$ is revised
  after computation of the saturated zone.
  
## Step 5: Saturated Zone

For the $i$th hill slope HRU the change in saturated zone storage deficit is
given by 
\[
a^{\left[i\right]}\frac{ds^{\left[i\right]}_{sz}}{dt} =
-a^{\left[i\right]}q^{\left[i\right]}_{uz \rightarrow sz} - \left(w^{\left[i,i\right]}_{sz}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{sz}
    - \sum\limits_{j \neq i}
    w^{\left[i,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz \rightarrow ex}
\]	
An assumed transmissivity profile gives the function $\tau\left(l,s\right)>0$ such that:
\[
\frac{dl^{\left[i\right]}_{sz}}{dt} =
-\tau\left(l^{\left[i\right]}_{sz},s^{\left[i\right]}_{sz}\right)\frac{ds^{\left[i\right]}_{sz}}{dt}
\]
The flux $q^{\left[i\right]}_{sz \rightarrow ex}$ ensures that
$s^{\left[i\right]}_{sz} \geq 0$ and
$l^{\left[i\right]}_{sz} \leq l^{\left[i\right]}_{szmax}$.

The solution of these limited joint set of ODEs are not trivial. In deriving an approximation the focus in on maintaining a mass balance. Integrating the evolution of the storage deficit gives
\[
\left. s^{\left[i\right]}_{sz} \right.\rvert_{t+\Delta t} -
\left. s^{\left[i\right]}_{sz} \right.\rvert_{t}
=
-\int_{\Delta t} q^{\left[i\right]}_{uz \rightarrow sz} dt
-\left(w^{\left[i,i\right]}_{sz}-1\right)\int_{\Delta t} l^{\left[i\right]}_{sz} dt
-  \frac{1}{a^{\left[i\right]}} \sum\limits_{j \neq i}
    w^{\left[i,j\right]}_{sz}a^{\left[j\right]}\int_{\Delta t} l^{\left[j\right]}_{sz} dt
    + \int_{\Delta t} q^{\left[i\right]}_{sz \rightarrow ex} dt
\]

Next let us assume that the HRUs are ordered so that when evaluating the $i$th HRU an estimate of
\[
Q^{\left[i\right]}=
\int_{\Delta t} q^{\left[i\right]}_{uz \rightarrow sz} dt +
 \frac{1}{a^{\left[i\right]}} \sum\limits_{j \neq i}
    w^{\left[i,j\right]}_{sz}a^{\left[j\right]}\int_{\Delta t}
    l^{\left[j\right]}_{sz} dt
\]
is available.

Dropping the superscript this gives
\[
\left. s_{sz} \right.\rvert_{t+\Delta t} -
\left. s_{sz} \right.\rvert_{t}
=
-Q
-\left(w_{sz}-1\right)\int_{\Delta t} l_{sz} dt
    + \int_{\Delta t} q_{sz \rightarrow ex} dt
\]

To generate an estimate of the integrals in the above expression an approximation of the evolution of the flow is solved.
Firstly using $Q$ gives
\[
\frac{dl_{sz}}{dt} =
\tau\left(l_{sz},s_{sz}\right)
\left(\frac{1}{\Delta t}Q 
+\left(w_{sz}-1\right) l_{sz}
    - q_{sz \rightarrow ex}
    \right)
\]

Next further simplify the equation by assuming that $q_{sz \rightarrow ex}$ and $\tau\left(l_{sz},s_{sz}\right)$ take constant value $\bar{q}_{sz \rightarrow ex}$ and $\bar{\tau}$ during the time step. Constructing $\bar{\tau}$ is consider later. This gives
\[
\frac{dl_{sz}}{dt} =
\bar{\tau}
\left(\frac{1}{\Delta t}Q 
+\left(w_{sz}-1\right) l_{sz}
    - \bar{q}_{sz \rightarrow ex}
    \right)
\]

Minor rearrangement gives
\[
\frac{dl_{sz}}{dt} =
\bar{\tau}\left(\frac{1}{\Delta t}Q - \bar{q}_{sz \rightarrow ex}\right)
- \bar{\tau}\left(1 - w_{sz}\right) l_{sz}
\]
Let $\alpha = \left(\frac{1}{\Delta t}Q - \bar{q}_{sz \rightarrow ex}\right)$ and
$\beta = \bar{\tau}\left(1 - w_{sz}\right)$
Using solutions given in the appendix this gives
\[
\left. l \right.\rvert_{t+\Delta t} =
\left. l \right.\rvert_{t} \exp\left(-\beta \Delta t\right) +
\frac{\alpha\bar{\tau}}{\beta}\left(1-\exp\left(-\beta \Delta t\right)\right)
\]
and
\[
\int_{\Delta t} l_{sz} dt = \frac{\left. l \right.\rvert_{t}}{\beta}\left(1-\exp\left(-\beta \Delta
t\right)\right) +
\frac{\alpha\bar{\tau}}{\beta}t -
\frac{\alpha\bar{\tau}}{\beta^2}\left(1- \exp\left(-\beta \Delta t\right)\right)
\]
These two expression rely on the unknown $\bar{q}_{sz \rightarrow ex}$ through
$\alpha$.

The limit $l_{szmax}$ gives
\[
\left. l \right.\rvert_{t} \exp\left(-\beta \Delta t\right) +
\frac{\alpha\bar{\tau}}{\beta}\left(1-\exp\left(-\beta \Delta t\right)\right) \leq l_{szmax}
\]
or noting that $\bar{\tau},\beta > 0$
\[
\alpha \leq
\frac{l_{szmax} - \left. l \right.\rvert_{t} \exp\left(-\beta \Delta t\right)}
{\left(1-\exp\left(-\beta \Delta t\right)\right)}\frac{\beta}{\bar{\tau}}
\]

Subsitution into the mass balance equation gives
\[
\left. s_{sz} \right.\rvert_{t+\Delta t} -
\left. s_{sz} \right.\rvert_{t}
=
- \alpha \Delta t
+\left(1-w_{sz}\right) \left(
\frac{\left. l \right.\rvert_{t}}{\beta}\left(1-\exp\left(-\beta \Delta
t\right)\right) +
\frac{\alpha\bar{\tau}}{\beta}\Delta t -
\frac{\alpha\bar{\tau}}{\beta^2}\left(1- \exp\left(-\beta \Delta t\right)\right)
\right)
\]
which simplifies to
\[
\left. s_{sz} \right.\rvert_{t+\Delta t} -
\left. s_{sz} \right.\rvert_{t}
=
\frac{\left. l \right.\rvert_{t}}{\bar{\tau}}\left(1-\exp\left(-\beta \Delta
t\right)\right)
- \frac{\alpha}{\beta}\left(1- \exp\left(-\beta \Delta t\right)\right)
\]

Since the storage deficit is greater or equal to zero:
\[
\left. s_{sz} \right.\rvert_{t} + \frac{\left. l \right.\rvert_{t}}{\bar{\tau}}\left(1-\exp\left(-\beta \Delta
t\right)\right) \geq \frac{\alpha}{\beta}\left(1- \exp\left(-\beta \Delta t\right)\right)
\]
or eqivilently
\[
\left. s_{sz} \right.\rvert_{t} \frac{\beta}{\left(1- \exp\left(-\beta \Delta
  t\right)\right)}
+\frac{\left. l \right.\rvert_{t} \beta}{\bar{\tau}} \geq \alpha
\]

From these inequalities, the definition of $\alpha$ and the fact that $q_{sz
\rightarrow ex}$ occurs only when a limit is reached that
\[
\alpha = \min\left(
\frac{Q}{\Delta t},
\left. s_{sz} \right.\rvert_{t} \frac{\beta}{\left(1- \exp\left(-\beta \Delta
  t\right)\right)}
+\frac{\left. l \right.\rvert_{t} \beta}{\bar{\tau}},
\frac{l_{szmax} - \left. l \right.\rvert_{t} \exp\left(-\beta \Delta t\right)}
     {\left(1-\exp\left(-\beta \Delta t\right)\right)}\frac{\beta}{\bar{\tau}}
     \right)
\]
This allow the calculation of $\bar{q}_{sz \rightarrow ex}$ and
approximations to the final state of the lateral flux and storage deficit
along with the integral of the lateral flux using the expressions already given.

### Estimating $\bar{\tau}$

The above solution methodology relies on the estimate of an "average"
transmissivity value $\bar{\tau}$. A relatively simple approach to
constructing $\bar{\tau}$, inspired by predictor-corrector integration methods
is take 
$\tilde{\tau} = \tau\left(\left. l_{sz}\right.\rvert_{t},\left. s_{sz}\right.\rvert_{t}\right)$
and produce initial estimates of the storage ($\tilde{s}_{sz}$) and
lateral flux ($\tilde{l}_{sz}$) at the end of the time step. The "average"
transmissity can then be taken as
\[
\bar{\tau} = \frac{1}{2}\left(\tilde{\tau} +
\tau\left(\tilde{l}_{sz},\tilde{s}_{sz}\right)\right)
\]

## Step 6: Correcting vertical stores

Having evaluated the stores in the direction of gravity there is the need to
correct for vertical fluxes returning water to the surface thus increase
$s_{ex}$. 
The correction takes two forms depending upon if the HRU is saturated. 
If $\left. s_{sz}\right. \rvert_{t+\Delta t} = 0$ then
\[
\left. s_{ex} \right. \rvert_{t+\Delta t} = \left.\tilde{s}_{ex}\right. \rvert_{t+\Delta t} + \Delta t
\bar{q}_{sz \rightarrow ex} + \left.\tilde{s}_{uz}\right. \rvert_{t+\Delta t}
\]
and $\left. s_{uz} \right. \rvert_{t+\Delta t} = 0$.
If $\left. s_{sz}\right. \rvert_{t+\Delta t} > 0$ then
\[
\left. s_{ex} \right. \rvert_{t+\Delta t} = \left.\tilde{s}_{ex}\right. \rvert_{t+\Delta t} + \Delta t
\bar{q}_{sz \rightarrow ex}
\]
and $\left. s_{uz} \right. \rvert_{t+\Delta t} = \left.\tilde{s}_{uz}\right. \rvert_{t+\Delta t}$

## Step 7: Estimating Channel Inflow

The average inflow to a channel HRU over the time step in cumecs is given by
total flux to the channel HRU in cubic meters divided by the time step in
seconds.

The total flux to the channels HRUs from the surface excess storage is
\[
\mathbf{A}_{ch}\left(
\left.\mathbf{v}_{ex}\right\rvert_{t+\Delta t} -
\left.\mathbf{v}_{ex}\right\rvert_{t}
\right)
\]
where the terms in the equations are computed in Step 1.

Since the inflow from the saturated zone is proportional to the lateral flux
of the hillslope HRUs the channel the total inflow is
\[
\mathbf{F}_{ex}\mathbf{A}\left[ \begin{array}{c}
    \int_{\Delta t} l^{\left[1\right]}_{sz} dt \\
    \vdots \\
    \int_{\Delta t} l^{\left[n\right]}_{sz} dt
  \end{array}
  \right]
\]
where the value of the intergrals is computed in Step 5.

Finally the precipitation input is given by $\mathbf{A}_{ch} \mathbf{p} \Delta t$
giving the total channel inflows in cumecs as:
\[
\frac{1}{3600\Delta t} \left(
\mathbf{A}_{ch}\left(
\left.\mathbf{v}_{ex}\right\rvert_{t+\Delta t} -
\left.\mathbf{v}_{ex}\right\rvert_{t}
\right) +
\mathbf{F}_{ex}\mathbf{A}\left[ \begin{array}{c}
    \int_{\Delta t} l^{\left[1\right]}_{sz} dt \\
    \vdots \\
    \int_{\Delta t} l^{\left[n\right]}_{sz} dt
  \end{array}
  \right] +
\mathbf{A}_{ch} \mathbf{p} \Delta t \right)
\]

# Ordinary Differential Equations Solutions

For completeness the solutions to the ODEs made use of above are
documented here.

## Single variable non-homogeneous ODE with constant input

The initial condition
problem$$\frac{dx\left(t\right)}{dt} = a - b x\left(t\right) \quad x\left(0\right) = x_0$$
or more compactly
$$x^{\prime}\left(t\right) = a - b x\left(t\right) \quad x\left(t_0\right) = x_0$$
involves the solution of first order linear system. This can be solved
explicitly using an ‘integrating factor’. Let
$\mu = \exp\left(\int\limits_t b dt\right) = \exp\left(bt\right)$.
Multiplying both sides by $\mu$ then integrating (noting the LHS is the
result of the product formula in differentiation) gives
$$\exp\left(bt\right) x = \int\limits_{t} a\exp\left(bt\right) dt = \frac{a}{b}\exp\left(bt\right) + K$$
The constant $K$ can be evaluates using the initial conditions as
$K=x_{0}-\frac{a}{b}$. Substitution and rearrangement then gives
$$x = x_{0}\exp\left(-bt\right) + \frac{a}{b}\left(1-\exp\left(-bt\right)\right)$$
Note that $$\begin{array}{c}
        x\rightarrow0 \quad\mathrm{as}\quad b\rightarrow\infty\\
        x\rightarrow x_{0} + at \quad\mathrm{as}\quad b\rightarrow0\\
    \end{array}$$

Consider next the integral of $x$ with $t$ for $t>0$. The general solution is
\[
\int_{0}^{t} x dt = -\frac{x_{0}}{b}\exp\left(-bt\right) +
\frac{a}{b^2}\left(bt + \exp\left(-bt\right)\right) + C
\]
where the constant $C$ depends on the value of the intergral at $t=0$. Taking
this to be zero gives
\[
\int_{0}^{t} x dt = \frac{x_{0}}{b}\left(1-\exp\left(-bt\right)\right) +
\frac{a}{b}t -
\frac{a}{b^2}\left(1- \exp\left(-bt\right)\right)
\]

## Multiple variable homogeneous ODE

The solution to the initial value problem
$$\frac{d\mathbf{x}\left(t\right)}{dt} = \mathbf{A} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$
or more compactly
$$\mathbf{x}^{\prime}\left(t\right) = \mathbf{A} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$
is computed using the eigen value method.

Suppose $\mathbf{x}$ is of length $n$ and $\mathbf{A}$ has suitably unique eigen values
$\mathbf{\lambda}$. Taking $\mathbf{M}$ to be the matrix of eigen vectors
$$
\mathbf{x}\left(t\right) = \mathbf{M} \left[\begin{array}{c}
c_1 \exp\left(\lambda_1t\right) \\
\vdots \\
c_n \exp\left(\lambda_nt\right)
\end{array}
\right]
$$
where the constant $\mathbf{c}$ can be estimated from the initial conditions
at time 0 as
$$ \mathbf{c} = \mathbf{M}^{-1} \mathbf{x}_{0} $$

