---
title: "The Numerical Solution of Dynamic TOPMODEL"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The Numerical Solution of Dynamic TOPMODEL}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
The dynamic TOPMODEL R package impliments a set of numerical solutions to the
governing equations of the dynamic TOPMODEL formulation. This vignette
documents the formaulation and the numerical solutions used. It also outlines
a number of potential changes to the code which may improves it.

```{r setup}
## library(dynatop)
```
# Notation and nomenclature

Consider two types of Hydrological response unit (HRU). The first termed
"hillslope" solves the surface, root, unsaturated and saturated zones
for 'similar' areas of the catchment a each time step.
Table [tab:hru_notation] outlines the notation used for describing a
"hillslope" HRU.


  Quantity type                                   Symbol             Description                                                unit
  ------------------------------------ ----------------------------- ---------------------------------------------------- -----------------
  Storage                                        $s_{ex}$            Surface excess storage                                       m
                                                 $s_{rz}$            Root zone storage                                            m
                                                 $s_{uz}$            Unsaturated zone storage                                     m
                                                 $s_{sz}$            Saturated zone storage deficit                               m
  Vertical fluxes within HRU                     $q_{rz}$            Flow from Root to unsaturated zone                    (m$^3$/s)/m$^2$
                                                 $q_{uz}$            Flow from unsaturated to saturated zone               (m$^3$/s)/m$^2$
                                                 $q_{sz}$            Flow from saturated zone to surface excess storage    (m$^3$/s)/m$^2$
  Lateral down slope fluxes from HRU             $l_{ex}$            Total lateral flux from surface excess                (m$^3$/s)/m$^2$
                                                 $l_{sz}$            Total lateral flux from saturated zone                (m$^3$/s)/m$^2$
  Other HRU properties                               a               Area                                                       m$^2$
                                        $w^{\left[i,j\right]}_{ex}$  fraction of $l_{ex}$ going from $j$th to $i$th HRU           -
                                        $w^{\left[i,j\right]}_{sz}$  fraction of $l_{sz}$ going from $j$th to $i$th HRU           -
                                                $s_{rzmax}$          maximum root zone storage                                    m
                                                   $T_d$             Unsaturated zone time constant per m of saturated           h/m
                                                                     storage deficit.
                                                 $T_{ex}$            Surface excess storage time constant                         h
                                                    $m$              Exponential transmissivity constant                                                -

  Table: Outline of notation for describing “hillslope”
  HRUs[]{data-label="tab:hru_notation"}

The second, termed "chanel" represents the inflow to a length of river
channel. As such it acts as a sink collecting water from the “hillslope”
HRUs over the course of a time step. Table [tab:ch\_notation] outlines
the notation for channel HRU.

                                   Symbol             Description                                                                 unit
  ---------------------- ----------------------------- -------------------------------------------------------------------------- -------
  Storage                          $s_{ch}$            channel storage                                                               m
  Other HRU properties                 a               Area                                                                        m$^2$
                          $f^{\left[k,j\right]}_{ex}$  fraction of $l_{ex}$ going from $j$th hillslope HRU to $k$th channel HRU      -
                          $f^{\left[k,j\right]}_{sz}$  fraction of $l_{sz}$ going from $j$th hillslope HRU to $k$th HRU              -

  Table: Outline of notation for describing “channel”
  HRUs[]{data-label="tab:ch_notation"}


From the above a mass conservative system will redirect all flows within the
    defined catchment hence:
    $$\sum\limits_{j} w^{\left[j,i\right]} +
    \sum\limits_{k} f^{\left[k,i\right]} =1$$

Inputas to the system are given in Table [tab:inputs]. These are treated as
being the same for every HRU though the calculations readily allow for them to
vary by HRU.

   Symbol  Description                     unit
  -------- ------------------------------ ------
    $p$    Precipitation rate              m/h
   $e_p$   Potential evapotranspiration    m/h

  Table: Eternal inputs to HRUs[]{data-label="tab:inputs"}

Later we make use of the following:

-   Superscript notation $^{\left[i\right]}$ to indicate the property of
    the $i$th HRU

-   Bold lower case letter to indicate the column vector of quanties from all
    HRUs, e.g.
    $\mathbf{q}_{rz} = \left(q_{rz}^{\left[1\right]},\ldots,q_{rz}^{\left[n\right]}\right)^{T}$

-   Bold uppercase letters to indicate matrices which may be diagonal if
    the underlying variables is a vector (e.g. $\mathbf{A}$ is a
    diagonal matrix of area) or dense (e.g. $W_{sz}$ where the $j$th
    element of the $i$th row is $w_{sz}^{\left[i,j\right]}$). 
	
-	The identity matrix is written as $\mathbf{I}$. The notation $\mathbf{0}$
     is used to indicate a matrix of vecotr fo zeros whose size can be infered
     from its location.

-   The notation $\left.x\right\rvert_t$ to indicate the value of the
    variable $x$ at time $t$
	
-	To illisutrate some calculations intermediate evaluations variables are
     computed. To distinguish these a $\tilde{}$ is used. For example
	 $\tilde{q}_{rz}$ is an intermediate value in the computation of
     $q_{rz}$. In some cases these values may evolve across multiple
     steps. Where needed the superscript $^\left[-\right]$ will be used to
     indicate the value at the start of the step and $^\left[+\right]$ that at
     the end.

# Numerical Solution

The numerical solution implemented in the dynamic TOPMODEL code is based
on solving the ODE(s) governing the evolution of each of the stores in the
HRUs sequentially while approximating the flux between then.

The following sections present the solutions to the governing equations
in the order they are currently solved in the code for given time
step $\Delta t$ (hr) starting at time $t$ over which the input fluxes ($p$ and $e_p$) are
taken to be constant.

## Step 1: Initialising the channel storage
The channel acts as a sink with no outflows. For a single reach:
$$a^{\left[k\right]}\frac{ds^{\left[k\right]}_{ch}}{dt} = 
    \sum\limits_{j} f^{\left[k,j\right]}_{ex}a^{\left[j\right]}l^{\left[j\right]}_{ex}
    + \sum\limits_{j} f^{\left[k,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a^{\left[k\right]}p$$
For all channel reaches this can be written in matrix form as
$$\mathbf{A}_{ch}\frac{d\mathbf{s}_{ch}}{dt} = 
    \mathbf{F}_{ex}\mathbf{A}\mathbf{l}_{ex}
    + \mathbf{F}_{sz}\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{A}_{ch}p$$ 
or equivilently
$$\frac{d\mathbf{s}_{ch}}{dt} = 
    \mathbf{A}^{-1}_{ch}\mathbf{F}_{ex}\mathbf{A}\mathbf{l}_{ex}
    + \mathbf{A}_{ch}^{-1}\mathbf{F}_{sz}\mathbf{A}\mathbf{l}_{sz}
    +p$$

The solution presumes that $\left.\mathbf{s}_{ch}\right\rvert_{t}=\mathbf{0}$
with the integral of each of the summed terms being evaluated individually to
give the total $\left.\mathbf{s}_{ch}\right\rvert_{t+\Delta t}$.
The easiest of these terms to integrate is the precipitation input which gives
\[ \tilde{\mathbf{s}}_{ch} = \mathbf{I}p\Delta t \]

## Step 2: Surface excess redistribution

For the $i$th hillslope HRU the alteration of the surface excess store is
given by
\[ a^{\left[i\right]}\frac{ds^{\left[i\right]}_{ex}}{dt} =  \left(w^{\left[i,i\right]}_{ex}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{ex}
    + \sum\limits_{j \neq i} w^{\left[i,j\right]}_{ex}a^{\left[j\right]}l^{\left[j\right]}_{ex}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz}
	\] 
For all the hillslope HRU this can be expressed as:
$$\mathbf{A}\frac{d\mathbf{s}_{ex}}{dt} =  \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{ex}
    + \mathbf{A}\mathbf{q}_{sz}$$
The surface excess store also passes water to the channel. Let $\mathbf{y}$ be
the contribution to the channel storage from surface excess and 
\[ \mathbf{x} = \left[ \begin{array}{c} \mathbf{s}_{ex} \\
                       \mathbf{y} \end{array}\right] \]
This allows the evolution of $\mathbf{x}$ to be written as
$$
\left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
         \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]
     \frac{d\mathbf{x}}{dt} =
	      \left[ \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A} \\
              \mathbf{F}_{ex}\mathbf{A} \end{array}\right]
          \mathbf{l}_{ex} +
          \left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
                   \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]
			   \left[ \begin{array}{c} \mathbf{q}_{sz} \\
                       \mathbf{0} \end{array}\right]
$$
					   
Assuming that thereare minimal non-linearities the surface excess stores of
the hillslope HRUs are taken to be linear tanks with
$l^{\left[i\right]}_{ex} = \frac{1}{T_{ex}} s^{\left[i\right]}_{ex}$

Substituation of the flow storage relationship and rearrangement gives
$$
     \frac{d\mathbf{x}}{dt} =
	 \left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
         \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]^{-1}
	      \left[ \begin{array}{cc}
		  \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{T}^{-1}_{ex} \\
              \mathbf{F}_{ex}\mathbf{A}\mathbf{T}^{-1}_{ex} \end{array} & \mathbf{0} \end{array}
			  \right]
          \mathbf{x} +
			   \left[ \begin{array}{c} \mathbf{q}_{sz} \\
                       \mathbf{0} \end{array}\right]
$$
	
The solution of this is carried out through two stages. The first
stage redistributes the surface excess storage $\left.\mathbf{s}_{ex}\right\rvert_{t}$ between the
hillslope and channel HRUs on the presumption that there is no inflow
($\mathbf{q}_{sz}=\mathbf{0}$). The second stage, carried out in later steps
adds the inflow term.

Specifically letting
\[ \tilde{\mathbf{x}} = \left[ \begin{array}{c} \tilde{\mathbf{s}}_{ex} \\
                       \tilde{\mathbf{s}}_{ch} \end{array} \right] \]
the ODE initial condition problem
$$\frac{d\mathbf{x}}{dt}=\left[ \begin{array}{cc} \mathbf{A} & \mathbf{0} \\
         \mathbf{0} & \mathbf{A}_{ch} \end{array} \right]^{-1}
	      \left[ \begin{array}{cc}
		  \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{T}^{-1}_{ex} \\
              \mathbf{F}_{ex}\mathbf{A}\mathbf{T}^{-1}_{ex} \end{array} & \mathbf{0} \end{array}
			  \right]
          \mathbf{x} \quad \mathbf{x}_{0} = \left[\begin{array}{c}
                                                    \left.\mathbf{s}_{ex}\right\rvert_t
\\ \tilde{\mathbf{s}}_{cg}^{\left[-\right]}\end{array}\right]$$ 
is solve using the eigenvalue method to give
$$
\left[\begin{array}{c} \tilde{s}_{ex} \\
\tilde{\mathbf{s}}_{ch}^{\left[+\right]} \end{array}\right]
$$
an intermediate solution to the surface excess and channel storage through the
redistribution of the initiual surface excess water.

### Comments

1. The flow to the channel is possibly underestimated since $\mathbf{q}_{sz}$
   may be positive.
1. The possible inflow to the surface store from the root zone is not
   currently included in the description since it is unclear if this is a
   numeric or conceptual feature.
1. Since the only interaction between the other stores and the surface excess
   is  $\mathbf{q}_{sz}$ this step could be evaluated later with an estimate
   of $\mathbf{q}_{sz}$

## Step 3: Root Zone

For a single HRU
$$\frac{ds_{rz}}{dt}=p-\frac{s_{rx}}{s_{rzmax}}e_{p}-q_{rz}$$ where
$$q_{rz} = \left\{ \begin{array}{cc}
    0 & s_{rx} \leq s_{rzmax}\\
    p-\frac{s_{rx}}{s_{rzmax}}e_{p} & s_{rx} > s_{rzmax}
    \end{array} \right.$$

The root zone is solved as a two step process. Firstly the ODE
$$\frac{d\tilde{s}_{rz}}{dt}=p-\frac{e_{p}}{s_{rzmax}}\tilde{s}_{rz} \quad  \left. \tilde{s}_{rz}\right\rvert_{t} = \left. s_{rz}\right\rvert_{t}$$
to give $$\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} = 
    \left. s_{rz}\right\rvert_{t} \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta t\right) + p\frac{ s_{srmax}}{e_p}\left(1 - \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta t\right)\right)$$
which can be though off as the unconstrained root zone storage. Then
from this
$$\left. s_{rz}\right\rvert_{t + \Delta t} = \min\left(\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t}, s_{rzmax}\right)$$
and the total water passed from the root zone is
$\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} - \left. s_{rz}\right\rvert_{t + \Delta t}$.

The water passed from the root zone can be passed wither to the surface excess
storage or the unsaturated zone. If $\left. s_{sd}\right\rvert_{t} = 0$ the water is passed to the
surface excess store, that is 
$$ \tilde{s}_{ex}^{\left[+\right]} =
   \tilde{s}_{ex}^{\left[-\right]} +
 \left.\tilde{s}_{rz}\right\rvert_{t + \Delta t} -
 \left. s_{rz}\right\rvert_{t + \Delta t}$$ 
and $\int_{\Delta t} q_{rz} dt = 0$, otherwise
$$\int_{\Delta t} q_{rz} dt = \left. \tilde{s}_{rz}\right\rvert_{t + \Delta
  t} - \left. s_{rz}\right\rvert_{t + \Delta t}$$ 
and $\tilde{s}_{ex}^{\left[+\right]} = \tilde{s}_{ex}^{\left[-\right]}$

### Comments
1.  The assigning of the water fromt he root zone to either the excess storage
    or unsaturated zone can be considered in two ways:
	- a concptual choice indicating the beleif that this water is distributed
    with teh surface rather then saturated zone lateral fluxes.
	- a method of ensuring a suitable numerical solution in the unsaturated
    zone when there is no saturated deficit (see comments below).

## Step 4: Unsaturated Zone
For a single HRU the unsaturated zone represention of a non-linear tank whose time
constant is dependent upon the saturation deficit:
$$\frac{ds_{uz}}{dt}=q_{rz}-\frac{s_{uz}}{s_{sz}T_{d}}$$

The formulation does not admit a simple solution. The current code impliments
an explicit solution presuming that all the water passed from the root zone is
available for flow to the saturated zone. Computationally the following
steps are performed:

-   Add inflow from the root zone to give
    $\tilde{s}_{uz} = \left. s_{uz}\right\rvert_{t} + \int_{\Delta t} q_{rz} dt$

-   Compute $q_{uz} = \left\{ \begin{array}{cc}
        \min\left(
        \frac{\tilde{s}_{uz}}{\left. s_{sz}\right\rvert_{t}T_d}, \frac{\tilde{s}_{uz}}{\Delta t}\right) & \left. s_{sz}\right\rvert_{t} >0 \\ 0 & \mathrm{otherwise} \end{array}\right.$

-   Set
    $\left. s_{uz}\right\rvert_{t+\Delta t} = \tilde{s}_{uz} - q_{uz} \Delta t$

### Comments

1.  The approximation above can result in water being left in the
    unsaturated zone if the later step makes $s_{sz}=0$ while
    $s_{uz} > 0$. This may motivate the ‘switch’ in where the outflow
    from the root zone goes.

1.  It is unclear why $q_{uz}=0$ when $\left.s_{sz}\right\rvert_{t} = 0$. Setting
    $q_{uz} = \frac{\tilde{s}_{uz}}{\Delta t}$ in this situation would ensure the unsaturated
    zone is drained into the saturated zone. It would also allow the removal
    of the 'switch' in the root zone outflow if implimented for numerical reasons.

1.  An alternative solution more in keeping with that for the root zone is to approximate the
    solution to the governing ODE by the solution to
    $$\frac{d\tilde{s}_{uz}}{dt}= \frac{1}{\Delta t}\int_{\Delta t} q_{rz} dt - \frac{\tilde{s}_{uz}}{\left.s_{sz}\right\rvert_{t}T_{d}} \quad \left.\tilde{s}_{uz}\right\rvert_{t} = \left.s_{uz}\right\rvert_{t}$$
    which is given by $$\left.s_{uz}\right\rvert_{t+\Delta t} = 
            \left.s_{uz}\right\rvert_{t}\exp\left(-\frac{\Delta t}{\left. s_{sz}\right\rvert_{t}T_d}\right)+\frac{1}{\Delta t}\int_{\Delta t} q_{rz} dt\left. s_{sz}\right\rvert_{t}T_d\left(1 - \exp\left(-\frac{\Delta t}{\left. s_{sz}\right\rvert_{t}T_d}\right)\right)$$.
    Mass balance then gives
    $$\int_{\Delta t} q_{uz} dt =  \left.s_{uz}\right\rvert_{t} + \int_{\Delta t} q_{rz} dt - \left.s_{uz}\right\rvert_{t+\Delta t}$$
    This solution behaves appropriately as the saturated zone wets and
    negates the need to pass the flux from the root zone directly to the
    surface excess for numerical reasons.

## Step 4: Saturated Zone

For the $i$th hillslope HRU the change in staturated zone storage deficit is
given by 
$$a^{\left[i\right]}\frac{ds^{\left[i\right]}_{sz}}{dt} = -a^{\left[i\right]}q^{\left[i\right]}_{uz} - \left(w^{\left[i,i\right]}_{sz}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{sz}
    - \sum\limits_{j \neq i} w^{\left[i,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz}$$ 
For the assumed exponential transmissivity profile:
$$\frac{dl^{\left[i\right]}_{sz}}{dt} = -\frac{l^{\left[i\right]}_{sz}}{m}\frac{ds^{\left[i\right]}_{sz}}{dt}$$
which gives
$$-a^{\left[i\right]}\frac{m}{l^{\left[i\right]}_{sz}}\frac{dl^{\left[i\right]}_{sz}}{dt}
    = -a^{\left[i\right]}q^{\left[i\right]}_{uz} - \left(w^{\left[i,i\right]}_{sz}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{sz}
    - \sum\limits_{j \neq i} w^{\left[i,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz}$$

The flux $q^{\left[i\right]}_{sz}$ ensures that
$s^{\left[i\right]}_{sz} \geq 0$ and
$l^{\left[i\right]}_{sz} \leq l^{\left[i\right]}_{szmax}$. Thus if
$s^{\left[i\right]}_{sz} = 0$ or
$l^{\left[i\right]}_{sz} = l^{\left[i\right]}_{szmax}$ then
$$a^{\left[i\right]}q^{\left[i\right]}_{sz} = 
    \min\left( a^{\left[i\right]}q^{\left[i\right]}_{uz} + \left(w^{\left[i,i\right]}_{sz}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{sz}
    + \sum\limits_{j \neq i} w^{\left[i,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz},0\right)$$
but is zero otherwise.

Combining the above equations for all Hillslope HRUs gives
$$\mathbf{A}\frac{d\mathbf{s}_{sz}}{dt} = -\mathbf{A}\mathbf{q}_{uz} - \left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{A}\mathbf{q}_{sz}$$ which simplifies to
$$\frac{d\mathbf{s}_{sz}}{dt} = -\mathbf{q}_{uz} - \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{q}_{sz}$$

Substituting the transmissivity relationship gives
$$-\mathbf{L}^{-1}_{sz}\mathbf{M}\frac{d\mathbf{l}_{sz}}{dt} = -\mathbf{q}_{uz} - \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{q}_{sz}$$

The solution of these limited joint set of ODEs are not trivial. The current
solution numerically solves the ODE problem
$$-\mathbf{L}^{-1}_{sz}\mathbf{M}\frac{d\mathbf{l}_{sz}}{dt} =
  -\mathbf{q}_{uz} -
  \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
  $$
  subject ot the contraints $\frac{dl_{sz}^{\left[i\right]}}{dt} \leq 0$ if
  $l_{sz}^{\left[i\right]}=l_{szmax}^{\left[i\right]}$ with initial conditions
  $\left.\mathbf{l}_{sz}\right\rvert_{t}$ to give
  $\left.\mathbf{l}_{sz}\right\rvert_{t+\Delta t}$. The flows from the
  saturated zone to the surface excess storage is estimated from these as
  $$
  \mathbf{q}_{sz} =
  \max\left(\mathbf{A}^{-1}\left(
  \mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\left.\mathbf{l}_{sz}\right\rvert_{t+\Delta
  t}+\mathbf{q}_{uz},
  \mathbf{0}\right)
  $$
where the maximum is taken element wise.

Then an initial estimate of the storage deficit is given by
$$ \tilde{\mathbf{s}}_{sz} = \left. \mathbf{s}_{sz}\right\rvert_{t} +
 \Delta t \left.\frac{d\mathbf{s}_{sz}}{dt}\right\rvert_{t+\Delta t} $$
 where the gradient term is evaluated as
 $$ \left.\frac{d\mathbf{s}_{sz}}{dt}\right\rvert_{t+\Delta t}=
 -\mathbf{q}_{uz} -
 \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\left.\mathbf{l}_{sz}\right\rvert_{t
   + \Delta t}
    + \left.\mathbf{q}_{sz}\right\rvert_{t
   + \Delta t}$$

The resulting saturated storage deficit is computed from this as
$$
  \left.\mathbf{s}_{sz}\right\rvert_{t + \Delta t} =
  \max\left( \tilde{\mathbf{s}}_{sz},
  \mathbf{0}\right)
  $$

The final estimate of the surface excess store can now be computed by adding
the volume of water coming from the saturated zone to give
$$
\left.\mathbf{s}_{ex}\right\rvert_{t+\Delta t} =
\tilde{\mathbf{s}}_{ex} + \Delta t \left.\mathbf{q}_{sz}\right\rvert_{t+\Delta
t} +
\left.\mathbf{s}_{sz}\right\rvert_{t + \Delta t} - \tilde{\mathbf{s}}_{sz}
$$

The flow from the saturated zone to the river channels is used to give
$$
\left.\mathbf{s}_{ch}\right\rvert_{t+\Delta t} =
\tilde{\mathbf{s}}_{ch} + \Delta t \mathbf{F}_{sz} \left.\mathbf{l}_{sz}\right\rvert_{t+\Delta
t}$$

## Step 5: Estimating Channel Flow
The average flow to the channel over the time step is given by 
$\frac{ \left.\mathbf{s}_{ch}\right\rvert_{t+\Delta t}}{\Delta t}$


# Ordinary Differential Equations Solutions

For completeness the solutions to the ODEs made use of above are
documented here.

## Single variable non-homogeneous ODE with constant input

The initial condition
problem$$\frac{dx\left(t\right)}{dt} = a - b x\left(t\right) \quad x\left(0\right) = x_0$$
or more compactly
$$x^{\prime}\left(t\right) = a - b x\left(t\right) \quad x\left(t_0\right) = x_0$$
involves the solution of first order linear system. This can be solved
explicitly using an ‘integrating factor’. Let
$\mu = \exp\left(\int\limits_t b dt\right) = \exp\left(bt\right)$.
Multiplying both sides by $\mu$ then integrating (noting the LHS is the
result of the product formula in differentiation) gives
$$\exp\left(bt\right) x = \int\limits_{t} a\exp\left(bt\right) dt = \frac{a}{b}\exp\left(bt\right) + K$$
The constant $K$ can be evaluates using the initial conditions as
$K=x_{0}-\frac{a}{b}$. Substitution and rearrangement then gives
$$x = x_{0}\exp\left(-bt\right) + \frac{a}{b}\left(1-\exp\left(-bt\right)\right)$$
Note that $$\begin{array}{c}
        x\rightarrow0 \quad\mathrm{as}\quad b\rightarrow\infty\\
        x\rightarrow x_{0} + at \quad\mathrm{as}\quad b\rightarrow0\\
    \end{array}$$

## Multiple variable non-homogeneous ODE with no input

The solution to the initial value problem
$$\frac{d\mathbf{x}\left(t\right)}{dt} = \mathbf{A} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$
or more compactly
$$\mathbf{x}^{\prime}\left(t\right) = \mathbf{A} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$
is computed using the eigen value method.

Suppose $\mathbf{x}$ is of length $n$ and $\mathbf{A}$ has suitably unique eigen values
$\mathbf{\lambda}$. Taking $\mathbf{M}$ to be the matrix of eigen vectors
$$
\mathbf{x}\left(t\right) = \mathbf{M} \left[\begin{array}{c}
c_1 \exp\left(\lambda_1t\right) \\
\vdots \\
c_n \exp\left(\lambda_nt\right)
\end{array}
\right]
$$
where the constant $\mathbf{c}$ can be estimated from the initial conditions
at time 0 as
$$ \mathbf{c} = \mathbf{M}^{-1} \mathbf{x}_{0} $$


<!-- By the method of “Variation of Parameters for Systems” the solution to -->
<!-- the initial value problem -->
<!-- $$\frac{d\mathbf{x}\left(t\right)}{dt} = \mathbf{a} - \mathbf{B} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$ -->
<!-- or more compactly -->
<!-- $$\mathbf{x}^{\prime}\left(t\right) = \mathbf{a} - \mathbf{B} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$ -->
<!-- is given by -->
<!-- $$\mathbf{x}\left(t\right) = e^{\mathbf{B}t}\mathbf{x}_0 + e^{\mathbf{B}t}\int_{t_0}^{t} e^{r\mathbf{B}} \mathbf{a} dr$$ -->
