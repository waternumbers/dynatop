---
title: "The Dynamic TOPMODEL Implimentation"
output: 
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_depth: 2
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{TheNumerical Solution of Dynamic TOPMODEL}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
#output: rmarkdown::html_vignette
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `dynatop` package represents an implimentation of the concepts behind a dynamic TOPMODEL.
One of the underlying principles of dynamic TOPMODEL is that the landscape can be broken up into
hydrologically similar regions, or Hydrological Similarity Units (HSUs), where
all the area within a HSU behaves in a hydrologically similar fashion.

While a Hydrological Similarity Unit (HSU) has typically been thought of as an
area of hillslope with, for example, simliar topgraphic, soil and upslope area
characteristics the idea may be generalised. In doing this a catchments is
concpetualised as a collection of HSUs of different type (e.g. hill slope,
channel, lake) which exchange fluxes at specified levels (e.g. saturated zone,
surface)

As well as the exchange of fluxes this documents considers two types of HSU. The first termed
"hill slope" solves the surface, root, unsaturated and saturated zones
for 'similar' areas of hill slope the catchment a each time step.
The second termed "channel" represents a length of river channel in a
simplified manner allowing the extraction of the inflow from the hillslope. 


# Notation and nomenclature

The notation used can be broken down as follows. Table \@ref(tab:exchange-notation) outlines the notation used for describing a fluxes exchanged between HSUs. These variables are common across all HSUs.
Table \@ref(tab:hs-notation) outlines the notation used for describing a hill
slope HSU and Table \@ref(tab:ch-notation) for the channel HSU. 
All other notation is given in Table \@ref(tab:other-notation).

The following conventions are used:

-   All fluxes ($q_{* \rightarrow *}$ and $l_{*}$) are considered to be greater or
equal to zero.

-   Superscript notation $^{\left[i\right]}$ indicates the property of
    the $i$th HSU

-   $\left.x\right\rvert_t$ indicates the value of the
    variable $x$ at time $t$
	
-	Where intermediate evaluations of some variables are compute these are distinguish by use of $\tilde{}$. For example
	 $\tilde{s}_{rz}$ is an intermediate value in the computation of
     $s_{rz}$.


  Quantity type                                   Symbol                   Description                                        unit
  ------------------------------------ -----------------------------       -------------------------------------------- -----------------
  Lateral fluxes from HSUs                       $l_{ex}$                  Total lateral flux from surface store         (m$^3$/s)/m$^2$
                                                 $l_{sz}$                  Total lateral flux from saturated zone store  (m$^3$/s)/m$^2$
  Other HSU properties                   $f^{\left[k,j\right]}_{ex}$       Fraction of $l_{ex}$ going from $j$th              -
                                                                           HSU to $k$th HSU
                                         $f^{\left[k,j\right]}_{sz}$       Fraction of $l_{sz}$ going from $j$th              -
                                                                           HSU to $k$th HSU
                                                    
  Table: (\#tab:exchange-notation) Outline of notation for describing the exchange between HSUs


  Quantity type                                   Symbol                   Description                                        unit
  ------------------------------------ -----------------------------       -------------------------------------------- -----------------
  Storage                                        $s_{ex}$                  Surface excess storage                               m
                                                 $s_{rz}$                  Root zone storage                                    m
                                                 $s_{uz}$                  Unsaturated zone storage                             m
                                                 $s_{sz}$                  Saturated zone storage deficit                       m
  Vertical fluxes within HSU               $q_{ex \rightarrow rz}$         Flow from the surface excess store to the     (m$^3$/s)/m$^2$
                                                                           root zone
                                           $q_{rz \rightarrow uz}$         Flow from the root zone to the unsaturated    (m$^3$/s)/m$^2$
                                                                           zone                        
                                           $q_{rz \rightarrow ex}$         Flow from the root zone to the surface        (m$^3$/s)/m$^2$ 
                                                                           excess storage                  
                                           $q_{uz \rightarrow sz}$         Flow from unsaturated to saturated zone       (m$^3$/s)/m$^2$                        
                                           $q_{sz \rightarrow ex}$         Flow from saturated zone to surface           (m$^3$/s)/m$^2$
                                                                           excess storage                    
  Other HSU properties                               a                     Area                                              m$^2$
                                                $q_{exmax}$                Maximum flow rate from surface excess to      (m$^3$/s)/m$^2$
                                                                           root zone
                                                $s_{rzmax}$                Maximum root zone storage                          m
                                                   $T_d$                   Unsaturated zone time constant per m of 
                                                                           saturated storage deficit.                        s/m
                                                 $l_{szmax}$               Maximum lateral flux from saturated zone      (m$^3$/s)/m$^2$         
                                                 $T_{ex}$                  Surface excess storage time constant               s
                                                    $m$                    Exponential transmissivity constant                -
                                                $\Delta x$                 Effective length of the hillslope HSU              m
                                                    
  Table: (\#tab:hs-notation) Outline of notation for describing hill slope
  HSU


                                   Symbol              Description                                                unit
  ---------------------- ----------------------------- ------------------------------------------------------ ----------------
  Storage                           $s_ch$
  Other HSU properties              $a_{ch}$               Area                                                    m$^2$
                                    
  Table: (\#tab:ch-notation) Outline of notation for describing "channel"
  HSUs


  Symbol                                      Description                                                                   unit
  ------------------------------------        ---------------------------------------------------------------------------- ------
  $\Delta t$                                  Timestep                                                                       s
  $\int_{\Delta t} p dt$                      Accumulated precipitation over a timestepm
  $\int_{\Delta t} e_p dt$                    Accumulated potential evapotranspiration over a time step                      m
  $\mathcal{S}^{\left[i\right]}_{ex}$          The set of values $j$ for which $f_{ex}^{\left[i,j\right]}>0$                 -
  $\mathcal{S}^{\left[i\right]}_{sz}$          The set of values $j$ for which $f_{sz}^{\left[i,j\right]}>0$                 -
  
  Table: (\#tab:other-notation) Eternal inputs to HSUs



# Exchange of fluxes between HSUs

Fluxes between the HSUs occur at two levels, the surface ($l_{ex}$) and the
saturated zone ($l_{sz}$). 
If all the lateral flux from an HSU is redirected to HSUs within the catchment then
\[
\sum\limits_{j} f^{\left[j,i\right]}_{ex} =
    \sum\limits_{k} f^{\left[k,i\right]}_{sz} =1
\]

The total incoming flux to the $i$th HSU over at
time at each level is
given by

\[
\sum_{j \in \mathcal{S}^{\left[i\right]}_{ex}} f_{ex}^{\left[i,j\right]}
\frac{a^{\left[j\right]}}{a^{\left[i\right]}}\int_{\Delta t}l^{\left[j\right]}_{ex}dt
\] 

and 

\[
\sum_{j} f_{sz}^{\left[i,j\right]}
\frac{a^{\left[j\right]}}{a^{\left[i\right]}}\int_{\Delta t}l^{\left[j\right]}_{sz}dt
\]

The solutions proposed for the individual HSUs are limited to the situation
that the HSUs can be ordered for each level so that they can be solved in a
sequence that results in all input fluxes from other HSUs being known.


# Hill Slope HSU

The numerical solution implemented in the dynamic TOPMODEL code is based
on solving the ODE(s) governing the evolution of each of the stores in the
HSUs sequentially while approximating the flux between them.

The following sections present the solutions to the governing equations
in the order they are currently solved in the code for given time
step $\Delta t$ (seconds) starting at time $t$ over which the input fluxes ($p$ and $e_p$) are
taken to be constant.

## Step 1: Surface excess redistribution

For the $i$th hill slope HSU the alteration of the surface excess store is
given by
\[
\frac{ds^{\left[i\right]}_{ex}}{dt} =  
    \sum\limits_{j \in \mathcal{S}_{ex}^{\left[i\right]}} f^{\left[i,j\right]}_{ex}\frac{a^{\left[j\right]}}{a^{\left[i\right]}}l^{\left[j\right]}_{ex}
    - l^{\left[i\right]}_{ex}
    + q^{\left[i\right]}_{sz \rightarrow ex}
	+ q^{\left[i\right]}_{rz \rightarrow ex}
    - q^{\left[i\right]}_{ex \rightarrow rz}
\]

The solution of this is approximated through two stages. 
The first stage computes the lateral flux $l^{\left[i\right]}_{ex}$ from the HSU based on the storage at
the start of the time step; ignoring the potential
vertical flux within the HSU. 
The second stage, carried out in Step 6 corrects for the vertical fluxes.

The computation of the lateral flux from the surface excess storage is based on two assumption

1.   There are minimal non-linearities so the surface excess store of a hill slope HSU can be treated as linear tanks with
$l^{\left[i\right]}_{ex} = \frac{1}{T^{\left[i\right]}_{ex}} s^{\left[i\right]}_{ex}$.
2.   The inflow is approximatley constant during the timestep.

Under these assumptions we write
\[
\frac{d\tilde{s}_{ex}}{dt} = \frac{1}{\Delta t} \sum\limits_{j \in \mathcal{S}_{ex}^{\left[i\right]}} f^{\left[i,j\right]}_{ex}\frac{a^{\left[j\right]}}{a^{\left[i\right]}} \int_{\Delta t}l^{\left[j\right]}_{ex}dt
- \frac{1}{T_{ex}^{\left[i\right]}} \tilde{s}
\quad \left. \tilde{s}_{ex} \right\rvert_{t} = \left. s_{ex} \right\rvert_{t}
\]

which can be solved to give
\[
\left. \tilde{s}_{ex} \right\rvert_{t+\Delta t} =
\left. s_{ex}^{\left[i\right]}\right\rvert_{t}
\exp\left(-\frac{\Delta t}{T_{ex}^{\left[i\right]}}\right)
+ \left(1 - \exp\left(-\frac{\Delta t}{T_{ex}^{\left[i\right]}}\right)\right)
\frac{T_{ex}^{\left[i\right]}}{\Delta t} \sum\limits_{j \in \mathcal{S}_{ex}^{\left[i\right]}} f^{\left[i,j\right]}_{ex}\frac{a^{\left[j\right]}}{a^{\left[i\right]}} \int_{\Delta t}l^{\left[j\right]}_{ex}dt
\]

Mass balance gives
\[
 \int_{\Delta t}l^{\left[i\right]}_{ex}dt 
 = \left. s_{ex}^{\left[i\right]}\right\rvert_{t}
 - \left. \tilde{s}_{ex}\right\rvert_{t+\Delta t}
+ \sum\limits_{j \in \mathcal{S}_{ex}^{\left[i\right]}} f^{\left[i,j\right]}_{ex}\frac{a^{\left[j\right]}}{a^{\left[i\right]}} \int_{\Delta t}l^{\left[j\right]}_{ex}dt
 \]
which can be evaluated since due to the ordering assumption
\[
\sum\limits_{j \in \mathcal{S}_{ex}^{\left[i\right]}} f^{\left[i,j\right]}_{ex}\frac{a^{\left[j\right]}}{a^{\left[i\right]}} \int_{\Delta t}l^{\left[j\right]}_{ex}dt
\]
is known.

## Step 2: Root Zone

For a single HSU
\[
\frac{ds_{rz}}{dt}=p + q_{ex \rightarrow rz}
-\frac{s_{rx}}{s_{rzmax}}e_{p}-q_{rz \rightarrow ex} - q_{rz \rightarrow uz}
\]
Assuming all the water in the surface excess store is available to the root
zone so long as $q_{ex \rightarrow rz} \leq q_{exmax}$ the integral of the
flow from the surface excess store can be approximated by
\[
\int\limits_{\Delta t} q_{ex \rightarrow rz} dt =
\min\left(q_{exmax}\Delta t,\left.\tilde{s}_{ex}\right.\rvert_{t+\Delta t}\right)
\]
Using this the root zone is solved as a two step process. Firstly the ODE
\[
\frac{d\tilde{s}_{rz}}{dt} = p
+ \frac{1}{\Delta t}\int\limits_{\Delta t} q_{ex \rightarrow rz} dt
- \frac{e_{p}}{s_{rzmax}}\tilde{s}_{rz} \quad
\left. \tilde{s}_{rz}\right\rvert_{t} = \left. s_{rz}\right\rvert_{t}
\]
is solved to give
\[
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} = 
\left. s_{rz}\right\rvert_{t} \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta
t\right)
+ \left(p
+ \frac{1}{\Delta t}\int\limits_{\Delta t} q_{ex \rightarrow rz} dt \right)
\frac{s_{srmax}}{e_p}
\left(1 - \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta t\right)\right)
\]
which is the root zone storage not allowing for losses to the surfce excess
store or unsaturated zone. From this
\[
\left. s_{rz}\right\rvert_{t + \Delta t} =
\min\left(\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t}, s_{rzmax}\right)
\]
and the total water passed from the root zone is
\[
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\]

The water passed from the root zone can be passed either to the surface excess
storage or the unsaturated zone. If $\left. s_{sz}\right\rvert_{t} = 0$ the
flux from the root zone is passed to the
surface excess store giving 
\[
\int_{\Delta t} q_{rz \rightarrow ex} dt =
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\quad
\int_{\Delta t} q_{rz \rightarrow uz} dt = 0
\]

If $\left. s_{sz}\right\rvert_{t} > 0$ then the flux from the root zone is
passed to the unsaturated zone store by taking
\[
\int_{\Delta t} q_{rz \rightarrow ex} dt = 0
\quad
\int_{\Delta t} q_{rz \rightarrow uz} dt =
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\] 

## Step 3: Unsaturated Zone

For a single HSU the unsaturated zone representation of a non-linear tank whose time
constant is dependent upon the saturation deficit:
\[
\frac{ds_{uz}}{dt}=q_{rz \rightarrow uz}-\frac{s_{uz}}{s_{sz}T_{d}}
\]

In keeping with the root zone the
solution to the governing ODE is approximated by
\[
\frac{d\tilde{s}_{uz}}{dt} =
\frac{1}{\Delta t}\int_{\Delta t} q_{rz \rightarrow uz} dt
- \frac{\tilde{s}_{uz}}{\left.s_{sz}\right\rvert_{t}T_{d}} \quad
\left.\tilde{s}_{uz}\right\rvert_{t} = \left.s_{uz}\right\rvert_{t}
\]

which is given by 
\[
\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t} =
\left.s_{uz}\right\rvert_{t}\exp\left(-\frac{\Delta
  t}{\left.s_{sz}\right\rvert_{t}T_d}\right)
+ \frac{1}{\left.s_{sz}\right\rvert_{t}T_{d}\Delta t}
\int_{\Delta t} q_{rz \rightarrow uz} dt
 \left(1 -
 \exp\left(-\frac{\Delta t}{\left. s_{sz}\right\rvert_{t}T_{d}}\right)\right)
\]
Mass balance then gives
\[
\int_{\Delta t} q_{uz \rightarrow sz} dt =  \left.s_{uz}\right\rvert_{t} + \int_{\Delta t}
q_{rz \rightarrow uz} dt - \left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}
\]

The above solution ensures that $\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}$
equals 0 if $\left.s_{sz}\right\rvert_{t}=0$. However to ensure that
$\left.s_{uz}\right\rvert_{t+\Delta t} =0$ if $\left.s_{sz}\right\rvert_{t+\Delta
  t}=0$ the estimate $\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}$ is revised
  after computation of the saturated zone in Step 5.
  
## Step 4: Saturated Zone

For the $i$ th hill slope HSU the change in saturated zone storage deficit is
evaluated using a kinematic wave approximation.
For an infinitesimal slab
\[
\frac{dA}{dt} + \frac{dQ}{dx} -r = 0
\]
where $A$, $Q$ and $r$ are the cross sectional flow area, lateral flow and
recharge for the infinitesimal slab.

Consider the HSU to be a rectangle of area $a$ with inflow and outflow
occuring at parallel edges seperated by a distance $\Delta x$ giving an
effective width if $w=\frac{a}{\Delta x}$. Taking a height
$h$ gives $A = hw$. Further noting that $h=h_0-z$ for some
datum $h_0$ and storage deficit $z$ (expressed as a length) gives
\[
\frac{dA}{dt} = w\frac{dh}{dt}=-w\frac{dz}{dt}
\]

The storage deficit $z$ and $Q$ are linked by a one-to-one montotonically
decreasing, continuously differentiable function 
$g: \mathcal{R}\rightarrow \mathcal{R}^{+}$ which returns the lateral flow on
a unit width such that $Q = w g\left(z\right)$.
This relationships can be used to express the change in deficit over time in
terms of lateral flow as follows:
\[
\frac{dz}{dt} =  \frac{dz}{dQ}\frac{dQ}{dt} =
=  \frac{1}{w}\left(\frac{d}{dz}g\left(z\right)\right)^{-1}\frac{dQ}{dt} =
-\frac{1}{w c\left(z\right)}\frac{dQ}{dt}
\]
where $c\left(z\right)=-\frac{d}{dz}g\left(z\right)$ is the kinematic velocity
expressed as a function of lateral flow per unit width.

Subsitution gives
\[
\frac{1}{c\left(z\right)}\frac{dQ}{dt} + \frac{dQ}{dx} -r = 0
\]
to which a numerical solution is sort.
Let $Q^{+}$ and $Q^{-}$ be the lateral flows at the foot and head of the slope
respectivly.

One possible four-point or box scheme for a constant recharge is given by
\[
\begin{split}
& \left(1-\omega\right)\frac{\left.Q^{-}\right\rvert_{t+1}-\left.Q^{-}\right\rvert_{t}}{\Delta t} +
\omega\frac{\left.Q^{+}\right\rvert_{t+1}-\left.Q^{+}\right\rvert_{t}}{\Delta t} +
\left(1-\theta\right)c\left(\left.z\right\rvert_{t}\right)
\left(\frac{\left.Q^{+}\right\rvert_{t}-\left.Q^{-}\right\rvert_{t}}{\Delta x} -r\right)
+ \\
& \theta c\left(\left.z\right\rvert_{t+1}\right)\left(\frac{\left.Q^{+}\right\rvert_{t+1}-\left.Q^{-}\right\rvert_{t+1}}{\Delta x} -r\right)
= 0
\end{split}
\]

It certain conditions\footnote{see Wood, WL "Introduction to Numerical Methods
for Water Resources" Section 4.2 Pg 76-77} it has been shown that this scheme
is unlikely to be numerical stable for all $\Delta t$ while the alternate
scheme replacing $c\left(z\right)$ with a 'typical' value $\bar{c}$ 
\[
\begin{split}
& \left(1-\omega\right)\frac{\left.Q^{-}\right\rvert_{t+\Delta t}-\left.Q^{-}\right\rvert_{t}}{\Delta t} +
\omega\frac{\left.Q^{+}\right\rvert_{t+\Delta t}-\left.Q^{+}\right\rvert_{t}}{\Delta t} +
\left(1-\theta\right)\bar{c}
\left(\frac{\left.Q^{+}\right\rvert_{t}-\left.Q^{-}\right\rvert_{t}}{\Delta x} - r\right)
+ \\
& \theta \bar{c}\left(\frac{\left.Q^{+}\right\rvert_{t+\Delta t}-\left.Q^{-}\right\rvert_{t+\Delta t}}{\Delta x} - r\right)
= 0
\end{split}
\]
is stable for $\omega \geq 0.5$, $\theta \geq 0.5$.

Consider the $i$ th HSU. The impact of saturation at $s^{\left[i\right]}_{sz}$=0 is to limits the
lateral flow to $l^{\left[i\right]}_{szmax}$ all points and times producing return flow to the
surface excess store. There is however no guarentee that the inflow to the
saturated zone store from other HSUs, given by
\[
\sum_{j\in\mathcal{S}^{\left[i\right]}_{sz}}f_{sz}^{\left[i,j\right]}\frac{a^{\left[j\right]}}{a^{\left[i\right]}}l^{\left[j\right]}_{sz}. 
\]
is less then $l_{szmax}^{\left[i\right]}$. In estimating
$l_{sz}^{\left[i\right]}$ the solution proposed allows lateral flow to
occur at values exceeding $l^{\left[i\right]}_{szmax}$ within the HSU, but
limits the fluxes transfered to and from the HSU.

Introducing $\tilde{l}^{\left[i\right]}_{sz}$ to be the unconstrained internal
flux such that 
$l_{sz}^{\left[i\right]} =
 \min\left(\tilde{l}^{\left[i\right]}_{sz},l^{\left[i\right]}_{szmax}\right)$,
 taking
 \[
Q^{-} = \min\left(
\sum_{j}f_{sz}^{\left[i,j\right]}\frac{a^{\left[j\right]}}{a^{\left[i\right]}}l^{\left[j\right]}_{sz},
l_{szmax}^{\left[i\right]}\right)
\]
and noting that a constant recharge for every cross section means that
$\int_{\Delta t} q_{uz\rightarrow sz} dt = r \Delta x \Delta t$ allows the
numeric scheme to be written as
\[
\begin{split}
\left( \omega + \theta\frac{\bar{c}^{\left[i\right]}\Delta t}{\Delta x} \right) &
\left.\tilde{l}^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t}
 + \left(1 - \omega - \theta\frac{\bar{c}^{\left[i\right]}\Delta t}{\Delta x}
 \right) \left. Q^- \right\rvert_{t+\Delta t} \\
& - \left( \omega + \left(1-\theta\right)\frac{\bar{c}^{\left[i\right]}\Delta t}{\Delta x} \right)
\left.\tilde{l}^{\left[i\right]}_{sz}\right\rvert_{t}
- \left(1 - \omega - \left(1 -
\theta\right)\frac{\bar{c}^{\left[i\right]}\Delta t}{\Delta x} \right) \left. Q^- \right\rvert_{t}
\\
& - \frac{\bar{c}^{\left[i\right]}}{\Delta x} \left. \int_{\Delta t}
q^{\left[i\right]}_{uz\rightarrow sz} dt \right\rvert_{t+\Delta t}
=0
\end{split}
\]
Assuming $\bar{c}^{\left[i\right]}$ is not dependent upon
$\left.\tilde{l}^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t}$ then this leads a simple solution for $\left.l^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t}$

### Determining the storage deficit

The above scheme determines the flows at the head and foot of the HSU at
descrete times. Linearly approximating between the time points gives
\[
\int_{\Delta t} l_{sz} dt = \frac{\Delta t}{2} \left(
\left.l_{sz}\right\rvert_{t+\Delta t} + \left.l_{sz}\right\rvert_{t}\right)
\]
From this
\[
\tilde{s}_{sz} =
\left.s^{\left[i\right]}_{sz}\right\rvert_{t} + \int_{\Delta t}
l^{\left[i\right]}_{sz} dt
- \sum_{j}f_{sz}^{\left[i,j\right]}\frac{a^{\left[j\right]}}{a^{\left[i\right]}}\int_{\Delta t}
l^{\left[j\right]}_{sz} dt
- \int_{\Delta t} q^{\left[i\right]}_{uz\rightarrow sz} dt
\]
from which can be computed 
\[
\left.s^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t} =
\max\left(0,\tilde{s}_{sz}\right)
\] and
\[
\left.\int_{\Delta t} q^{\left[i\right]}_{sz\rightarrow ex} dt \right\rvert_{t+\Delta t} =
\left.s^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t} - \tilde{s}_{sz}
\]

### Estimating $\bar{c}$

The above solution relies on the estimate of an "average"
value $\bar{c}$. A relatively simple approach to
constructing $\bar{c}$ is to take
\[
\bar{c} = c\left(\bar{z}\right)
\]
where $\bar{z}$ is a estimate of average (in space and time) of the storage
deficit. This is approximated by $\left.s_{sz}\right\rvert_{t}$.

## Step 5: Correcting vertical stores

Having evaluated the stores in the direction of gravity there is the need to
correct for vertical fluxes returning water to the surface thus increase
$s_{ex}$.

If saturation has occured, that is 
$\left. s_{sz}\right. \rvert_{t+\Delta t}=0$, 
then there can be no water stored in the unsaturated zone. Let
\[
\int_{\Delta t} q_{uz \rightarrow ex}dt = \left\{ \begin{array}{cc}
  \left.\tilde{s}_{uz}\right. \rvert_{t+\Delta t} &
  \left. s_{sz}\right. \rvert_{t+\Delta t}=0\\
  0 & \mathrm{otherwise}
\end{array}
\right.
\]

The correction of the stores then takes the form
\[
\left. s_{ex} \right. \rvert_{t+\Delta t} =
\left.\tilde{s}_{ex}\right. \rvert_{t+\Delta t}  + \int_{\Delta t} q_{rz
  \rightarrow ex} dt + \int_{\Delta t} q_{sz \rightarrow ex} dt + \int_{\Delta t} q_{uz \rightarrow ex} dt
\]
and 
\[
\left. s_{uz} \right. \rvert_{t+\Delta t} =
\left.\tilde{s}_{uz}\right. \rvert_{t+\Delta t} - \int_{\Delta t} q_{uz
  \rightarrow ex} dt
\]


# Channel HSU

The average inflow to a channel HSU over the time step in cumecs is given by
total flux to the channel HSU in cubic meters divided by the time step $\Delta t$. The total flux to the channel is given by
\[
a_{ch}^{\left[k\right]} \int_{\Delta t} v^{\left[k\right]} = 
    \sum\limits_{j} f^{\left[k,j\right]}_{ex}a^{\left[j\right]}\int_{\Delta t}l^{\left[j\right]}_{ex}dt
    + \sum\limits_{j} f^{\left[k,j\right]}_{sz}a^{\left[j\right]}\int_{\Delta t}l^{\left[j\right]}_{sz} dt
    + p\Delta t
\]
where the integrals of the lateral fuxes are evaluated in the earlier steps.

## Total Flux to channel HSUs

It is presumed that, from the perspective of the hillslope the channel acts as
a sink. That is there is no feedback from the channel to the hillslope. 
For a single reach:
\[
v^{\left[k\right]} = 
    \sum\limits_{j} f^{\left[k,j\right]}_{ex}\frac{a^{\left[j\right]}}{a^{\left[k\right]}}l^{\left[j\right]}_{ex}
    + \sum\limits_{j} f^{\left[k,j\right]}_{sz}\frac{a^{\left[j\right]}}{a^{\left[k\right]}}l^{\left[j\right]}_{sz}
    + p
\]

# Appendix: Ordinary Differential Equations Solutions

For completeness the solutions to the ODEs made use of above are
documented here.

## Single variable non-homogeneous ODE with constant input

The initial condition
problem$$\frac{dx\left(t\right)}{dt} = a - b x\left(t\right) \quad x\left(0\right) = x_0$$
or more compactly
$$x^{\prime}\left(t\right) = a - b x\left(t\right) \quad x\left(t_0\right) = x_0$$
involves the solution of first order linear system. This can be solved
explicitly using an ‘integrating factor’. Let
$\mu = \exp\left(\int\limits_t b dt\right) = \exp\left(bt\right)$.
Multiplying both sides by $\mu$ then integrating (noting the LHS is the
result of the product formula in differentiation) gives
$$\exp\left(bt\right) x = \int\limits_{t} a\exp\left(bt\right) dt = \frac{a}{b}\exp\left(bt\right) + K$$
The constant $K$ can be evaluates using the initial conditions as
$K=x_{0}-\frac{a}{b}$. Substitution and rearrangement then gives
$$x = x_{0}\exp\left(-bt\right) + \frac{a}{b}\left(1-\exp\left(-bt\right)\right)$$
Note that $$\begin{array}{c}
        x\rightarrow0 \quad\mathrm{as}\quad b\rightarrow\infty\\
        x\rightarrow x_{0} + at \quad\mathrm{as}\quad b\rightarrow0\\
    \end{array}$$

