---
title: "A Derivation for the Hillslope HSU - from slab to hillslope"
output: 
  bookdown::pdf_document2:
    number_sections: false
    toc: true
    toc_depth: 2
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{A Derivation for the Hillslope HSU - from slab to hillslope}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
#output: rmarkdown::html_vignette
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Conceptual model

One of the underlying principles of dynamic TOPMODEL is that the landscape can
be broken up into hydrologically similar regions, or Hydrological Similarity
Units (HSUs), where all the area within a HSU behaves in a hydrologically
similar fashion. Further discussion and the conection of HSUs is discussed
further in [ref].

This document outlines the conceptual structure and computational
implimentation of the hillslope HSU. The hillslope HSU is a representation of 
an area of hillslope with, for example, simliar topgraphic, soil and upslope area
characteristics.

The hillslope HSU is considered to be a hillslope with inflow and outflow
occuring at parallel edges seperated by a distance $\Delta x$.
It is formed of four zones representing the surface water, which
passes water between HSUs and drains to the root zone. The root zone characterises
the interactions evapotranspiration and precipitation and when full spills to
the unsaturated zone. This drains to the saturated zone which also interacts
with other HSUs. The behaviour of the saturated zone is modelled using a kinematic wave
approximation.

In the follwoing section the governing equations of the hillslope HSU are
given for an infinitesimal vertical slab. Integration with
respect to the (plan) distance down the hillslope $x$ is then considered. A numerical scheme is then presented.

	
# Notation

Table \@ref(tab:hs-x-notation) outlines the notation used for describing an
infinitesimal slab across the hill
slope HSU. Table \@ref(tab:hs-notation) extending this notation to properties
of the aggregated hillslope. They are related by
\begin{equation}
\int_{\Delta x} r_{* \rightarrow *} dx = q_{* \rightarrow *}
\end{equation}
and
\begin{equation}
\int_{\Delta x} A_{* \rightarrow *} dx = v_{* \rightarrow *}
(\#eq:align)
\end{equation}

The following conventions are used:

-   All properties such as slope angles and time constants are considered
    uniform along the hillslope.
	
-   Precipitation and Potential Evapotranspiration occur at spatially uniform
    rates.
	
-   All fluxes $r_{* \rightarrow *}$ are considered to be positive when
	travelling in the direction of the arrow, but can in cases be negative.

-   All fluxes $l_{*}$ are considered to be positive flows travelling downslope.

-   The superscripts $^-$ and $^+$ are used to denote variables at the top and
    bottom cross sections of the hillslope respectively.

-   $\left.x\right\rvert_t$ indicates the value of the
    variable $x$ at time $t$
	
| Quantity type              | Symbol                  | Description                                                        | unit            |
| ---                        | :---:                   | ------                                                             | :---:           |
| Storage                    | $A_{sf}$                | Surface excess storage                                             | m$^2$     |
|                            | $A_{rz}$                | Root zone storage                                                  | m$^2$     |
|                            | $A_{uz}$                | Unsaturated zone storage                                           | m$^2$     |
|                            | $A_{sz}$                | Saturated zone storage deficit                                     | m$^2$     |
| Vertical fluxes within HSU | $r_{sf \rightarrow rz}$ | Flow from the surface excess store to the root zone                | m$^2$/s |
|                            | $r_{rz \rightarrow uz}$ | Flow from the root zone to the unsaturated zone                    | m$^2$/s |
|                            | $r_{uz \rightarrow sz}$ | Flow from unsaturated to saturated zone                            | m$^2$/s |
| Vertical fluxes to the HSU | $p$ | Precipitation rate | m/s |
|                            | $e_p$ | Potential Evapotransipartion rate | m/s |
| Other HSU properties       | $k_{sf}$             | Maximum flow rate from surface excess to root zone per unit width                 | m/s |
|                            | $s_{rzmax}$             | Maximum root zone storage depth                                         | m               |
|                            | $T_d$                   | Unsaturated zone time constant per m of saturated storage deficit. | s/m             |
|                            | $l_{szmax}$             | Maximum lateral flux from saturated zone                           | m$^3$/s |
|                            | $T_{sf}$                | Surface excess storage time constant per m of hillslope length                               | s/m               |
|                            | $m$                     | Exponential transmissivity constant                                | -               |
|                            | $\Delta x$              | Length of the hillslope HSU                              | m               |
|                            | $w$                     | Width of hillslope cross-section    | m |
|                            | $a$                     | Hillslope area    | m$^3$ |
|                            | $\beta$                        | Angle of hill slope                                                                    |   rad              |
                                                    
  Table: (\#tab:hs-x-notation) Outline of notation for describing a cross
  section of the hillslope HSU


| Quantity type              | Symbol                  | Description                                                        | unit            |
| ---                        | :---:                   | ------                                                             | :---:           |
| Storage                    | $v_{sf}$                | Surface excess storage                                             | m$^3$     |
|                            | $v_{rz}$                | Root zone storage                                                  | m$^3$     |
|                            | $v_{uz}$                | Unsaturated zone storage                                           | m$^3$     |
|                            | $v_{sz}$                | Saturated zone storage deficit                                     | m$^3$     |
| Vertical fluxes within HSU | $q_{sf \rightarrow rz}$ | Flow from the surface excess store to the root zone                | m$^3$/s |
|                            | $q_{rz \rightarrow uz}$ | Flow from the root zone to the unsaturated zone                    | m$^3$/s |
|                            | $q_{uz \rightarrow sz}$ | Flow from unsaturated to saturated zone                            | m$^3$/s |
                                                    
  Table: (\#tab:hs-notation) Outline of notation for describing aggregated
  properties of the hillslope HSU

# Equations for an Infinitesimal Slab

Consider a infinitesimal vertical slab across the hillslope. We use a vertical
slab in the belief that the vertical fluxes are gravity driven. However
lateral fluxes occur do not occur in the horozontal plane, meaning our solution
should, were appropraite allow for this. This is particularly relevent for the
Kinematic solution used for the saturated zone.

## Surface zone

The storage in the surface zone satisfies $A_{sf} \geq 0$.
Surface storage is increased by lateral downslope flow from upslope HSUs. 
Water flows to the root zone at a constant rate $k_{sf}$, unless limited by
the available storage at the surface or the ability of the root zone to
receive water (for example if the saturation storage deficit is 0 and the root zone storage is full).

In cases where lateral flows in the saturated zone produce
saturation storage deficits water may be returned from the root
zone to the surface giving negative values of $r_{sf \rightarrow rz}$.

The governing ODE can be written as
\begin{equation}
\frac{dA_{sf}}{dt} = - \frac{dl_{sf}}{dx} - r_{sf \rightarrow rz}
\end{equation}
where $r_{sf \rightarrow rz} \leq w k_{sf}$.

Assuming lateral flux is proportional to storage and taking $l_{sf} = \frac{A_{sf}}{T_{sf}}$ gives
\begin{equation}
\frac{dA_{sf}}{dt} = -\frac{1}{T_{sf}}\frac{dA_{sf}}{dx} - r_{sf \rightarrow rz}
\end{equation}

## Root zone

The root zone gains water from precipitation and the surface zone. It looses water through
evaporation and to the unsaturated zone. The root zone storage satifies

\begin{equation} 0 \leq A_{rz} \leq A_{rzmax} \end{equation}

with the governing ODE
\begin{equation}
\frac{dA_{rz}}{dt} = w p - \frac{w e_p}{w s_{rzmax}} A_{rz} +
r_{sf\rightarrow rz} - r_{rz \rightarrow uz}
\end{equation}

Fluxes from the surface and to the unsaturated zone are
controlled by the level of root zone storage along with the state of the unsaturated
and saturated zones.

For $A_{rz} \leq A_{rzmax}$ then $r_{rz \rightarrow uz} \leq 0$. Negative
values of $r_{rz \rightarrow uz}$ may occur only when water is returned from the
unsaturated zone due to saturation caused by lateral inflow to the saturated zone.

When $A_{rz} = A_{rzmax}$ then 
\begin{equation}
w p - w e_p + r_{sf\rightarrow rz} - r_{rz \rightarrow uz} \leq 0
\end{equation}
In this case $r_{rz \rightarrow uz}$ may be positive if
\begin{equation}
w p - w e_p + r_{sf\rightarrow rz} > 0
\end{equation}
so long as the unsaturated zone can receive the water. If $r_{rz
\rightarrow uz}$ is 'throttled' by the rate at which the unsaturated zone can
receive water then $r_{sf\rightarrow rz}$ is adjusted (potentially becoming
negative) to ensure the equality is met.

## Unsaturated zone

The unsaturated zone acts as a non-linear tank subject to the constraint 
\begin{equation} 0 \leq A_{uz} \leq A_{sz} \end{equation}

The governing ODE is written as
\begin{equation}
\frac{dA_{uz}}{dt} = r_{rz \rightarrow uz} - r_{uz \rightarrow sz}
\end{equation}

If water is able to path freely to the saturated zone then it flows at the rate
$\frac{w A_{uz}}{T_d A_{sz}}$. If $A_{sz}=A_{uz}$ this is interpreted to mean
that the flow rate is $\frac{w}{T_d}$. In this situation the subsurface below
the root zone can be considered saturated, as in there is no further available
storage for water, but seperated into parts: an upper part with vertical
flow and a lower part with lateral flux.

It is possible that $r_{uz \rightarrow sz}$ is
constrained by the ability of the saturated zone to receive water. If
this is the case $r_{uz \rightarrow sz}$ occurs at the maximum
possible rate and $r_{rz \rightarrow uz}$ limited to ensure that $A_{uz} \leq A_{sz}$.

## Saturated zone

The change in saturated zone storage deficit is
evaluated using a kinematic wave approximation. 

The continuity equation gives gives the conservation of mass in terms of the
cross sectional saturated zone flow area $A$ and recharge $r_{uz \rightarrow
  sz}$ as
\begin{equation}
\frac{dA}{dt} + \frac{dl_{sz}}{dx} -r_{uz \rightarrow sz} = 0
\end{equation}

The cross sectional flow area $A$ can be expressed in terms
of $A_{sat}$ the cross sectional flow area when the whole cross section has
lateral flux ($A_{sz}=0$) and $A_{sz}$ since $A = A_{sat}-A_{sz}$ giving
\begin{equation}
\frac{dA_{sz}}{dt} = \frac{dl_{sz}}{dx} - r_{uz \rightarrow sz}
\end{equation}

The Kinematic approximation then depends upon the specification of a
transmissivity profile linking $A_{sz}$ and $l_{sz}$. This is taken to be a one-to-one montotonically
decreasing, continuously differentiable function 
$g: \mathcal{R^{+}}\rightarrow \mathcal{R}^{+}$ which returns the lateral flow on
a unit width such that $l_{sz} = w g\left(\frac{A_{sz}}{w}\right)$. 
The this implies a maximum lateral flux $l_{szmax}=w g\left(0\right)$.

While the above equation is mass conservative it is not momentum
conservative. Specifically $r_{uz \rightarrow sz}$ is not perpendicular
to the direction of $l_{sz}$ (which is parrallel to the surface slope). A
control volume based assessment of the momentum change gives the condition
\begin{equation}
\frac{d}{dx}\left(l_{sz}u_{sz}\right) = \frac{r^2}{w}\sin\beta
\end{equation}
but use of this is not considered further.

# Solutions for the HSU hillslope

Given no analytical solution yet exists allowing for the evaluation of the
properties at every $x$ within the hillslope a numerical approximation is required.

## Hillslope Foot Solution

A solution to the ODEs above which is adequate for transfering water within
the catchment is based on the evaluating the infinitesimal slab at the foot of
the hillslope using approximations to the gradients along the hillslope. This gives
\begin{equation}
\frac{dA_{sf}^{+}}{dt} = \frac{1}{\Delta x}\left(l_{sf}^{-} - \frac{A_{sf}^{+}}{T_{sf}}\right) - r_{sf \rightarrow rz}^{+}
\end{equation}
and

\begin{equation}
\frac{dA_{sz}^{+}}{dt} = \frac{1}{\Delta x}\left(w^{+}
g\left(\frac{A_{sz}^{+}}{w^{+}}\right) - l_{sz}^{-}\right) - r_{uz \rightarrow sz}^{+}
\end{equation}

along with the equations for the root and unsaturated zone as given
earlier. Rewriting the equations for the evolution of $A^{+}_{sf}$ and $A^{+}_{sz}$ in terms of
$l_{sf}$, $l_{sz}$ and kinematic velocities gives
\begin{equation}
\frac{dl_{sf}^{+}}{dt} = \frac{1}{T_{sf}\Delta x}\left(l_{sf}^{-} - l_{sf}^{+}\right) - \frac{1}{T_{sf}}r_{sf \rightarrow rz}^{+}
\end{equation}
and
\begin{equation}
\frac{dl_{sz}^{+}}{dt} = \frac{c\left(l_{sz}^{+}\right)}{\Delta x}\left( l_{sz}^{-} - l_{sz}^{+}\right) + c\left(l_{sz}^{+}\right)r_{uz \rightarrow sz}^{+}
\end{equation}
where
\begin{equation}
c\left(l_{sz}^{+}\right) = - w^{+} \frac{d}{dA_{sz}^{+}} g\left(\frac{A_{sz}^{+}}{w^{+}}\right)
\end{equation}

Standardisation to unit width gives the
equation for the evolution of the saturated zone in the original Dynamic
TOPMODEL paper.

## Instantaneous Redistribution Solution

The Hillslope Foot Approximation avoids the evaluation of the storages acorss
the hillslope. An alterative approach is to integrate along the length of the
hillslope. 
For the surface and saturated zone this gives
\begin{equation}
\frac{dv_{sf}}{dt} = l_{sf}^{+} - l_{sf}^{-} - \int_{\Delta x}r_{sf
\rightarrow rz} dx
\end{equation}
and 
\begin{equation}
\frac{dv_{sz}}{dt} = l_{sz}^{+} - l_{sz}^{-} - \int_{\Delta x}r_{uz
\rightarrow sz} dx
\end{equation}
Which are complimented by
\begin{equation}
\frac{dv_{rz}}{dt} = ap - ae_{p} \frac{v_{rz}}{a s_{rzmax}} +
\int_{\Delta x} r_{sf\rightarrow rz} dx - \int_{\Delta x}r_{rz \rightarrow uz} dx
\end{equation}
for the root zone and 
\begin{equation}
\frac{dv_{uz}}{dt} = \int_{\Delta x}r_{rz \rightarrow uz}dx - \int_{\Delta x}r_{uz \rightarrow sz}dx
\end{equation}
for the unsaturated zone.

The vertical flux's $r$ vary with $x$, being either negative or
positive, and cannot without further assumptions be directly related to the
storage volumes $v_{*}$. One possible assumption is that of instantaneous
redistribtuion of the stores such that $A_{*} = \frac{w v_{*}}{a}$. The
lateral fluxes at the foot of the hillslope are thus given by
\begin{equation}
l_{sf}^{+} = \frac{w^{+} v_{sf}}{T_{d} a}
\end{equation}
and
\begin{equation}
l_{sz}^{+} = w^{+} g\left(\frac{v_{sz}}{a}\right)
\end{equation}
Moreover the instantaneous redistribution gives indentical vertical fluxes
everywhere on the hillslope. This allows the
solutions for the free drainage of the unsaturated zone to be written as
\begin{equation}
\int_{\Delta x} \frac{w A_{uz}}{T_d A_{sz}} dx =
\int_{\Delta x} \frac{w v_{uz}}{T_d v_{sz}} dx = \frac{a v_{uz}}{T_d v_{sz}}
\end{equation}

## Hillslope shape

Note that the two solution above will respond differently to the hillslope
shapes as summarised by $a$, $w^{+}$ and $\Delta x$. This is a note that it
requires further exploration.

# Numerical Schemes

In the following section an implicit numerical scheme is derived for
the instantaneous redistribution solution applied with a time step
$\Delta t$. 
The basis that a of the solution is that a gravity driven system will maximise
the downward flow of water within each timestep.

Note that

1.  The scheme for the Hillslope Foot solution is in essance identical to
	that of the Instantaneous redistribution and could be implimented
	in terms of the original four point solution.

2.  The following is deliberatly verbose. Efficent implimentation is best done
	using standardised variable e.g. $v_{*}/a$, $q_{*}/a$ and $l_{*}/a$.

## Hillslope Foot

The implicit approximations to the four ODE defining the model using
the unknown vertical fluxes $q_{* \rightarrow *}$ are
\begin{equation}
\left. l_{sf}^{+} \right\rvert_{t+\Delta t} = 
\left( 1+ \frac{\Delta t}{T_{sf} \Delta x}\right)^{-1}
\left(
\left. l_{sf}^{+} \right\rvert_{t} + 
\frac{\Delta t}{T_{sf}} \left( 
\frac{ \left. l_{sf}^{-} \right\rvert_{t+\Delta t}}{\Delta x} - 
\left. r^{+}_{sf \rightarrow rz} \right\rvert_{t+\Delta t} \right)
\right)
\end{equation}

\begin{equation}
\left. A_{rz}^{+} \right\rvert_{t+\Delta t} = 
\left(1 + \frac{w^{+} e_p\Delta t}{w^{+} s_{rzmax}}\right)^{-1} \left(
\left. A_{rz}^{+} \right\rvert_{t} + w^{+}p\Delta t +
\Delta t \left. r^{+}_{sf \rightarrow rz} \right\rvert_{t+\Delta t} - 
\Delta t \left. r^{+}_{rz \rightarrow uz}\right\rvert_{t+\Delta t}\right)
\end{equation}

\begin{equation}
\left. A^{+}_{uz} \right\rvert_{t+\Delta t} = 
\left. A^{+}_{uz} \right\rvert_{t+\Delta t} +
\Delta t \left(
\left.r^{+}_{rz \rightarrow uz}\right\rvert_{t+\Delta t} -
\left.r^{+}_{uz \rightarrow sz}\right\rvert_{t+\Delta t}
\right)
\end{equation}

\begin{equation}
\left. l^{+}_{sz} \right\rvert_{t+\Delta t} =
\left(1 + \frac{ c\left(\left. l^{+}_{sz} \right\rvert_{t+\Delta t}\right)
\Delta t}{\Delta x} \right)^{-1} \left(
\left. l^{+}_{sz} \right\rvert_{t} +
c\left(\left. l^{+}_{sz} \right\rvert_{t+\Delta t}\right) \Delta t \left(
\frac{1}{\Delta x}\left. l_{sz}^{-} \right\rvert_{t+\Delta t} +
\left.r_{uz \rightarrow sz}\right\rvert_{t+\Delta t}
\right)\right)
(\#eq:lsz)
\end{equation}


Now consider the evaluation of the unknown vertical fluxes. To
maintain $\left. l^{+}_{sf} \right\rvert_{t+\Delta t} \geq 0$ requires that
\begin{equation}
\left. r^{+}_{sf \rightarrow uz} \right\rvert_{t+\Delta t} \leq 
r_{sf \rightarrow uz}^{pos} = \min\left( w^{+} k_{sf}, 
\frac{T_{sf}}{\Delta t}\left. l_{sf} \right\rvert_{t} + 
\frac{1}{\Delta x}\left. l_{sf}^{-} \right\rvert_{t+\Delta t} \right)
\end{equation}

The upper limit of $a_{rz}$ and maximum flux from the surface store
result in
\begin{equation}
 \left. r^{+}_{rz \rightarrow uz}\right\rvert_{t+\Delta t} \leq
 r_{rz \rightarrow uz}^{pos} =  \frac{1}{\Delta t} \max\left( 0,
\left. A^{+}_{rz} \right\rvert_{t} + w^{+}p\Delta t +
\Delta t r_{sf \rightarrow rz}^{pos} - w^{+} e_p\Delta t - w^{+}s_{rzmax}\right)
\end{equation}

From the unsaturated zone the implict solution when drainage to the saturated
zone occurs at rate $\frac{wA^{+}_{uz}}{T_d A^{+}_{sz}}$ gives
\begin{equation}
\left. A^{+}_{uz} \right\rvert_{t+\Delta t} = 
\frac{T_d \left. A^{+}_{sz} \right\rvert_{t+\Delta t}}
{T_d \left. A^{+}_{sz} \right\rvert_{t+\Delta t} + w^{+}\Delta t}
\left(
\left. A^{+}_{uz} \right\rvert_{t} + \Delta t \left.r_{rz \rightarrow
uz}\right\rvert_{t+\Delta t}\right)
\end{equation}

This places an upper limit on $r^{+}_{uz \rightarrow sz}$ in terms of
$\left. A^{+}_{sz} \right\rvert_{t+\Delta t}$ as
\begin{equation}
\left. r^{+}_{uz \rightarrow sz}\right\rvert_{t+\Delta t}
\leq \min\left(
\frac{w^{+}\left( \left. A^{+}_{uz} \right\rvert_{t} + \Delta t r_{rz \rightarrow uz}^{pos}\right)}
{T_d \left. A^{+}_{sz} \right\rvert_{t+\Delta t} + w^{+} \Delta t}, \frac{w^{+}}{T_d}\right)
\end{equation}

The maximum possible flux to the saturated zone then occurs when
$\left. A^{+}_{sz} \right\rvert_{t+\Delta t}=0$ as
\begin{equation}
r_{uz \rightarrow sz}^{pos}
= \min\left(
\frac{\left. A^{+}_{uz} \right\rvert_{t} + \Delta t r_{rz \rightarrow uz}^{pos}}
{\Delta t}, \frac{w^{+}}{T_d}\right)
\end{equation}

Rearranging the evolution of the saturated storage defict with 
$\lambda = c\left(\left. l^{+}_{sz} \right\rvert_{t+\Delta t}\right) \Delta t$ 
gives
\begin{equation}
\left.r_{uz \rightarrow sz}\right\rvert_{t+\Delta t} = 
\frac{1}{\lambda}\left(1 + \frac{\lambda}{\Delta x}\right)
\left. l^{+}_{sz} \right\rvert_{t+\Delta t} -
\frac{1}{\lambda}\left. l^{+}_{sz} \right\rvert_{t}
- \frac{1}{\Delta x}\left. l^{-}_{sz} \right\rvert_{t+\Delta t}
\end{equation}

Let us assume this is maximised when 
$\left. l^{+}_{sz} \right\rvert_{t+\Delta t} = l_{szmax}$ 
which makes intuitive sense and is true for the exponential transmisivity
proile. Let
$\lambda_{max} = c\left(l_{szmax}\right) \Delta t$ then the to ensure that 
$\left. l^{+}_{sz} \right\rvert_{t+\Delta t} \leq l_{szmax}$ 
\begin{equation}
\left.r_{uz \rightarrow sz}\right\rvert_{t+\Delta t} \leq r_{uz \rightarrow sz}^{0} = 
\frac{1}{\lambda_{max}}\left(1 + \frac{\lambda_{max}}{\Delta x}\right)
l_{szmax} -
\frac{1}{\lambda_{max}}\left. l^{+}_{sz} \right\rvert_{t}
- \frac{1}{\Delta x}\left. l^{-}_{sz} \right\rvert_{t+\Delta t}
\end{equation}

On the principle of maximising the downward flux two cases can be
distiguished:

1.  Case 1: $r_{uz \rightarrow sz}^{pos} \geq r_{uz \rightarrow sz}^{0}$. In
    this case $\left. l^{+}_{sz} \right\rvert_{t+\Delta t} = l_{szmax}$ and 
	$\left.r_{uz \rightarrow sz}\right\rvert_{t+\Delta t} = r_{uz \rightarrow
    sz}^{0}$
	
2.  Case 2: $r_{uz \rightarrow sz}^{pos} < r_{uz \rightarrow sz}^{0}$
	In this case $\left.l_{sz}\right\rvert_{t+\Delta t} \leq l_{szmax}$ and
	satisfies
	\@ref(eq:lsz) where
\begin{equation}
\left.r_{uz \rightarrow sz}\right\rvert_{t+\Delta t} = 
\min \left(
\frac{w\left( \left. A_{uz} \right\rvert_{t} + \Delta t r_{rz \rightarrow uz}^{pos}\right)}
{T_d \left. A_{sz} \right\rvert_{t+\Delta t} + w\Delta t},
\frac{w}{T_d} \right)
\end{equation}

At least in the case of an exponential transmissivity profile Case 2 can be
robustly solved using numerical methods. 

Given the solution to one of the two cases 
\begin{equation}
\left. A_{uz} \right\rvert_{t + \Delta t} =
\left. r_{uz \rightarrow sz} \right\rvert_{t + \Delta t}
\frac{T_d}{w}
\left. A_{sz} \right\rvert_{t +\Delta t}
\end{equation}
and
\begin{equation}
\left. r_{rz \rightarrow uz} \right\rvert_{t + \Delta t} =
\frac{1}{\Delta t}\left(
\left. A_{uz} \right\rvert_{t + \Delta t} - \left. A_{uz} \right\rvert_{t}
\right) +
\left. r_{uz \rightarrow sz} \right\rvert_{t + \Delta t}
\end{equation}

The remaining vertical flows can then be solved for since
\begin{equation}
\left.r_{sf \rightarrow rz} \right\rvert_{t+\Delta t} = \min\left(
r_{sf \rightarrow rz}^{pos},
\frac{1}{\Delta t}\left(ws_{rzmax} - \left. A_{rz} \right\rvert_{t}\right) +
w\left(e_p - p\right) + \left. r_{rz \rightarrow uz} \right\rvert_{t + \Delta
  t} \right)
\end{equation}

Subsitution of these fluxes into the initial implicit solutions for the
surface and root zone gives the states at $t+\Delta t$.

## Instantaneous Redistribution

The implicit approximations to the four ODE defining the model using
the unknown vertical fluxes $q_{* \rightarrow *}$ are
\begin{equation}
\left. v_{sf} \right\rvert_{t+\Delta t} = 
\left( 1+ \frac{w^{+} \Delta t}{T_{sf}a}\right)^{-1}
\left(
\left. v_{sf} \right\rvert_{t} + 
\Delta t \left( 
\left. l_{sf}^{-} \right\rvert_{t+\Delta t} - 
\left. q_{sf \rightarrow rz} \right\rvert_{t+\Delta t} \right)
\right)
\end{equation}

\begin{equation}
\left. v_{rz} \right\rvert_{t+\Delta t} = 
\left(1 + \frac{a e_p\Delta t}{a s_{rzmax}}\right)^{-1} \left(
\left. v_{rz} \right\rvert_{t} + ap\Delta t +
\Delta t \left. q_{sf \rightarrow rz} \right\rvert_{t+\Delta t} - 
\Delta t \left. q_{rz \rightarrow uz}\right\rvert_{t+\Delta t}\right)
\end{equation}

\begin{equation}
\left. v_{uz} \right\rvert_{t+\Delta t} = \left. v_{uz}
\right\rvert_{t+\Delta t} +
\Delta t \left(
\left.q_{rz \rightarrow uz}\right\rvert_{t+\Delta t} -
\left.q_{uz \rightarrow sz}\right\rvert_{t+\Delta t}
\right)
\end{equation}

\begin{equation}
\left. v_{sz} \right\rvert_{t+\Delta t} =
\left. v_{sz} \right\rvert_{t} +
\Delta t \left(
w^{+} g\left(\frac{\left. v_{sz} \right\rvert_{t+\Delta t}}{a}\right) -
\left. l_{sz}^{-} \right\rvert_{t+\Delta t} -
\left.q_{uz \rightarrow sz}\right\rvert_{t+\Delta t}
\right)
\end{equation}

Now consider the evaluation of the unknown vertical fluxes. To
maintain $\left. v_{sf} \right\rvert_{t+\Delta t} \geq 0$ requires that
\begin{equation}
\Delta t \left. q_{sf \rightarrow uz} \right\rvert_{t+\Delta t} \leq 
\Delta t q_{sf \rightarrow uz}^{pos} = \min\left( \Delta t a k_{sf}, 
\left. v_{sf} \right\rvert_{t} + 
\Delta t \left. l_{sf}^{-} \right\rvert_{t+\Delta t} \right)
\end{equation}

The upper limit of $v_{rz}$ and maximum flux from the surface store
result in
\begin{equation}
\Delta t \left. q_{rz \rightarrow uz}\right\rvert_{t+\Delta t} \leq
\Delta t q_{rz \rightarrow uz}^{pos} = \max\left( 0,
\left. v_{rz} \right\rvert_{t} + a p\Delta t +
\Delta t q_{sf \rightarrow rz}^{pos} - a e_p\Delta t - v_{rzmax}\right)
\end{equation}

From the unsaturated zone the implict solution when drainage to the saturated
zone occurs at rate $\frac{av_{uz}}{T_d v_{sz}}$ gives
\begin{equation}
\left. v_{uz} \right\rvert_{t+\Delta t} = 
\frac{T_d \left. v_{sz} \right\rvert_{t+\Delta t}}
{T_d \left. v_{sz} \right\rvert_{t+\Delta t} + a\Delta t}
\left(
\left. v_{uz} \right\rvert_{t} + \Delta t \left.q_{rz \rightarrow
uz}\right\rvert_{t+\Delta t}\right)
\end{equation}

This places an upper limit on $q_{uz \rightarrow sz}$ in terms of
$\left. v_{sz} \right\rvert_{t+\Delta t}$ as
\begin{equation}
\left. q_{uz \rightarrow sz}\right\rvert_{t+\Delta t}
\leq \min\left(
\frac{a\left( \left. v_{uz} \right\rvert_{t} + \Delta t q_{rz \rightarrow uz}^{pos}\right)}
{T_d \left. v_{sz} \right\rvert_{t+\Delta t} + a \Delta t}, \frac{a}{T_d}\right)
\end{equation}

The maximum possible flux to the saturated zone then occurs when
$\left. v_{sz} \right\rvert_{t+\Delta t}=0$ as
\begin{equation}
q_{uz \rightarrow sz}^{pos}
= \min\left(
\frac{\left. v_{uz} \right\rvert_{t} + \Delta t q_{rz \rightarrow uz}^{pos}}
{\Delta t}, \frac{a}{T_d}\right)
\end{equation}

Rearranging the evolution of the saturated storage defict gives
\begin{equation}
\left.q_{uz \rightarrow sz}\right\rvert_{t+\Delta t} = 
\frac{1}{\Delta t} \left(
\left. v_{sz} \right\rvert_{t} +
\Delta t \left(
w^{+} g\left(\frac{\left. v_{sz} \right\rvert_{t+\Delta t}}{a}\right) -
\left. l_{sz}^{-} \right\rvert_{t+\Delta t}\right) - 
\left. v_{sz} \right\rvert_{t+\Delta t}
\right)
\end{equation}

The right hand side of this expression is maximised when $\left. v_{sz} \right\rvert_{t+\Delta t}=0$ so
that
\begin{equation}
\left.q_{uz \rightarrow sz}\right\rvert_{t+\Delta t} \leq
\frac{1}{\Delta t} \left(
\left. v_{sz} \right\rvert_{t} +
\Delta t \left(
l_{szmax} -
\left. l_{sz}^{-} \right\rvert_{t+\Delta t}\right)\right)
\end{equation}

On the principle of maximising the downward flux two cases can be
distiguished:

1.  Case 1: $q_{uz \rightarrow sz}^{pos} \geq
\frac{1}{\Delta t} \left(
\left. v_{sz} \right\rvert_{t} +
\Delta t \left(
l_{szmax} -
\left. l_{sz}^{-} \right\rvert_{t+\Delta t}\right)\right)$. In this
case the zone involved in lateral saturated flow has reached the root
zone so $\left.v_{sz}\right\rvert_{t+\Delta t}=0$ and
\begin{equation}
\left.q_{uz \rightarrow sz}\right\rvert_{t+\Delta t} =
\frac{1}{\Delta t} \left(
\left. v_{sz} \right\rvert_{t} +
\Delta t \left(
l_{szmax} -
\left. l_{sz}^{-} \right\rvert_{t+\Delta t}\right)\right)
\end{equation}

2.  Case 2: $q_{uz \rightarrow sz}^{pos} <
\frac{1}{\Delta t} \left(
\left. v_{sz} \right\rvert_{t} +
\Delta t \left(
l_{szmax} -
\left. l_{sz}^{-} \right\rvert_{t+\Delta t}\right)\right)$.
In this case $\left.v_{sz}\right\rvert_{t+\Delta t}>0$ and satisfies
the pair of equations
\begin{equation}
\left.q_{uz \rightarrow sz}\right\rvert_{t+\Delta t} = 
\min \left(
\frac{A\left( \left. v_{uz} \right\rvert_{t} + \Delta t q_{rz \rightarrow uz}^{pos}\right)}
{T_d \left. v_{sz} \right\rvert_{t+\Delta t} + A\Delta t},
\frac{A}{T_d} \right)
\end{equation}
\begin{equation}
\left. v_{sz} \right\rvert_{t+\Delta t} =
\left. v_{sz} \right\rvert_{t} +
\Delta t \left(
w^{+} g\left(\left. v_{sz} \right\rvert_{t+\Delta t}\right) -
\left. l_{sz}^{-} \right\rvert_{t+\Delta t} -
\left.q_{uz \rightarrow sz}\right\rvert_{t+\Delta t}
\right)
\end{equation}

At least in the case of an exponential transmissivity profile Case 2 can be
robustly solved using numerical methods. 

Given the solution to one of the two cases 
\begin{equation}
\left. v_{uz} \right\rvert_{t + \Delta t} =
\left. q_{uz \rightarrow sz} \right\rvert_{t + \Delta t}
\frac{T_d}{a}
\left. v_{sz} \right\rvert_{t +\Delta t}
\end{equation}
and
\begin{equation}
\left. q_{rz \rightarrow uz} \right\rvert_{t + \Delta t} =
\frac{1}{\Delta t}\left(
\left. v_{uz} \right\rvert_{t + \Delta t} - \left. v_{uz} \right\rvert_{t}
\right) +
\left. q_{uz \rightarrow sz} \right\rvert_{t + \Delta t}
\end{equation}

The remaining vertical flows can then be solved for since
\begin{equation}
\left.q_{sf \rightarrow rz} \right\rvert_{t+\Delta t} = \min\left(
q_{sf \rightarrow rz}^{pos},
\frac{1}{\Delta t}\left(as_{rzmax} - \left. v_{rz} \right\rvert_{t}\right) +
a\left(e_p - p\right) + \left. q_{rz \rightarrow uz} \right\rvert_{t + \Delta
  t} \right)
\end{equation}

Subsitution of these fluxes into the initial implicit solutions for the
surface and root zone gives the states at $t+\Delta t$.

# Simulations

To illustrate the behaviour of the Instantaneous redistribution solution
consider the following set of simulations. Details on the HSU paraemters are
in the attached simualtion code. The details I don't think are overly relevent
but note that $k_{sf} = \infty$, so there is no limit to the flux from the
surface store downwards except for that provided by increasing storage in the
unsaturated and saturated zones.

## Simulation 1

Here a constant lateral flux $l_{sz}^{-} = w^{+} g\left(0\right)$ is input for
600 timesteps (labelled by index idx). The initial saturated storage deficit
is consumed and the laterla outflow converges to the $l_{sz}^{-}$, with no
vertical flux taking place. This seems to be reasonable.

```{r sim1s, echo=FALSE, fig.cap="Evolution of states with constant lateral flow to saturated zone eqivilent to potential maximum", out.width = '80%'}
knitr::include_graphics("Fig_states_IR_1.png")
```

```{r sim1f, echo=FALSE, fig.cap="Evolution of fluxes with constant lateral flow to saturated zone eqivilent to potential maximum", out.width = '80%'}
knitr::include_graphics("Fig_fluxes_IR_1.png")
```

## Simulation 2

Here a constant lateral flux $l_{sf}^{-} = w^{+} g\left(0\right)$ is input to
the surface store for 600 timesteps (labelled by index idx). The initial
storage deficit in the root zone is consumed and the storage in the
unsaturated and saturated zone grows. Note these reach an equilibrum based on
the value of $q_{uz \rightarrow sz}$ when $v_{uz} = v_{sz}$.

```{r sim2s, echo=FALSE, fig.cap="Evolution of states with constant lateral flow to the surface zone eqivilent to potential maximum lateral saturated flux", out.width = '80%'}
knitr::include_graphics("Fig_states_IR_2.png")
```

```{r sim2f, echo=FALSE, fig.cap="Evolution of fluxes with constant lateral flow to the surface zone eqivilent to potential maximum lateral saturated flux", out.width = '80%'}
knitr::include_graphics("Fig_fluxes_IR_2.png")
```

## Simulation 3

In this simulation we consider a constant lateral flux 
$l_{sf}^{-} = w^{+}	g\left(0\right) /4$ to the surface store for all 600
timesteps (labelled by index idx). The initial root zone storage deficit
is consumed then the unsaturated and saturated zone meeting. As this moves
towards an equilibrium surface storage increases and stabalises. 
After step 400 an additional inflow is applied with 
$l_{sz}^{-} = w^{+} g\left(0\right) /2$. This leads to an adjustment to a new
equilibrium for the saturated and unsaturated zones. The surface store
initially deviated and water is returned from the unsaturated zone, then
stabalises to it's previous value.

```{r sim3s, echo=FALSE, fig.cap="Evolution of states for Simulation 3", out.width = '80%'}
knitr::include_graphics("Fig_states_IR_3.png")
```
```{r sim3f, echo=FALSE, fig.cap="Evolution of fluxes for Simulation 3", out.width = '80%'}
knitr::include_graphics("Fig_fluxes_IR_3.png")
```


## Going forward...

Maybe you are happy with the above solutions - maybe not.

As the above simulation indicate this can reach a steady state
where the HSU is "full" in the sense that there is no storage deficit, but not
all the available subsurface is involved in lateral flow. If the HSU is driven
only from above ($l_{sf}$ or $p$) this indicates that
the maximum vertical flux in a saturated subsurface ($a/T_d$) is less then the
potential maximum lateral flux $w^{+}g\left(0\right)$. This may place a
perceptual limit on the parameter ranges.

When $v_{uz}=v_{sz}$ the seperation in the above solution is based on flow direction.
One alternative is to assume that when $v_{uz}=v_{sz}$ the subsurface is saturated
therefore the states should switch to $v_{uz}=v_{sz}=0$, making all the water
in the subsurface available for lateral flow. Altering the model to impliment this and running
Simulation 3 produces the following plots:

```{r sim3is, echo=FALSE, fig.cap="Evolution of states for Simulation 3 with saturated zone switch", out.width = '80%'}
knitr::include_graphics("Fig_states_IR_switch_3.png")
```
```{r sim3if, echo=FALSE, fig.cap="Evolution of fluxes for Simulation 3 with saturated zone switch", out.width = '80%'}
knitr::include_graphics("Fig_fluxes_IR_switch_3.png")
```

These results indicate that subsurface flow is prioritised, no surface water is
created. However rather then coverging to a steady state the solution
established a stable but cyclic pattern due to the interplay of 
$q_{uz \rightarrow sz}$ and $l_{sz}$. This would appear undesirable. 
