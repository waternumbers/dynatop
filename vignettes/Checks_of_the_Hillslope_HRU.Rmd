---
title: "Checks of the Hillslope HRU"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Checks of the Hillslope HRU}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
The purpose of this vignette is to demonstrate some simulation checks on the computation of hillslope elements. It provides both a check for
the current implimentation of the code and a demonstration for those that may
be developing more complex systems and want to perform their own test.

The basis of the simulations used in the test catchment contained within the
package which is loaded with
```{r, setup}
#rm(list=ls())
library(dynatop)
data("test_catchments")
```

# Computing the volume of water in the hillslope
The volume of water in the hillslope can be computed from the states of the
system upto an additive constant. The volume in each hillslope HRU is given by
the sum of the surface excess, root zone, unsaturated zone and saturated zone
storages multiplied by the surface area. However only the storage deficit of saturated zone
is known. We therefore subtract this value and treat the unknown maximum
saturated zone storage as an unknown additive constant. Note that this can
result in apparently negatoive storages, but is adequate for the purposes of
assessing changes to storage.

In R this is implimented by the following function whose result is in m$^3$.
```{r vol_calc}
hillslope_volume <- function(mdl,ignore_sz=FALSE){
  tmp <- mdl$hillslope
  if(!ignore_sz){
    sum( tmp$area * (tmp$s_sf + tmp$s_rz + tmp$s_uz - tmp$s_sz) )
  }else{
    sum( tmp$area * (tmp$s_sf + tmp$s_rz + tmp$s_uz) )
  }
}
```

# Initialising the model
In calling `dynatop` the states can either be provided as part 
of the model structure of can be initialised internally. In this vignette we
make use of this to initialise the model and then set certain states
manually. This is not recommended in practice.
However for
testing it is useful to be able to manipulate the states manually. 

# Individual levels of the hillslope with no forceing

These tests check individual levels of the hillslope representation when there
is no forcing from external variables.

A set of forecing data with zeros values can be created by
```{r zero_obs}
obs <- test_catchments$obs
obs$rain[] <- obs$pet[] <- 0
```

We also initialise a test model and keep this for future reuse
```{r, base_model}
base_model <- test_catchments$simple_hillslope
base_model <- initialise(base_model,0.015)
```

## Surface

With out any forcing the surface zone should redistribute water in a
conservative way.

Take the initialised model and set all stores to be empty except the surface
store.

```{r}
initial_mdl <- base_model
for(ii in c("s_rz","s_uz")){
  initial_mdl$hillslope[,ii] <- 0
}
initial_mdl$hillslope[,'s_sz'] <- 1e10
initial_mdl$hillslope[,'s_sf'] <- 0.1
```

Set the `q_sfmax` so that no water is absorbed back into the soil and
`l_szmax` so that no water drains from the saturated store
```{r}
initial_mdl$param["qsf_max_default"] <- 0
initial_mdl$hillslope[,"l_szmax"] <- 0
```

Simulate the model and compute volume balance per unit area.
```{r}
out <- dynatop(initial_mdl,obs,use_states=TRUE)
initial_vol <- hillslope_volume(initial_mdl)
final_vol <- hillslope_volume(out$model)
channel_vol <- sum(out$channel_input) * unique(diff(.index(out$channel_input)))
(initial_vol - (final_vol + channel_vol))
```

## Root zone

With out any forcing the root zone should just hold its current water.

Take the initialised model and set all stores to be empty except the root
zone, which has the initialisation volume and the saturated zone with is set
to saturation.

```{r}
initial_mdl <- base_model
for(ii in c("s_sf","s_uz","s_sz")){
  initial_mdl$hillslope[,ii] <- 0
}
```

Set the `q_sfmax` so that no water is absorbed back into the soil from the
surface store and
`l_szmax` so that no water drains from the saturated store
```{r}
initial_mdl$param["qsf_max_default"] <- 0
initial_mdl$hillslope[,"lsz_max"] <- 0
```

Simulate the model and compute volume balance per unit area.
```{r}
out <- dynatop(initial_mdl,obs,use_states=TRUE)
initial_vol <- hillslope_volume(initial_mdl)
final_vol <- hillslope_volume(out$model)
channel_vol <- sum(out$channel_input) * unique(diff(.index(out$channel_input)))
abs(initial_vol - (final_vol + channel_vol))
```

## Unsaturated zone

With no forcing the unsaturated zone should drain to the saturated zone.

Take the initialised model and set all stores to be empty except the unsaturated
zone, which has the initialisation volume and the saturated zone with is set
to a greater deficit then the unsaturated zone.

```{r}
initial_mdl <- base_model
for(ii in c("s_sf","s_rz")){
  initial_mdl$hillslope[,ii] <- 0
}
initial_mdl$hillslope[,'s_uz'] <- 0.1
initial_mdl$hillslope[,'s_sz'] <- initial_mdl$hillslope[,'s_uz'] + 1
```

Set the `q_sfmax` so that no water is absorbed back into the soil from the
surface store and
`l_szmax` so that no water drains from the saturated store
```{r}
initial_mdl$param["qsf_max_default"] <- 0
initial_mdl$hillslope[,"lsz_max"] <- 0
```

Simulate the model and compute volume balance per unit area.
```{r}
out <- dynatop(initial_mdl,obs,use_states=TRUE)
initial_vol <- hillslope_volume(initial_mdl)
final_vol <- hillslope_volume(out$model)
channel_vol <- sum(out$channel_input) * unique(diff(.index(out$channel_input)))
abs(initial_vol - (final_vol + channel_vol))
```

## Saturated zone drain down

This check tests the performance of the saturated zone solution when there is
no flow from the unsaturated zone. The flow should drain to the channel.

Take the initialised model and set all stores to be empty except the saturated
zone with is set to be full

```{r}
initial_mdl <- base_model
for(ii in c("s_sf","s_uz","s_rz","s_sz")){
  initial_mdl$hillslope[,ii] <- 0
}
```

Set the `q_sfmax` so that no water is absorbed back into the soil from the
surface store if there is saturation excess
```{r}
initial_mdl$param[["qsf_max_default"]][] <- 0
```
simulate the model and compute volume balance per unit area.
```{r}
out <- dynatop(initial_mdl,obs,use_states=TRUE)
initial_vol <- hillslope_volume(initial_mdl)
final_vol <- hillslope_volume(out$model)
channel_vol <- sum(out$channel_input) * unique(diff(.index(out$channel_input)))
abs(initial_vol - (final_vol + channel_vol))
```

# All model with no evapotranspiration losses
This tests the solution assuming there is no loss to
evapotranspiration. Testing beyond this requires the recording ot the losses
to evapotranspiration which is not yet implimented.

Create a new observation series

```{r all_no_pet}
obs <- test_catchments$obs
obs$pet[] <- 0
```

Simualate the model and compute the mass balance
```{r}
initial_mdl <- base_model
out <- dynatop(initial_mdl,obs,use_states=TRUE)
initial_vol <- hillslope_volume(initial_mdl)
final_vol <- hillslope_volume(out$model)
channel_vol <- sum(out$channel_input) * unique(diff(.index(out$channel_input)))
precip_vol <- sum(obs$rain)*sum(c(initial_mdl$hillslope$area,
                                  initial_mdl$channel$area))
abs(initial_vol + precip_vol- (final_vol + channel_vol))

```
