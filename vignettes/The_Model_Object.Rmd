---
title: "The Model Object"
output: 
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_depth: 2
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{The Model Object}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
The purpose of this vignette is to document the structure of a Dynamic
Topmodel 'object'; that is the structure of the model that can be generated in
the [dynatopGIS](https://waternumbers.github.io/dynatopGIS) package and is
used in calls to the ```dynatop``` function in the current package. Currently
the model is stored as an R variable of the list class. In the future it is
indended to create an S3 (or similar) class for the model to formalise the
object oriented style adopted in the a package.

This should be read alongside the ["Getting
Started"](https://waternumbers.github.io/dynatop/articles/dynatop.html) vignette.

The model strucutre will be documented with reference to the model in the test
catchment data supplied with the package. This can be loaded with
```{r, setup}
library(dynatop)
data("brompton")
model <- brompton$model
```
The top level of the model contains the following elements:
```{r model_parts}
names(brompton$model)
```
These are oulined in Table \@ref(tab:model-table) and described in more detail in the sections
below.

```{r, model-table, echo=FALSE, results='asis'}
tmp <- data.frame(Name=character(0),
                  Class=character(0),
                  Description=character(0),
                  stringsAsFactors=FALSE)
tmp[1,] <- c("hillslope","data frame","Description of the hill slope HRU units")
tmp[2,] <- c("channel","data frame","Description of the channel HRU units")
tmp[3,] <- c("Wsat","matrix","Fractions for the redistribution of the saturated zone fluxes between hill slope HRUs")
tmp[4,] <- c("Wex","matrix","Fractions for the redistribution of the surface excess fluxes between hill slope HRUs")
tmp[5,] <- c("Fsat","matrix","Fractions for the redistribution of the saturated zone fluxes between hill slope and channel HRUs")
tmp[6,] <- c("Fex","matrix","Fractions for the redistribution of the surface excess fluxes between hill slope and channel HRUs")
tmp[7,] <- c("point_inflow","data frame","Description of the locations of point inflows to the channel network")
tmp[8,] <- c("Fex","data frame","Description of the gauge locations on the channel network")

knitr::kable(tmp,booktabs = TRUE,
             caption="Decription of top level model components")
```

## Hillslope HRU table
Each row of the hillslope HRU table describes a single hillslope HRU, the
input series in expects and parameters. In this example it looks like:
```{r hillslope_parts}
head(model$hillslope)
```

The individual columns are documented in Table \@ref(tab:hillslope-table). With the exception of the
id, area, atb_bar and s_bar columns the table does not contain numeric values
but the names of either time series to find in the forecing data or parameters
in ```model$param```.

```{r, hillslope-table, echo=FALSE, results='asis'}
vtmp <- sapply(model$hillslope,class)
tmp <- data.frame(Column=names(vtmp),
                  Class=vtmp,
                  Description=character(length(vtmp)),
                  stringsAsFactors=FALSE)
tmp["id","Description"] <- "Unique identifying number of the hillslope HRU. If generated by ```dynatopGIS``` this will match the identifying number in the raster map used to generate the model."
tmp["area","Description"] <- "Area of the HRU in m$^2$"
tmp["atb_bar","Description"] <- "Average of area divided by tan of gradient topographic index"
tmp["s_bar","Description"] <- "Average gradient"
tmp["precip_input","Description"] <- "Name of the input series to use for precipitation"
tmp["pet_input","Description"] <- "Name of the input series to use for potential evapotranspiration"
tmp["srz_max","Description"] <- "Name of the maximum root zone depth parameter"
tmp["srz_0","Description"] <- "Name of the intial root zone depth parameter"
tmp["ln_t0","Description"] <- "Name of the saturated conductivity parameter"
tmp["m","Description"] <- "Name of the exponential transmissivity constant parameter"
tmp["td","Description"] <- "Name of the unsaturated zone time constant per m of saturated storage deficit parameter."
tmp["tex","Description"] <- "Name of the Surface excess storage time constant parameter"

knitr::kable(tmp,row.names=FALSE,
             caption="Description of hillslope data frame columns")
```

## Channel HRU table
Each row of the channel HRU table describes a single hillslope HRU, the
input series in expects and parameters. In this example it looks like:
```{r channel_parts}
head(model$channel)
```

The individual columns are documented in Table \@ref(tab:channel-table). With the exception of the
id, area, next_id and length the table does not contain numeric values
but the names of either time series to find in the forecing data or parameters
in ```model$param```.

```{r, channel-table, echo=FALSE, results='asis'}
vtmp <- sapply(model$channel,class)
tmp <- data.frame(Column=names(vtmp),
                  Class=vtmp,
                  Description=character(length(vtmp)),
                  stringsAsFactors=FALSE)
tmp["id","Description"] <- "Unique identifying number of the hillslope HRU. If generated by ```dynatopGIS``` this will match the identifying number in the channel raster map used to generate the model."
tmp["area","Description"] <- "Area of the HRU in m$^2$"
tmp["precip_input","Description"] <- "Name of the input series to use for precipitation"
tmp["pet_input","Description"] <- "Name of the input series to use for potential evapotranspiration"
tmp["next_id","Description"] <- "The id of the next channel HRU downstream"
tmp["v_ch","Description"] <- "Name of the channel velocity parameter"
tmp["length","Description"] <- "Length of the channel in metres"

knitr::kable(tmp,row.names=FALSE,
             caption="Description of channel data frame columns")
```


## Parameter vector
The paraemter vector is a named numneric vector of parameter values. The names
should correspond to those specified in the hillslope and channel tables. In
this case:
```{r param_parts}
model$param
```

## Redistribution matrices (Wsat, Wex, Fsat, Fex)
The redistributiuon matrices specify how the lateral fluxes move between the
different HRUs. The matrices are specfied in the same fashion with columns
being the 'source' HRU and rows the 'destination' HRU. The columns and rows
are named in keeping with the values of the id columns in the hillslope and
channel tables.

In the case of Wex and Wsat which characterise the movements between the
hillslope HRUs it can be seen that the names are the same in both cases: 
```{r redist_W_parts}
colnames(model$Wex)
rownames(model$Wex)
```
In Fex and Fsat the row names relate to the channel id values while the column
names relate to the hillslope id values
```{r redist_F_parts}
colnames(model$Fex)
rownames(model$Fex)
```

## Point Inflows
The point_inflow data frame allows the specification of locations on the river
network at which inflows can occur. The strucutre of the data frame exactly
matchs that of the gauge specifications (see Table \@ref{tab:gauge-table}). In the current catchment there are no
inflows so the table is left blank:
```{r point_inflow}
model$point_inflow
```

## Gauge locations
Gauge locations can be specified on the channel HRUs as outlined in
\@ref{tab:gauge-table}. 

```{r, gauge-table, echo=FALSE, results='asis'}
vtmp <- sapply(model$gauge,class)
tmp <- data.frame(Column=names(vtmp),
                  Class=vtmp,
                  Description=character(length(vtmp)),
                  stringsAsFactors=FALSE)
tmp["name","Description"] <- "Unique name to idenfy the gauge. used in the channel routing to name the output."
tmp["channel_id","Description"] <- "The id of the channel HRU on which the gauge is sited"
tmp["fraction","Description"] <- "Fraction of the length of the channel HRU (from the head) of the location of the gauge. A value of 1 corresponds to the foot on the channel HRU and 0 the head."

knitr::kable(tmp,row.names=FALSE,
             caption="Description of gauge and point inflow data frame columns")
```

The current example has two gauges:
```{r gauge}
model$gauge
```

