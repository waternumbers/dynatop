---
title: "The Model Object"
output: 
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_depth: 2
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{The Model Object}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
The purpose of this vignette is to document the structure of a Dynamic
Topmodel 'object'; that is the structure of the model that can be generated in
the [dynatopGIS](https://waternumbers.github.io/dynatopGIS) package and is
used in calls to the ```dynatop``` function in the current package. Currently
the model is stored as an R variable of the list class. In the future it is
indended to create an S3 (or similar) class for the model to formalise the
object oriented style adopted in the a package.

This should be read alongside the ["Getting
Started"](https://waternumbers.github.io/dynatop/articles/dynatop.html) vignette.

The model strucutre will be documented with reference to the model in the test
catchment data supplied with the package. This can be loaded with

```{r, setup}
library(dynatop)
data("Swindale")
model <- Swindale$model
```

The top level of the model contains the following elements:

```{r model_parts}
names(model)
```

These are oulined in Table \@ref(tab:model-table) and described in more detail in the sections
below.

```{r model-table, echo=FALSE, results='asis'}
tmp <- data.frame(Name=character(0),
                  Class=character(0),
                  Description=character(0),
                  stringsAsFactors=FALSE)
tmp[1,] <- c("hillslope","data frame","Description of the hill slope HRU units")
tmp[2,] <- c("channel","data frame","Description of the channel HRU units")
tmp[3,] <- c("param","numeric","Named vector of paramter values")
tmp[4,] <- c("gauge","data frame","Description of the gauge locations on the channel network")
tmp[5,] <- c("point_inflow","data frame","Description of the locations of point inflows to the channel network")
tmp[6,] <- c("point_inflow","data frame","Description of the locations of point inflows to the channel network")
tmp[7,] <- c("map","list","Data for creating maps of the HSUs")

knitr::kable(tmp,booktabs = TRUE,
             caption="Decription of top level model components")
```

## Hillslope HRU table

Each row of the hillslope HRU table describes a single hillslope HRU, the
input series in expects and parameters. In this example it looks like:
```{r hillslope_parts}
head(model$hillslope)
```

The individual columns are documented in Table \@ref(tab:hillslope-table). With the exception of the
id, area, atb_bar and s_bar columns the table does not contain numeric values
but the names of either time series to find in the forecing data or parameters
in ```model$param```.

```{r hillslope-table, echo=FALSE, results='asis'}
tmp <- data.frame(Name=character(0),
                  Class=character(0),
                  Unit=character(0),
                  Description=character(0),
                  stringsAsFactors=FALSE)
tmp[1,] <- c("id","integer","-","Unique identifying number of the HSU. These combined with the HSU numbers in the channel table should be unique and take values 1,2,3... gaps")
tmp[2,] <- c("area","numeric","$m^2$","Surface area of the HSU")
tmp[3,] <- c("atb_bar","numeric","??","Topographic index, log if the upslope area divided by tangent of gradient")

tmp[4,] <- c("s_bar","numeric","-","Average gradient")
tmp[5,] <- c("delta_x","numeric","m","Notional length of the HSU")
tmp[6,] <- c("class","integer","-","Classification of HSU e.g. by a combination of topographic index and rainfall input")
tmp[7,] <- c("*_class","integer","-","Parital classification of HSU by the * property e.g. atb_bar for topographic index")
tmp[8,] <- c("precip","character","-","Name of the input series to use for precipitation")
tmp[9,] <- c("pet","character","-","Name of the input series to use for potential evapotranspiration")
tmp[10,] <- c("q_sfmax","character","$m/s$","Maximum flow rate from surface to root zone")
tmp[11,] <- c("s_rzmax","character","$m$","Name of the maximum root zone depth parameter")
tmp[12,] <- c("s_rz0","character","$0-1$","Name of the intial root zone depth parameter. Expressed as fraction of maximum depth")
tmp[13,] <- c("ln_t0","character","-","Name of the saturated conductivity parameter")
tmp[14,] <- c("m","character","-","Name of the exponential transmissivity constant parameter")
tmp[15,] <- c("t_d","character","$s/m$","Name of the unsaturated zone time constant per m of saturated storage deficit parameter.")
tmp[16,] <- c("t_sf","character","$s$","Name of the Surface excess storage time constant parameter")
tmp[17,] <- c("sf_dir","list","-","Description of the surface lateral flow connections - see below")
tmp[18,] <- c("sz_dir","list","-","Description of the surface lateral flow connections - see below")

knitr::kable(tmp,row.names=FALSE,
             caption="Description of hillslope data frame columns")

```

The list structures of `sf_dir` and `sz_dir` are identical. They contain three
elements and listed in Table \@ref{tab:sf-dir-table}, for example:

```{r sf_dir_ex}
model$hillslope$sf_dir[[1]]
```


```{r sf-dir-table, echo=FALSE, results='asis'}
tmp <- data.frame(Name=c("band","idx","frc"),
                  Class=c("integer","integer","numeric"),
                  Description=c("Indication of computational sequence. HSUs in band $n$ presume that those in bands $1,\\ldots,n-1$ have been solved first.",
                                "id values of the HSUs receiving lateral fluxes",
                                "fraction of lateral flux that the corresponding HSUs in idx receive"),
                  stringsAsFactors=FALSE)

knitr::kable(tmp,row.names=FALSE,
             caption="Description of sf_dir and sz_dir list structures")
```

## Channel HRU table

Each row of the channel HRU table describes a single hillslope HRU, the
input series in expects and parameters. In this example it looks like:
```{r channel_parts}
head(model$channel)
```

The individual columns are documented in Table \@ref(tab:channel-table). 

```{r channel-table, echo=FALSE, results='asis'}
vtmp <- sapply(model$channel,class)
tmp <- data.frame(Column=character(0),
                  Class=character(0),
                  Unit=character(0),
                  Description=character(0),
                  stringsAsFactors=FALSE)
tmp[1,] <- c("id","integer","-","Unique identifying number of the hillslope HRU. These, combined with the id from the hillslope table should for consecuative integers increasing from 1.")
tmp[2,] <- c("area","numeric","$m^2$","Surface area of the HSU in m$^2$")
tmp[3,] <- c("length","numeric","$m$","Length of the channel in metres")
tmp[4,] <- c("precip","character","-","Name of the input series to use for precipitation")
tmp[5,] <- c("pet","character","-","Description","Name of the input series to use for potential evapotranspiration")
tmp[6,] <- c("v_ch","character","-","Name of the channel velocity parameter")
tmp[7,] <- c("flow_dir","list","-","As for sf_sir and sz_dir in the hillslope table with the exclusion of the band")

knitr::kable(tmp,row.names=FALSE,
             caption="Description of channel data frame columns")
```

## Parameter vector

The paraemter vector is a named numneric vector of parameter values. The names
should correspond to those specified in the hillslope and channel tables. In
this case:
```{r param_parts}
model$param
```

## Gauge locations
Gauge locations can be specified on the channel HSUs as outlined in Table
\@ref(tab:gauge-table). 

```{r gauge-table, echo=FALSE, results='asis'}
tmp <- data.frame(Column=character(0),
                  Class=character(0),
                  Description=character(0),
                  stringsAsFactors=FALSE)

tmp[1,] <- c("name","character","Unique name to idenfy the gauge. used in the channel routing to name the output.")
tmp[2,] <- c("id","integer","The id of the channel HSU on which the gauge is sited")
tmp[3,] <- c("fraction","numeric","Fraction of the length of the channel HSU from the head where the gauge is located. A value of 1 corresponds to the foot on the channel HSU and 0 the head.")

knitr::kable(tmp,row.names=FALSE,
             caption="Description of gauge data frame columns")
```

The current example has one gauges:

```{r gauge}
model$gauge
```

## Point Inflows

The point_inflow data frame allows the specification of locations on the river
network at which inflows can occur. 

```{r point-table, echo=FALSE, results='asis'}
tmp <- data.frame(Column=character(0),
                  Class=character(0),
                  Description=character(0),
                  stringsAsFactors=FALSE)

tmp[1,] <- c("name","character","Name of the input series to use.")
tmp[2,] <- c("id","integer","The id of the channel HSU on which the gauge is sited")
tmp[3,] <- c("fraction","numeric","Fraction of the length of the channel HSU from the head where the gauge is located. A value of 1 corresponds to the foot on the channel HSU and 0 the head.")

knitr::kable(tmp,row.names=FALSE,
             caption="Description of point inflow data frame columns")
```

In the current catchment there are no inflows so the table is left blank:

```{r point_inflow}
model$point_inflow
```

## Diffuse Inflows

The diffuse_inflow data frame allows the specification of diffuse inputs to
the channel. These are presemed to occure uniformly along the channel length. 

```{r diffuse-table, echo=FALSE, results='asis'}
tmp <- data.frame(Column=character(0),
                  Class=character(0),
                  Description=character(0),
                  stringsAsFactors=FALSE)

tmp[1,] <- c("name","character","Name of the input series to use.")
tmp[2,] <- c("id","integer","The id of the channel HSU on which the gauge is sited")

knitr::kable(tmp,row.names=FALSE,
             caption="Description of point inflow data frame columns")
```

In the current catchment there are no inflows so the table is left blank:

```{r diffuse_inflow}
model$diffuse_inflow
```

