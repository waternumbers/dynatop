## Script for creating and building the dynatop R package
rm(list=ls())
graphics.off()

## path of the package
pacPath <- '../'
Rcpp::compileAttributes(pacPath)
devtools::document(pacPath)
devtools::check(pacPath)

## check documentation build
pkgdown::clean_site(pacPath)
pkgdown::build_site(pacPath)
pkgdown::clean_site(pacPath)

## build, populate drat
## linux
dratPath <- "~/Documents/Software/drat"
tmp <- devtools::build(pacPath)
install.packages(tmp)
drat::insertPackage(tmp,dratPath)#,action="prune")

## mac and windows
rhub::validate_email() # for first time that session
pkgName <- sub('\\.tar.gz$', '', basename(tmp)) 
## rhub::platforms()[,1] # lists platforms
mch <- rhub::check(path = tmp,
                   platform = c("macos-highsierra-release-cran","windows-x86_64-release"))

tmp <- paste0(pkgName,".tgz")
ftmp <- file.path("../..",tmp)
download.file(file.path(mch$urls()$artifacts[1],tmp),ftmp)
drat::insertPackage(ftmp,dratPath,action="prune")

tmp <- paste0(pkgName,".zip")
ftmp <- file.path("../..",tmp)
##download.file(file.path(mch$urls()$artifacts[3],tmp),ftmp)
##drat::insertPackage(ftmp,dratPath,action="prune")
download.file(file.path(mch$urls()$artifacts[2],tmp),ftmp)
drat::insertPackage(ftmp,dratPath,action="prune")

## tidy up drat
drat::pruneRepo(dratPath,pkg="dynatop",remove="git")## this only does source files




###########################################################################
## This converts the data for Swindale into the data object used in the examples.
rm(list=ls())
pacPath <- '../'
devtools::load_all(pacPath)
model <- readRDS("Swindale_exp.rds")
model$precip_input$name <- "Rainfall"
model$pet_input$name <- "PET"


qr <- read.csv( "start=2009-11-18_end=2009-11_4_int=0.25-hours_units=mm.hr-1.tsv",sep="\t")
obs <- as.xts(qr[,c("Flow","Rainfall")],order.by= as.POSIXct(qr[,'Date'],format="%d/%m/%Y %H:%M",tz='GMT'))
## According to original notes and code Flow in cumecs and precip in mm/timestep
obs$Rainfall <- obs$Rainfall/1000 # convert to m/timestep
obs$PET <- evap_est(index(obs),0,5/1000) # in m

Swindale <- list(model=model,obs=obs)
save("Swindale",file="../data/Swindale.rda")






## ########################################
## This code uses Swindale and calls all the different transmissivity profiles
## with models generated by dynatopGIS
rm(list=ls())
devtools::load_all("../"); data("Swindale");
for(ii in list.files(".",pattern="^Swindale.*\\.rds$")){
    print(ii)
    mdl <- readRDS(ii)
    mdl$precip_input$name <- "Rainfall"
    mdl$pet_input$name <- "PET"
    dt <- dynatop$new(mdl)$add_data(Swindale$obs)#[1:2,,drop=FALSE])
    dt$initialise()$sim_hillslope()
    print(range(dt$get_mass_errors()[,6]))
    print(warnings())    
}


    
