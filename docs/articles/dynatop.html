<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Dynamic TOPMODEL • dynatop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Dynamic TOPMODEL">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatop.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Banding.html">Banding of HSUs</a>
    </li>
    <li>
      <a href="../articles/Checks_of_the_Hillslope_HRU.html">Checks of the Hillslope HRU</a>
    </li>
    <li>
      <a href="../articles/Checks_of_the_Time_Delay_routing.html">Checks of the Time Delay Routing</a>
    </li>
    <li>
      <a href="../articles/Selected_References.html">Selected References</a>
    </li>
    <li>
      <a href="../articles/The_Model_Object.html">The Model Object</a>
    </li>
    <li>
      <a href="../articles/The_solution_of_Dynamic_TOPMODEL.html">The Dynamic TOPMODEL Implimentation</a>
    </li>
    <li>
      <a href="../articles/The_solution_of_Dynamic_TOPMODEL_ordered.html">The Dynamic TOPMODEL Implimentation</a>
    </li>
    <li>
      <a href="../articles/Time_Delay_Channel_Routing.html">Time Delay Channel Routing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatop">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using Dynamic TOPMODEL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatop/blob/master/../vignettes/dynatop.Rmd"><code>../vignettes/dynatop.Rmd</code></a></small>
      <div class="hidden name"><code>dynatop.Rmd</code></div>

    </div>

    
    
<p>The purpose of this vignette is to provide an outline of the steps needed to perform a Dynamic TOPMODEL simulation and introduce the formats of the data input and returned.</p>
<p>The data used in this example comes from Swindale and is contained within the package and can be loaded with</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dynatop)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#&gt; Loading required package: xts</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#&gt; Loading required package: zoo</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&gt; </span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#&gt; Attaching package: 'zoo'</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&gt; </span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt;     as.Date, as.Date.numeric</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt; Registered S3 method overwritten by 'xts':</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt;   method     from</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt;   as.zoo.xts zoo</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#&gt; Loading required package: Matrix</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"Swindale"</span>)</span></code></pre></div>
<p>which returns a variable <code>Swindale</code> with the following components:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(Swindale)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#&gt; [1] "model" "obs"</span></span></code></pre></div>
<p>In the following # The model structure A dynamic TOPMODEL is described in a list object. The list has the following elements</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>model &lt;-<span class="st"> </span>Swindale<span class="op">$</span>model</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(model)</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#&gt; [1] "hillslope"    "channel"      "param"        "Fsz"          "Fsf"         </span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#&gt; [6] "gauge"        "point_inflow"</span></span></code></pre></div>
<p>which are described in <a href="https://waternumbers.github.io/dynatop/articles/The_Model_Object.html">associated vignette</a>. The <a href="https://waternumbers.github.io/dynatopGIS">dynatopGIS</a> package can be used for constructing models.</p>
<div id="checking-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#checking-the-model" class="anchor"></a>Checking the model</h2>
<p>The structure of the model can be tested:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="../reference/check_model.html">check_model</a></span>(model,<span class="dt">delta=</span><span class="dv">0</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt; Error in check_model(model, delta = 0): Fsz should have column sums that are less or equal to 1</span></span></code></pre></div>
<p>In this case we can see that the model fails due to the redistribution of the flows from the hill slope HRUs. In all cases the sum of the fractions describing the destination of the flows is greater then 1, meaning that flow is artificially generated during the redistribution. This can be checked manually by</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(model<span class="op">$</span>Fsz) <span class="op">-</span><span class="st"> </span><span class="dv">1</span> )</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#&gt; [1] 2.753353e-14</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(model<span class="op">$</span>Fsf) <span class="op">-</span><span class="st"> </span><span class="dv">1</span> )</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#&gt; [1] 2.753353e-14</span></span></code></pre></div>
<p>As can be seen these are very small rounding errors from the model generation. These can be very hard to completely fix. Using the default value of <code>delta</code> (1e-13) means the model passes the checks.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw"><a href="../reference/check_model.html">check_model</a></span>(model)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#&gt; [1] "unknown"</span></span></code></pre></div>
<p>The value returned is a vector of the names of the expected time series input, currently the a default value.</p>
</div>
<div id="altering-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#altering-parameters" class="anchor"></a>Altering parameters</h2>
<p>The parameter values are stored in the parameter vector <code>model$parameters</code>. Each parameter value has a unique name. In the current model the parameters are all set to their default values:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(model<span class="op">$</span>param)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co">#&gt; q_sfmax_default s_rzmax_default   s_rz0_default   ln_t0_default       m_default </span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&gt;             Inf           0.050           0.990          19.000           0.004 </span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt;     t_d_default    t_sf_default    v_ch_default </span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt;          20.000         100.000         100.000</span></span></code></pre></div>
<p>The relationship between the parameters and the HRUs are given in the columns of the HRU tables e.g.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">## unsaturated zone time constant</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>( model<span class="op">$</span>hillslope[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'id'</span>,<span class="st">'t_d'</span>)])</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co">#&gt;   id         t_d</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co">#&gt; 1 20 t_d_default</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">#&gt; 2 21 t_d_default</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co">#&gt; 3 22 t_d_default</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">#&gt; 4 23 t_d_default</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">#&gt; 5 24 t_d_default</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">#&gt; 6 25 t_d_default</span></span></code></pre></div>
<p>Altering parameter values requires changing there values in the parameter vector. For this catchment all HRU have the same parameter values. This could be altered by changing parameter names in the HRU table and adding these parameters to the parameter vector.</p>
<p>In this case we change the parameter vectors to me more representative of the catchment</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>model<span class="op">$</span>param &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">q_sfmax_default=</span><span class="ot">Inf</span>,</span>
<span id="cb9-2"><a href="#cb9-2"></a>                 <span class="dt">m_default=</span><span class="fl">0.0063</span>,</span>
<span id="cb9-3"><a href="#cb9-3"></a>                 <span class="dt">ln_t0_default=</span><span class="fl">7.46</span>,</span>
<span id="cb9-4"><a href="#cb9-4"></a>                 <span class="dt">s_rz0_default=</span><span class="fl">0.98</span>,</span>
<span id="cb9-5"><a href="#cb9-5"></a>                 <span class="dt">s_rzmax_default=</span><span class="fl">0.1</span>,</span>
<span id="cb9-6"><a href="#cb9-6"></a>                 <span class="dt">v_ch_default=</span><span class="fl">0.8</span>,</span>
<span id="cb9-7"><a href="#cb9-7"></a>                 <span class="dt">t_d_default=</span><span class="dv">8</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>,</span>
<span id="cb9-8"><a href="#cb9-8"></a>                 <span class="dt">t_sf_default=</span><span class="fl">3.6e+05</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>                 )</span></code></pre></div>
</div>
<div id="banding-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#banding-the-model" class="anchor"></a>Banding the model</h1>
<p>For the purposes of this vignette the model will be banded with using the <code>band_model</code> command. It is recommended that you experiment with the effects of this command and run the complete model.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/band_model.html">band_model</a></span>(model,<span class="dv">5</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#&gt; [1]  37  71  92 109 111</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#&gt; [1]  36  68  69  89 105</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span>
<span id="cb10-14"><a href="#cb10-14"></a></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co">#&gt; [1] 85</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="co">#&gt; Warning in band_model(model, 5): Unable to merge all new bands without outlet</span></span></code></pre></div>
</div>
<div id="preparing-input-data" class="section level1">
<h1 class="hasAnchor">
<a href="#preparing-input-data" class="anchor"></a>Preparing input data</h1>
<p>The input to the model is expected to take the form of an <code>xts</code> object with constant time step whose column names are found in the ‘precip_input’ and ‘pet_input’ columns of the HRU table in the model. Helpful functions for creating and manipulating <code>xts</code> objects can be found [here]{<a href="http://rstudio-pubs-static.s3.amazonaws.com/288218_117e183e74964557a5da4fc5902fc671.html" class="uri">http://rstudio-pubs-static.s3.amazonaws.com/288218_117e183e74964557a5da4fc5902fc671.html</a>}</p>
<p>The discharge, precipitation and potential evapotranspiration (PET) inputs for Swindale and contained with <code>obs</code> on a 15 minute time step.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>obs &lt;-<span class="st"> </span>Swindale<span class="op">$</span>obs</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(obs)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">#&gt; Warning: timezone of object (GMT) is different than current timezone ().</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">#&gt;                     Flow Rainfall          PET</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">#&gt; 2009-11-18 16:00:00 2.78    4e-04 8.878467e-06</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">#&gt; 2009-11-18 16:15:00 2.80    2e-04 4.762229e-06</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co">#&gt; 2009-11-18 16:30:00 2.85    4e-04 8.585708e-07</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">#&gt; 2009-11-18 16:45:00 2.94    2e-04 0.000000e+00</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co">#&gt; 2009-11-18 17:00:00 3.02    2e-04 0.000000e+00</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">#&gt; 2009-11-18 17:15:00 3.15    2e-04 0.000000e+00</span></span></code></pre></div>
<p>Note the discharge is in <span class="math inline">\(m^{3}/s\)</span> while the precipitation and PET are in m accumulated over the timestep.</p>
<p>To use the data with the model we need to set the names of the time series within the model.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>model<span class="op">$</span>hillslope[,<span class="st">'precip'</span>] &lt;-<span class="st"> </span>model<span class="op">$</span>channel[,<span class="st">'precip'</span>] &lt;-<span class="st"> "Rainfall"</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>model<span class="op">$</span>hillslope[,<span class="st">'pet'</span>] &lt;-<span class="st"> </span>model<span class="op">$</span>channel[,<span class="st">'pet'</span>] &lt;-<span class="st"> "PET"</span></span></code></pre></div>
<p>The observed data can now be checked to ensure it is complete and contains the correct series for the model</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>req_series &lt;-<span class="st"> </span><span class="kw"><a href="../reference/check_model.html">check_model</a></span>(model)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="kw"><a href="../reference/check_obs.html">check_obs</a></span>(obs, req_series)</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">#&gt; $step</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">#&gt; [1] 900</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&gt; </span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">#&gt; $n_sub_step</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#&gt; </span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co">#&gt; $sub_step</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="co">#&gt; [1] 900</span></span></code></pre></div>
<p>From the return of <code>check_obs</code> we can see the time step of the data and default number of sub time steps used in the model evaluation which is discussed later.</p>
</div>
<div id="running-dynamic-topmodel" class="section level1">
<h1 class="hasAnchor">
<a href="#running-dynamic-topmodel" class="anchor"></a>Running dynamic TOPMODEL</h1>
<p>The model can be run with the data using the <code>dyantop</code> command.</p>
<pre><code>model &lt;- band_model(

```r
## recharge rate for initialization
initial_recharge &lt;- as.numeric(obs[1,'Flow'])/sum(model$hillslope$area)
## running the model
sim_1 &lt;- dynatop(model,obs,initial_recharge)</code></pre>
<p>The returned object from <code>dynatop</code> is a list with two elements</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(sim_<span class="dv">1</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co">#&gt; [1] "model"         "channel_input"</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(sim_<span class="dv">1</span><span class="op">$</span>model)</span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co">#&gt; [1] "hillslope"    "channel"      "param"        "Fsz"          "Fsf"         </span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="co">#&gt; [6] "gauge"        "point_inflow"</span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(sim_<span class="dv">1</span><span class="op">$</span>channel_input)</span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="co">#&gt; Warning: timezone of object (GMT) is different than current timezone ().</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="co">#&gt;                               1          2          3          4            5</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="co">#&gt; 2009-11-18 16:00:00 0.006493732 0.01078219 0.01066088 0.01828940 0.0006271059</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="co">#&gt; 2009-11-18 16:15:00 0.011967656 0.02044665 0.01931403 0.03488403 0.0011738706</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="co">#&gt; 2009-11-18 16:30:00 0.013280989 0.02212535 0.02104127 0.03590251 0.0012351037</span></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="co">#&gt; 2009-11-18 16:45:00 0.013876046 0.02284558 0.02159161 0.03589700 0.0012427858</span></span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="co">#&gt; 2009-11-18 17:00:00 0.014903411 0.02397476 0.02291762 0.03638914 0.0012739815</span></span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="co">#&gt; 2009-11-18 17:15:00 0.015970724 0.02505575 0.02431476 0.03685801 0.0013025255</span></span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="co">#&gt;                              6           7           8            9         10</span></span>
<span id="cb15-16"><a href="#cb15-16"></a><span class="co">#&gt; 2009-11-18 16:00:00 0.01087642 0.008472328 0.005102228 0.0006293877 0.01408159</span></span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="co">#&gt; 2009-11-18 16:15:00 0.02055992 0.015767845 0.009948427 0.0011984751 0.02602571</span></span>
<span id="cb15-18"><a href="#cb15-18"></a><span class="co">#&gt; 2009-11-18 16:30:00 0.02135929 0.016693201 0.011326559 0.0012182542 0.02686204</span></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="co">#&gt; 2009-11-18 16:45:00 0.02145241 0.016841237 0.012588709 0.0012052381 0.02650040</span></span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="co">#&gt; 2009-11-18 17:00:00 0.02192722 0.017353533 0.014425185 0.0012082728 0.02671673</span></span>
<span id="cb15-21"><a href="#cb15-21"></a><span class="co">#&gt; 2009-11-18 17:15:00 0.02240090 0.017848385 0.016609824 0.0012110700 0.02691514</span></span>
<span id="cb15-22"><a href="#cb15-22"></a><span class="co">#&gt;                             11         12         13          14         15</span></span>
<span id="cb15-23"><a href="#cb15-23"></a><span class="co">#&gt; 2009-11-18 16:00:00 0.03464596 0.00848971 0.02314651 0.003897295 0.01662448</span></span>
<span id="cb15-24"><a href="#cb15-24"></a><span class="co">#&gt; 2009-11-18 16:15:00 0.06774658 0.01595209 0.04896345 0.007552490 0.03182436</span></span>
<span id="cb15-25"><a href="#cb15-25"></a><span class="co">#&gt; 2009-11-18 16:30:00 0.07929314 0.01631417 0.06094721 0.008284921 0.03673829</span></span>
<span id="cb15-26"><a href="#cb15-26"></a><span class="co">#&gt; 2009-11-18 16:45:00 0.08935392 0.01610817 0.07217611 0.008716029 0.04021306</span></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="co">#&gt; 2009-11-18 17:00:00 0.10255523 0.01617539 0.08486062 0.009270747 0.04484396</span></span>
<span id="cb15-28"><a href="#cb15-28"></a><span class="co">#&gt; 2009-11-18 17:15:00 0.11668393 0.01623535 0.09647808 0.009806332 0.04963497</span></span>
<span id="cb15-29"><a href="#cb15-29"></a><span class="co">#&gt;                              16         17          18         19</span></span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="co">#&gt; 2009-11-18 16:00:00 0.007406924 0.01813118 0.004357875 0.03829002</span></span>
<span id="cb15-31"><a href="#cb15-31"></a><span class="co">#&gt; 2009-11-18 16:15:00 0.013938577 0.03388995 0.009394053 0.07962820</span></span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="co">#&gt; 2009-11-18 16:30:00 0.014339902 0.03440770 0.012223060 0.10253210</span></span>
<span id="cb15-33"><a href="#cb15-33"></a><span class="co">#&gt; 2009-11-18 16:45:00 0.014234833 0.03369934 0.014955602 0.12438948</span></span>
<span id="cb15-34"><a href="#cb15-34"></a><span class="co">#&gt; 2009-11-18 17:00:00 0.014370911 0.03359422 0.018076145 0.14626097</span></span>
<span id="cb15-35"><a href="#cb15-35"></a><span class="co">#&gt; 2009-11-18 17:15:00 0.014496768 0.03348246 0.021020159 0.16378937</span></span></code></pre></div>
<p>which are an <code>xts</code> object of the flows to the channel HRUs at each time step and the model passed to the call augmented with the final states of the simulation.</p>
<p>In the above simulation the model was initialized using the flow at the start of the event and used the default time step, which is the time step of the input data. Sub stepping, that is using a finer numeric time step then the data can improve the stability and quality of the simulations. The &lt;&gt; parameter of the <code>dynatop</code> function can be used to implement this. For example</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>sim_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dynatop.html">dynatop</a></span>(model,obs,initial_recharge,<span class="dt">sim_time_step=</span><span class="dv">5</span><span class="op">*</span><span class="dv">60</span>)</span></code></pre></div>
<p>performs the same simulation with a 5 minute time step.</p>
<p>The output states of a simulation can be used to initialize the a subsequent simulation. We note in doing this that no checks are made of the simulation times periods or of the time steps used. For example</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>sim_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dynatop.html">dynatop</a></span>(sim_<span class="dv">1</span><span class="op">$</span>model,obs,<span class="dt">sim_time_step=</span><span class="dv">5</span><span class="op">*</span><span class="dv">60</span>,<span class="dt">use_states=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p>The effects of the different implementations can be seem in the following graph. Note that the discrepancy between the simulations and observed data is due in part to the absence of any channel routing.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(obs,<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(sim_<span class="dv">1</span><span class="op">$</span>channel_input)),</span>
<span id="cb18-2"><a href="#cb18-2"></a>                    <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(sim_<span class="dv">2</span><span class="op">$</span>channel_input)),</span>
<span id="cb18-3"><a href="#cb18-3"></a>             <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(sim_<span class="dv">3</span><span class="op">$</span>channel_input))</span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(out) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(obs),<span class="st">'sim_1'</span>,<span class="st">'sim_2'</span>,<span class="st">'sim_3'</span>)</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Flow'</span>,<span class="st">'sim_1'</span>,<span class="st">'sim_2'</span>,<span class="st">'sim_3'</span>)])</span></code></pre></div>
<p><img src="dynatop_files/figure-html/final_plot-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#checking-the-model">Checking the model</a></li>
      <li><a href="#altering-parameters">Altering parameters</a></li>
      <li><a href="#banding-the-model">Banding the model</a></li>
      <li><a href="#preparing-input-data">Preparing input data</a></li>
      <li><a href="#running-dynamic-topmodel">Running dynamic TOPMODEL</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul Smith, Peter Metcalfe.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
