<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Dynamic TOPMODEL • dynatop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Dynamic TOPMODEL">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatop.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Selected_References.html">Selected References</a>
    </li>
    <li>
      <a href="../articles/The_Model_Object.html">The Model Object</a>
    </li>
    <li>
      <a href="../articles/The_solution_of_Dynamic_TOPMODEL.html">The Dynamic TOPMODEL Implimentation</a>
    </li>
    <li>
      <a href="../articles/Time_Delay_Channel_Routing.html">Time Delay Channel Routing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatop">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using Dynamic TOPMODEL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatop/blob/master/../vignettes/dynatop.Rmd"><code>../vignettes/dynatop.Rmd</code></a></small>
      <div class="hidden name"><code>dynatop.Rmd</code></div>

    </div>

    
    
<p>The purpose of this vignette is to provide an outline of the steps needed to perform a Dynamic TOPMODEL simulation and introduce the formats of the data input and returned.</p>
<p>The data used in this example comes from Swindale and is contained within the package and can be loaded with</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dynatop)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co">#&gt; Registered S3 method overwritten by 'xts':</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">#&gt;   method     from</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">#&gt;   as.zoo.xts zoo</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"Swindale"</span>)</a></code></pre></div>
<p>which returns a variable <code>Swindale</code> with the following components:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(Swindale)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">#&gt; [1] "model" "obs"</span></a></code></pre></div>
<p>For better comparision with a likely analysis we seperate these into a model and observed data variables</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">swindale_model &lt;-<span class="st"> </span>Swindale<span class="op">$</span>model</a>
<a class="sourceLine" id="cb3-2" title="2">swindale_obs &lt;-<span class="st"> </span>Swindale<span class="op">$</span>obs</a></code></pre></div>
<div id="the-model-structure" class="section level1">
<h1 class="hasAnchor">
<a href="#the-model-structure" class="anchor"></a>The model structure</h1>
<p>A dynamic TOPMODEL is described in a list object. The list has the following elements</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(swindale_model)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co">#&gt; [1] "map"          "channel"      "hillslope"    "param"        "gauge"       </span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co">#&gt; [6] "point_inflow"</span></a></code></pre></div>
<p>which are described in <a href="https://waternumbers.github.io/dynatop/articles/The_Model_Object.html">associated vignette</a>. The <a href="https://waternumbers.github.io/dynatopGIS">dynatopGIS</a> package can be used for constructing models.</p>
</div>
<div id="preparing-input-data" class="section level1">
<h1 class="hasAnchor">
<a href="#preparing-input-data" class="anchor"></a>Preparing input data</h1>
<p>The input to the model is expected to take the form of an <code>xts</code> object with constant time step whose column names are found in the ‘precip’ and ‘pet’ columns of the HSU tables in the model. Helpful functions for creating and manipulating <code>xts</code> objects can be found [here]{<a href="http://rstudio-pubs-static.s3.amazonaws.com/288218_117e183e74964557a5da4fc5902fc671.html" class="uri">http://rstudio-pubs-static.s3.amazonaws.com/288218_117e183e74964557a5da4fc5902fc671.html</a>}, see also the <code>resample_xts</code> function in this package.</p>
<p>The discharge, precipitation and potential evapotranspiration (PET) inputs for Swindale and contained with <code>swindale_obs</code> on a 15 minute time step.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(swindale_obs)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">#&gt; Warning: timezone of object (GMT) is different than current timezone ().</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="co">#&gt;                     Flow Rainfall          PET</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co">#&gt; 2009-11-18 16:00:00 2.78    4e-04 8.878467e-06</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co">#&gt; 2009-11-18 16:15:00 2.80    2e-04 4.762229e-06</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="co">#&gt; 2009-11-18 16:30:00 2.85    4e-04 8.585708e-07</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">#&gt; 2009-11-18 16:45:00 2.94    2e-04 0.000000e+00</span></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">#&gt; 2009-11-18 17:00:00 3.02    2e-04 0.000000e+00</span></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="co">#&gt; 2009-11-18 17:15:00 3.15    2e-04 0.000000e+00</span></a></code></pre></div>
<p>Note the discharge is in <span class="math inline">\(m^{3}/s\)</span> while the precipitation and PET are in m accumulated over the timestep.</p>
<p>To use the data with the model we need to set the names of the time series within the model.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">swindale_model<span class="op">$</span>hillslope[,<span class="st">'precip'</span>] &lt;-<span class="st"> </span>swindale_model<span class="op">$</span>channel[,<span class="st">'precip'</span>] &lt;-<span class="st"> "Rainfall"</span></a>
<a class="sourceLine" id="cb6-2" title="2">swindale_model<span class="op">$</span>hillslope[,<span class="st">'pet'</span>] &lt;-<span class="st"> </span>swindale_model<span class="op">$</span>channel[,<span class="st">'pet'</span>] &lt;-<span class="st"> "PET"</span></a></code></pre></div>
</div>
<div id="altering-parameters" class="section level1">
<h1 class="hasAnchor">
<a href="#altering-parameters" class="anchor"></a>Altering parameters</h1>
<p>The parameter values are stored in the parameter vector <code>swindale_model$parameters</code>. Each parameter value has a unique name. In the current model the parameters are all set to their default values:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(swindale_model<span class="op">$</span>param)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co">#&gt; q_sfmax_default s_rzmax_default   s_rz0_default   ln_t0_default       m_default </span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">#&gt;             Inf           0.050           0.990          19.000           0.004 </span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">#&gt;     t_d_default    t_sf_default    v_ch_default </span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co">#&gt;          20.000         100.000         100.000</span></a></code></pre></div>
<p>The relationship between the parameters and the HRUs are given in the columns of the HRU tables e.g.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co">## unsaturated zone time constant</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>( swindale_model<span class="op">$</span>hillslope[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'id'</span>,<span class="st">'t_d'</span>)])</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">#&gt;   id         t_d</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">#&gt; 1 20 t_d_default</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">#&gt; 2 21 t_d_default</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">#&gt; 3 22 t_d_default</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">#&gt; 4 23 t_d_default</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">#&gt; 5 24 t_d_default</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">#&gt; 6 25 t_d_default</span></a></code></pre></div>
<p>Altering parameter values requires changing there values in the parameter vector. For this catchment all HRU have the same parameter values. This could be altered by changing parameter names in the HRU table and adding these parameters to the parameter vector.</p>
<p>In this case we change the parameter vectors to me more representative of the catchment</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">swindale_model<span class="op">$</span>param &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">q_sfmax_default=</span><span class="ot">Inf</span>,</a>
<a class="sourceLine" id="cb9-2" title="2">                 <span class="dt">m_default=</span><span class="fl">0.0063</span>,</a>
<a class="sourceLine" id="cb9-3" title="3">                 <span class="dt">ln_t0_default=</span><span class="fl">7.46</span>,</a>
<a class="sourceLine" id="cb9-4" title="4">                 <span class="dt">s_rz0_default=</span><span class="fl">0.98</span>,</a>
<a class="sourceLine" id="cb9-5" title="5">                 <span class="dt">s_rzmax_default=</span><span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb9-6" title="6">                 <span class="dt">v_ch_default=</span><span class="fl">0.8</span>,</a>
<a class="sourceLine" id="cb9-7" title="7">                 <span class="dt">t_d_default=</span><span class="dv">8</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>,</a>
<a class="sourceLine" id="cb9-8" title="8">                 <span class="dt">t_sf_default=</span><span class="fl">3.6e+05</span></a>
<a class="sourceLine" id="cb9-9" title="9">                 )</a></code></pre></div>
</div>
<div id="creating-the-dynatop-object" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-the-dynatop-object" class="anchor"></a>Creating the dynatop Object</h1>
<p>Simulations are performed by embeddign the model and the observed data into a <code>dynatop</code> object. First the object is created using the model in list form</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">ctch_mdl &lt;-<span class="st"> </span>dynatop<span class="op">$</span><span class="kw">new</span>(swindale_model)</a></code></pre></div>
<p>This step performs some basis checks on the model for conistency. The data can then be added</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">ctch_mdl<span class="op">$</span><span class="kw">add_data</span>(swindale_obs)</a></code></pre></div>
</div>
<div id="running-dynamic-topmodel" class="section level1">
<h1 class="hasAnchor">
<a href="#running-dynamic-topmodel" class="anchor"></a>Running dynamic TOPMODEL</h1>
<p>The model currently consists of two types of HSU; hillslope and channel. These can be run individually with the <code>sim_hillslope</code> and <code>sim_channel</code> methods of sequently with the <code>sim</code> method. The individual methods check that suitabel input data is available, but not how it was generated.</p>
<p>The initial states of the simulations can be specified in the model object. If, as in the case of this example, the states are not specified then any attempt to perform a simulation will fail.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">ctch_mdl<span class="op">$</span><span class="kw">sim</span>()</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">#&gt; Error in self$sim_hillslope(mass_check, keep_states, sub_step): Model states are not initialised</span></a></code></pre></div>
<p>The states need to be initialised using the <code>initialise</code> method which requires an initial recharge rate. In the following we initialse the states and plot the initial saturates zone storage, using the chaining of commands.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">ctch_mdl<span class="op">$</span><span class="kw">initialise</span>(<span class="fl">1e-6</span>)<span class="op">$</span><span class="kw">plot_state</span>(<span class="st">"s_sz"</span>)</a></code></pre></div>
<p><img src="dynatop_files/figure-html/initialise-1.png" width="700"></p>
<p>The simulation can now be performed and the flow at the gauge extracted with</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">sim1 &lt;-<span class="st"> </span>ctch_mdl<span class="op">$</span><span class="kw">sim</span>()<span class="op">$</span><span class="kw">get_gauge_flow</span>()</a></code></pre></div>
<p>Note that the states of the system are now those at the end of the simulation for example:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">ctch_mdl<span class="op">$</span><span class="kw">plot_state</span>(<span class="st">"s_sz"</span>)</a></code></pre></div>
<p><img src="dynatop_files/figure-html/new_states-1.png" width="700"></p>
<p>Rerunning the simulation with the new initial states will of course produce different results</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">sim2 &lt;-<span class="st"> </span>ctch_mdl<span class="op">$</span><span class="kw">sim</span>()<span class="op">$</span><span class="kw">get_gauge_flow</span>()</a>
<a class="sourceLine" id="cb16-2" title="2">out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(swindale_obs,sim1),sim2)</a>
<a class="sourceLine" id="cb16-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(out) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(swindale_obs),<span class="st">'sim_1'</span>,<span class="st">'sim_2'</span>)</a>
<a class="sourceLine" id="cb16-4" title="4"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(out[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Flow'</span>,<span class="st">'sim_1'</span>,<span class="st">'sim_2'</span>)])</a></code></pre></div>
<p><img src="dynatop_files/figure-html/sim2-1.png" width="700"></p>
<div id="mass-balance" class="section level2">
<h2 class="hasAnchor">
<a href="#mass-balance" class="anchor"></a>Mass balance</h2>
<p>It is possible to output the mass balance checks for each iteration of the simulation by running the <code>sim</code> or individual methods with the <code>mass_check</code> flag set to <code>TRUE</code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>( ctch_mdl<span class="op">$</span><span class="kw">initialise</span>(<span class="fl">1e-6</span>)<span class="op">$</span><span class="kw">sim</span>(<span class="dt">mass_check=</span><span class="ot">TRUE</span>)<span class="op">$</span><span class="kw">get_mass_errors</span>() )</a></code></pre></div>
<p><img src="dynatop_files/figure-html/mass_check-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#the-model-structure">The model structure</a></li>
      <li><a href="#preparing-input-data">Preparing input data</a></li>
      <li><a href="#altering-parameters">Altering parameters</a></li>
      <li><a href="#creating-the-dynatop-object">Creating the dynatop Object</a></li>
      <li>
<a href="#running-dynamic-topmodel">Running dynamic TOPMODEL</a><ul class="nav nav-pills nav-stacked">
<li><a href="#mass-balance">Mass balance</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul Smith, Peter Metcalfe.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
