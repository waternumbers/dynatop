<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Numerical Solution of Dynamic TOPMODEL • dynatop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="The Numerical Solution of Dynamic TOPMODEL">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatop.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Checks_of_the_Hillslope_HRU.html">Checks of the Hillslope HRU</a>
    </li>
    <li>
      <a href="../articles/Checks_of_the_Time_Delay_routing.html">Checks of the Time Delay Routing</a>
    </li>
    <li>
      <a href="../articles/Performance_Evaluation.html">Code Performance for larger simulations</a>
    </li>
    <li>
      <a href="../articles/Selected_References.html">Selected References</a>
    </li>
    <li>
      <a href="../articles/The_Model_Object.html">The Model Object</a>
    </li>
    <li>
      <a href="../articles/The_solution_of_Dynamic_TOPMODEL.html">The Numerical Solution of Dynamic TOPMODEL</a>
    </li>
    <li>
      <a href="../articles/Time_Delay_Channel_Routing.html">Time Delay Channel Routing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatop">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>The Numerical Solution of Dynamic TOPMODEL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatop/blob/master/../vignettes/The_solution_of_Dynamic_TOPMODEL.Rmd"><code>../vignettes/The_solution_of_Dynamic_TOPMODEL.Rmd</code></a></small>
      <div class="hidden name"><code>The_solution_of_Dynamic_TOPMODEL.Rmd</code></div>

    </div>

    
    
<p>The dynamic TOPMODEL R package implements a set of numerical solutions to the
governing equations of the dynamic TOPMODEL formulation. This vignette
documents the formulation and the numerical solutions used. It also outlines
a number of potential changes to the code which may improves it.</p>
<div id="notation-and-nomenclature" class="section level1">
<h1 class="hasAnchor">
<a href="#notation-and-nomenclature" class="anchor"></a>Notation and nomenclature</h1>
<p>Consider two types of Hydrological response unit (HRU). The first termed
“hill slope” solves the surface, root, unsaturated and saturated zones
for ‘similar’ areas of the catchment a each time step.
Table <a href="#tab:hru-notation">1</a> outlines the notation used for describing a
“hill slope” HRU.</p>
<table class="table">
<caption>
<span id="tab:hru-notation">Table 1: </span> Outline of notation for describing “hill slope”
HRUs</caption>
<thead><tr class="header">
<th align="left">Quantity type</th>
<th align="center">Symbol</th>
<th align="left">Description</th>
<th align="center">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Storage</td>
<td align="center"><span class="math inline">\(s_{ex}\)</span></td>
<td align="left">Surface excess storage</td>
<td align="center">m</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{rz}\)</span></td>
<td align="left">Root zone storage</td>
<td align="center">m</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{uz}\)</span></td>
<td align="left">Unsaturated zone storage</td>
<td align="center">m</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{sz}\)</span></td>
<td align="left">Saturated zone storage deficit</td>
<td align="center">m</td>
</tr>
<tr class="odd">
<td align="left">Vertical fluxes within HRU</td>
<td align="center"><span class="math inline">\(q_{rz}\)</span></td>
<td align="left">Flow from Root to unsaturated zone</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(q_{uz}\)</span></td>
<td align="left">Flow from unsaturated to saturated zone</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(q_{sz}\)</span></td>
<td align="left">Flow from saturated zone to surface excess storage</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left">Lateral down slope fluxes from HRU</td>
<td align="center"><span class="math inline">\(l_{ex}\)</span></td>
<td align="left">Total lateral flux from surface excess</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(l_{sz}\)</span></td>
<td align="left">Total lateral flux from saturated zone</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left">Other HRU properties</td>
<td align="center">a</td>
<td align="left">Area</td>
<td align="center">m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(w^{\left[i,j\right]}_{ex}\)</span></td>
<td align="left">fraction of <span class="math inline">\(l_{ex}\)</span> going from <span class="math inline">\(j\)</span>th to <span class="math inline">\(i\)</span>th HRU</td>
<td align="center">-</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(w^{\left[i,j\right]}_{sz}\)</span></td>
<td align="left">fraction of <span class="math inline">\(l_{sz}\)</span> going from <span class="math inline">\(j\)</span>th to <span class="math inline">\(i\)</span>th HRU</td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{rzmax}\)</span></td>
<td align="left">maximum root zone storage</td>
<td align="center">m</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(T_d\)</span></td>
<td align="left">Unsaturated zone time constant per m of saturated storage deficit.</td>
<td align="center">h/m</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(l_{szmax}\)</span></td>
<td align="left">Maximum lateral flux from saturated zone</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(T_{ex}\)</span></td>
<td align="left">Surface excess storage time constant</td>
<td align="center">h</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(m\)</span></td>
<td align="left">Exponential transmissivity constant</td>
<td align="center">- -</td>
</tr>
</tbody>
</table>
<p>The second, termed “chanel” represents the inflow to a length of river
channel. As such it acts as a sink collecting water from the “hill slope”
HRUs over the course of a time step. Table <a href="#tab:ch-notation">2</a> outlines
the notation for channel HRU.</p>
<table class="table">
<caption>
<span id="tab:ch-notation">Table 2: </span> Outline of notation for describing “channel”
HRUs</caption>
<thead><tr class="header">
<th></th>
<th align="right">Symbol D</th>
<th align="left">escription</th>
<th align="left">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Storage</td>
<td align="right"><span class="math inline">\(s_{ch}\)</span></td>
<td align="left">channel storage</td>
<td align="left">m</td>
</tr>
<tr class="even">
<td>Other HRU properties</td>
<td align="right">a</td>
<td align="left">Area</td>
<td align="left">m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td></td>
<td align="right"><span class="math inline">\(f^{\left[k,j\right]}_{ex}\)</span></td>
<td align="left">fraction of <span class="math inline">\(l_{ex}\)</span> going from <span class="math inline">\(j\)</span>th hill slope HRU to <span class="math inline">\(k\)</span>th channel HRU</td>
<td align="left">-</td>
</tr>
<tr class="even">
<td></td>
<td align="right"><span class="math inline">\(f^{\left[k,j\right]}_{sz}\)</span></td>
<td align="left">fraction of <span class="math inline">\(l_{sz}\)</span> going from <span class="math inline">\(j\)</span>th hill slope HRU to <span class="math inline">\(k\)</span>th HRU</td>
<td align="left">-</td>
</tr>
</tbody>
</table>
<p>From the above a mass conservative system will redirect all flows within the
defined catchment hence:
<span class="math display">\[\sum\limits_{j} w^{\left[j,i\right]} +
    \sum\limits_{k} f^{\left[k,i\right]} =1\]</span></p>
<p>Inputs to the system are given in Table [tab:inputs]. These are treated as
being the same for every HRU though the calculations readily allow for them to
vary by HRU.</p>
<table class="table">
<caption>
<span id="tab:inputs">Table 3: </span> Eternal inputs to HRUs</caption>
<thead><tr class="header">
<th align="center">Symbol</th>
<th align="left">Description</th>
<th align="center">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><span class="math inline">\(p\)</span></td>
<td align="left">Precipitation rate</td>
<td align="center">m/h</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\(e_p\)</span></td>
<td align="left">Potential evapotranspiration</td>
<td align="center">m/h</td>
</tr>
</tbody>
</table>
<p>Later we make use of the following:</p>
<ul>
<li><p>Superscript notation <span class="math inline">\(^{\left[i\right]}\)</span> to indicate the property of
the <span class="math inline">\(i\)</span>th HRU</p></li>
<li><p>Bold lower case letter to indicate the column vector of quantities from all
HRUs, e.g.
<span class="math inline">\(\mathbf{q}_{rz} = \left(q_{rz}^{\left[1\right]},\ldots,q_{rz}^{\left[n\right]}\right)^{T}\)</span></p></li>
<li><p>Bold uppercase letters to indicate matrices which may be diagonal if
the underlying variables is a vector (e.g. <span class="math inline">\(\mathbf{A}\)</span> is a
diagonal matrix of area) or dense (e.g. <span class="math inline">\(W_{sz}\)</span> where the <span class="math inline">\(j\)</span>th
element of the <span class="math inline">\(i\)</span>th row is <span class="math inline">\(w_{sz}^{\left[i,j\right]}\)</span>).</p></li>
<li><p>The identity matrix is written as <span class="math inline">\(\mathbf{I}\)</span>. The notation <span class="math inline">\(\mathbf{0}\)</span>
is used to indicate a matrix of vector of zeros whose size can be inferred
from its location.</p></li>
<li><p>The notation <span class="math inline">\(\left.x\right\rvert_t\)</span> to indicate the value of the
variable <span class="math inline">\(x\)</span> at time <span class="math inline">\(t\)</span></p></li>
<li><p>To illustrate some calculations intermediate evaluations variables are
computed. To distinguish these a <span class="math inline">\(\tilde{}\)</span> is used. For example
<span class="math inline">\(\tilde{q}_{rz}\)</span> is an intermediate value in the computation of
<span class="math inline">\(q_{rz}\)</span>. In some cases these values may evolve across multiple
steps. Where needed the superscript <span class="math inline">\(^\left[-\right]\)</span> will be used to
indicate the value at the start of the step and <span class="math inline">\(^\left[+\right]\)</span> that at
the end.</p></li>
</ul>
</div>
<div id="numerical-solution" class="section level1">
<h1 class="hasAnchor">
<a href="#numerical-solution" class="anchor"></a>Numerical Solution</h1>
<p>The numerical solution implemented in the dynamic TOPMODEL code is based
on solving the ODE(s) governing the evolution of each of the stores in the
HRUs sequentially while approximating the flux between then.</p>
<p>The following sections present the solutions to the governing equations
in the order they are currently solved in the code for given time
step <span class="math inline">\(\Delta t\)</span> (hr) starting at time <span class="math inline">\(t\)</span> over which the input fluxes (<span class="math inline">\(p\)</span> and <span class="math inline">\(e_p\)</span>) are
taken to be constant.</p>
<div id="step-1-initializing-the-channel-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1-initializing-the-channel-storage" class="anchor"></a>Step 1: Initializing the channel storage</h2>
<p>The channel acts as a sink with no outflows. For a single reach:
<span class="math display">\[a^{\left[k\right]}\frac{ds^{\left[k\right]}_{ch}}{dt} = 
    \sum\limits_{j} f^{\left[k,j\right]}_{ex}a^{\left[j\right]}l^{\left[j\right]}_{ex}
    + \sum\limits_{j} f^{\left[k,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a^{\left[k\right]}p\]</span>
For all channel reaches this can be written in matrix form as
<span class="math display">\[\mathbf{A}_{ch}\frac{d\mathbf{s}_{ch}}{dt} = 
    \mathbf{F}_{ex}\mathbf{A}\mathbf{l}_{ex}
    + \mathbf{F}_{sz}\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{A}_{ch}p\]</span>
or equivalently
<span class="math display">\[\frac{d\mathbf{s}_{ch}}{dt} = 
    \mathbf{A}^{-1}_{ch}\mathbf{F}_{ex}\mathbf{A}\mathbf{l}_{ex}
    + \mathbf{A}_{ch}^{-1}\mathbf{F}_{sz}\mathbf{A}\mathbf{l}_{sz}
    +p\]</span></p>
<p>The solution presumes that <span class="math inline">\(\left.\mathbf{s}_{ch}\right\rvert_{t}=\mathbf{0}\)</span>
with the integral of each of the summed terms being evaluated individually to
give the total <span class="math inline">\(\left.\mathbf{s}_{ch}\right\rvert_{t+\Delta t}\)</span>.
The easiest of these terms to integrate is the precipitation input which gives
<span class="math display">\[ \tilde{\mathbf{s}}_{ch} = \mathbf{I}p\Delta t \]</span></p>
</div>
<div id="step-2-surface-excess-redistribution" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2-surface-excess-redistribution" class="anchor"></a>Step 2: Surface excess redistribution</h2>
<p>For the <span class="math inline">\(i\)</span>th hill slope HRU the alteration of the surface excess store is
given by
<span class="math display">\[ a^{\left[i\right]}\frac{ds^{\left[i\right]}_{ex}}{dt} =  \left(w^{\left[i,i\right]}_{ex}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{ex}
    + \sum\limits_{j \neq i} w^{\left[i,j\right]}_{ex}a^{\left[j\right]}l^{\left[j\right]}_{ex}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz}
    \]</span>
For all the hill slope HRU this can be expressed as:
<span class="math display">\[\mathbf{A}\frac{d\mathbf{s}_{ex}}{dt} =  \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{ex}
    + \mathbf{A}\mathbf{q}_{sz}\]</span>
The surface excess store also passes water to the channel. Let <span class="math inline">\(\mathbf{y}\)</span> be
the contribution to the channel storage from surface excess and
<span class="math display">\[ \mathbf{x} = \left[ \begin{array}{c} \mathbf{s}_{ex} \\
                       \mathbf{y} \end{array}\right] \]</span>
This allows the evolution of <span class="math inline">\(\mathbf{x}\)</span> to be written as
<span class="math display">\[
\left[ \begin{array}{cc} \mathbf{A} &amp; \mathbf{0} \\
         \mathbf{0} &amp; \mathbf{A}_{ch} \end{array} \right]
     \frac{d\mathbf{x}}{dt} =
          \left[ \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A} \\
              \mathbf{F}_{ex}\mathbf{A} \end{array}\right]
          \mathbf{l}_{ex} +
          \left[ \begin{array}{cc} \mathbf{A} &amp; \mathbf{0} \\
                   \mathbf{0} &amp; \mathbf{A}_{ch} \end{array} \right]
               \left[ \begin{array}{c} \mathbf{q}_{sz} \\
                       \mathbf{0} \end{array}\right]
\]</span></p>
<p>Assuming that there are minimal non-linearities the surface excess stores of
the hill slope HRUs are taken to be linear tanks with
<span class="math inline">\(l^{\left[i\right]}_{ex} = \frac{1}{T_{ex}} s^{\left[i\right]}_{ex}\)</span></p>
<p>Substitution of the flow storage relationship and rearrangement gives
<span class="math display">\[
     \frac{d\mathbf{x}}{dt} =
     \left[ \begin{array}{cc} \mathbf{A} &amp; \mathbf{0} \\
         \mathbf{0} &amp; \mathbf{A}_{ch} \end{array} \right]^{-1}
          \left[ \begin{array}{cc}
          \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{T}^{-1}_{ex} \\
              \mathbf{F}_{ex}\mathbf{A}\mathbf{T}^{-1}_{ex} \end{array} &amp; \mathbf{0} \end{array}
              \right]
          \mathbf{x} +
               \left[ \begin{array}{c} \mathbf{q}_{sz} \\
                       \mathbf{0} \end{array}\right]
\]</span></p>
<p>The solution of this is carried out through two stages. The first
stage redistributes the surface excess storage <span class="math inline">\(\left.\mathbf{s}_{ex}\right\rvert_{t}\)</span> between the
hill slope and channel HRUs on the presumption that there is no inflow
(<span class="math inline">\(\mathbf{q}_{sz}=\mathbf{0}\)</span>). The second stage, carried out in later steps
adds the inflow term.</p>
<p>Specifically letting
<span class="math display">\[ \tilde{\mathbf{x}} = \left[ \begin{array}{c} \tilde{\mathbf{s}}_{ex} \\
                       \tilde{\mathbf{s}}_{ch} \end{array} \right] \]</span>
the ODE initial condition problem
<span class="math display">\[\frac{d\mathbf{x}}{dt}=\left[ \begin{array}{cc} \mathbf{A} &amp; \mathbf{0} \\
         \mathbf{0} &amp; \mathbf{A}_{ch} \end{array} \right]^{-1}
          \left[ \begin{array}{cc}
          \begin{array}{c} \left(\mathbf{W}_{ex}-\mathbf{I}\right)\mathbf{A}\mathbf{T}^{-1}_{ex} \\
              \mathbf{F}_{ex}\mathbf{A}\mathbf{T}^{-1}_{ex} \end{array} &amp; \mathbf{0} \end{array}
              \right]
          \mathbf{x} \quad \mathbf{x}_{0} = \left[\begin{array}{c}
                                                    \left.\mathbf{s}_{ex}\right\rvert_t
\\ \tilde{\mathbf{s}}_{cg}^{\left[-\right]}\end{array}\right]\]</span>
is solve using the eigenvalue method to give
<span class="math display">\[
\left[\begin{array}{c} \tilde{s}_{ex} \\
\tilde{\mathbf{s}}_{ch}^{\left[+\right]} \end{array}\right]
\]</span>
an intermediate solution to the surface excess and channel storage through the
redistribution of the initial surface excess water.</p>
<div id="comments" class="section level3">
<h3 class="hasAnchor">
<a href="#comments" class="anchor"></a>Comments</h3>
<ol style="list-style-type: decimal">
<li>The flow to the channel is possibly underestimated since <span class="math inline">\(\mathbf{q}_{sz}\)</span>
may be positive.</li>
<li>The possible inflow to the surface store from the root zone is not
currently included in the description since it is unclear if this is a
numeric or conceptual feature.</li>
<li>Since the only interaction between the other stores and the surface excess
is <span class="math inline">\(\mathbf{q}_{sz}\)</span> this step could be evaluated later with an estimate
of <span class="math inline">\(\mathbf{q}_{sz}\)</span>
</li>
</ol>
</div>
</div>
<div id="step-3-root-zone" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3-root-zone" class="anchor"></a>Step 3: Root Zone</h2>
<p>For a single HRU
<span class="math display">\[\frac{ds_{rz}}{dt}=p-\frac{s_{rx}}{s_{rzmax}}e_{p}-q_{rz}\]</span> where
<span class="math display">\[q_{rz} = \left\{ \begin{array}{cc}
    0 &amp; s_{rx} \leq s_{rzmax}\\
    p-\frac{s_{rx}}{s_{rzmax}}e_{p} &amp; s_{rx} &gt; s_{rzmax}
    \end{array} \right.\]</span></p>
<p>The root zone is solved as a two step process. Firstly the ODE
<span class="math display">\[\frac{d\tilde{s}_{rz}}{dt}=p-\frac{e_{p}}{s_{rzmax}}\tilde{s}_{rz} \quad  \left. \tilde{s}_{rz}\right\rvert_{t} = \left. s_{rz}\right\rvert_{t}\]</span>
to give <span class="math display">\[\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} = 
    \left. s_{rz}\right\rvert_{t} \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta t\right) + p\frac{ s_{srmax}}{e_p}\left(1 - \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta t\right)\right)\]</span>
which can be though off as the unconstrained root zone storage. Then
from this
<span class="math display">\[\left. s_{rz}\right\rvert_{t + \Delta t} = \min\left(\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t}, s_{rzmax}\right)\]</span>
and the total water passed from the root zone is
<span class="math inline">\(\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} - \left. s_{rz}\right\rvert_{t + \Delta t}\)</span>.</p>
<p>The water passed from the root zone can be passed wither to the surface excess
storage or the unsaturated zone. If <span class="math inline">\(\left. s_{sd}\right\rvert_{t} = 0\)</span> the water is passed to the
surface excess store, that is
<span class="math display">\[ \tilde{s}_{ex}^{\left[+\right]} =
   \tilde{s}_{ex}^{\left[-\right]} +
 \left.\tilde{s}_{rz}\right\rvert_{t + \Delta t} -
 \left. s_{rz}\right\rvert_{t + \Delta t}\]</span>
and <span class="math inline">\(\int_{\Delta t} q_{rz} dt = 0\)</span>, otherwise
<span class="math display">\[\int_{\Delta t} q_{rz} dt = \left. \tilde{s}_{rz}\right\rvert_{t + \Delta
  t} - \left. s_{rz}\right\rvert_{t + \Delta t}\]</span>
and <span class="math inline">\(\tilde{s}_{ex}^{\left[+\right]} = \tilde{s}_{ex}^{\left[-\right]}\)</span></p>
<div id="comments-1" class="section level3">
<h3 class="hasAnchor">
<a href="#comments-1" class="anchor"></a>Comments</h3>
<ol style="list-style-type: decimal">
<li>The assigning of the water from the root zone to either the excess storage
or unsaturated zone can be considered in two ways:
<ul>
<li>a conceptual choice indicating the belief that this water is distributed
with the surface rather then saturated zone lateral fluxes.</li>
<li>a method of ensuring a suitable numerical solution in the unsaturated
zone when there is no saturated deficit (see comments below).</li>
</ul>
</li>
</ol>
</div>
</div>
<div id="step-4-unsaturated-zone" class="section level2">
<h2 class="hasAnchor">
<a href="#step-4-unsaturated-zone" class="anchor"></a>Step 4: Unsaturated Zone</h2>
<p>For a single HRU the unsaturated zone representation of a non-linear tank whose time
constant is dependent upon the saturation deficit:
<span class="math display">\[\frac{ds_{uz}}{dt}=q_{rz}-\frac{s_{uz}}{s_{sz}T_{d}}\]</span></p>
<p>The formulation does not admit a simple solution. The current code implements
an explicit solution presuming that all the water passed from the root zone is
available for flow to the saturated zone. Computationally the following
steps are performed:</p>
<ul>
<li><p>Add inflow from the root zone to give
<span class="math inline">\(\tilde{s}_{uz} = \left. s_{uz}\right\rvert_{t} + \int_{\Delta t} q_{rz} dt\)</span></p></li>
<li><p>Compute <span class="math inline">\(q_{uz} = \left\{ \begin{array}{cc}  \min\left(  \frac{\tilde{s}_{uz}}{\left. s_{sz}\right\rvert_{t}T_d}, \frac{\tilde{s}_{uz}}{\Delta t}\right) &amp; \left. s_{sz}\right\rvert_{t} &gt;0 \\ 0 &amp; \mathrm{otherwise} \end{array}\right.\)</span></p></li>
<li><p>Set
<span class="math inline">\(\left. s_{uz}\right\rvert_{t+\Delta t} = \tilde{s}_{uz} - q_{uz} \Delta t\)</span></p></li>
</ul>
<div id="comments-2" class="section level3">
<h3 class="hasAnchor">
<a href="#comments-2" class="anchor"></a>Comments</h3>
<ol style="list-style-type: decimal">
<li><p>The approximation above can result in water being left in the
unsaturated zone if the later step makes <span class="math inline">\(s_{sz}=0\)</span> while
<span class="math inline">\(s_{uz} &gt; 0\)</span>. This may motivate the “switch” in where the outflow
from the root zone goes.</p></li>
<li><p>It is unclear why <span class="math inline">\(q_{uz}=0\)</span> when <span class="math inline">\(\left.s_{sz}\right\rvert_{t} = 0\)</span>. Setting
<span class="math inline">\(q_{uz} = \frac{\tilde{s}_{uz}}{\Delta t}\)</span> in this situation would ensure the unsaturated
zone is drained into the saturated zone. It would also allow the removal
of the “switch” in the root zone outflow if implemented for numerical reasons.</p></li>
<li><p>An alternative solution more in keeping with that for the root zone is to approximate the
solution to the governing ODE by the solution to
<span class="math display">\[\frac{d\tilde{s}_{uz}}{dt}= \frac{1}{\Delta t}\int_{\Delta t} q_{rz} dt - \frac{\tilde{s}_{uz}}{\left.s_{sz}\right\rvert_{t}T_{d}} \quad \left.\tilde{s}_{uz}\right\rvert_{t} = \left.s_{uz}\right\rvert_{t}\]</span>
which is given by <span class="math display">\[\left.s_{uz}\right\rvert_{t+\Delta t} = 
        \left.s_{uz}\right\rvert_{t}\exp\left(-\frac{\Delta t}{\left. s_{sz}\right\rvert_{t}T_d}\right)+\frac{1}{\Delta t}\int_{\Delta t} q_{rz} dt\left. s_{sz}\right\rvert_{t}T_d\left(1 - \exp\left(-\frac{\Delta t}{\left. s_{sz}\right\rvert_{t}T_d}\right)\right)\]</span>.
Mass balance then gives
<span class="math display">\[\int_{\Delta t} q_{uz} dt =  \left.s_{uz}\right\rvert_{t} + \int_{\Delta t} q_{rz} dt - \left.s_{uz}\right\rvert_{t+\Delta t}\]</span>
This solution behaves appropriately as the saturated zone wets and
negates the need to pass the flux from the root zone directly to the
surface excess for numerical reasons.</p></li>
</ol>
</div>
</div>
<div id="step-5-saturated-zone" class="section level2">
<h2 class="hasAnchor">
<a href="#step-5-saturated-zone" class="anchor"></a>Step 5: Saturated Zone</h2>
<p>For the <span class="math inline">\(i\)</span>th hill slope HRU the change in saturated zone storage deficit is
given by
<span class="math display">\[a^{\left[i\right]}\frac{ds^{\left[i\right]}_{sz}}{dt} = -a^{\left[i\right]}q^{\left[i\right]}_{uz} - \left(w^{\left[i,i\right]}_{sz}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{sz}
    - \sum\limits_{j \neq i} w^{\left[i,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz}\]</span>
For the assumed exponential transmissivity profile:
<span class="math display">\[\frac{dl^{\left[i\right]}_{sz}}{dt} = -\frac{l^{\left[i\right]}_{sz}}{m}\frac{ds^{\left[i\right]}_{sz}}{dt}\]</span>
which gives
<span class="math display">\[-a^{\left[i\right]}\frac{m}{l^{\left[i\right]}_{sz}}\frac{dl^{\left[i\right]}_{sz}}{dt}
    = -a^{\left[i\right]}q^{\left[i\right]}_{uz} - \left(w^{\left[i,i\right]}_{sz}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{sz}
    - \sum\limits_{j \neq i} w^{\left[i,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz}
    + a^{\left[i\right]}q^{\left[i\right]}_{sz}\]</span></p>
<p>The flux <span class="math inline">\(q^{\left[i\right]}_{sz}\)</span> ensures that
<span class="math inline">\(s^{\left[i\right]}_{sz} \geq 0\)</span> and
<span class="math inline">\(l^{\left[i\right]}_{sz} \leq l^{\left[i\right]}_{szmax}\)</span>. Thus if
<span class="math inline">\(s^{\left[i\right]}_{sz} = 0\)</span> or
<span class="math inline">\(l^{\left[i\right]}_{sz} = l^{\left[i\right]}_{szmax}\)</span> then
<span class="math display">\[a^{\left[i\right]}q^{\left[i\right]}_{sz} = 
    \min\left( a^{\left[i\right]}q^{\left[i\right]}_{uz} + \left(w^{\left[i,i\right]}_{sz}-1\right)a^{\left[i\right]}l^{\left[i\right]}_{sz}
    + \sum\limits_{j \neq i} w^{\left[i,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz},0\right)\]</span>
but is zero otherwise.</p>
<p>Combining the above equations for all hill Slope HRUs gives
<span class="math display">\[\mathbf{A}\frac{d\mathbf{s}_{sz}}{dt} = -\mathbf{A}\mathbf{q}_{uz} - \left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{A}\mathbf{q}_{sz}\]</span> which simplifies to
<span class="math display">\[\frac{d\mathbf{s}_{sz}}{dt} = -\mathbf{q}_{uz} - \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{q}_{sz}\]</span></p>
<p>Substituting the transmissivity relationship gives
<span class="math display">\[-\mathbf{L}^{-1}_{sz}\mathbf{M}\frac{d\mathbf{l}_{sz}}{dt} = -\mathbf{q}_{uz} - \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
    + \mathbf{q}_{sz}\]</span></p>
<p>The solution of these limited joint set of ODEs are not trivial. The current
solution numerically solves the ODE problem
<span class="math display">\[-\mathbf{L}^{-1}_{sz}\mathbf{M}\frac{d\mathbf{l}_{sz}}{dt} =
  -\mathbf{q}_{uz} -
  \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}
  \]</span>
subject to the constraints <span class="math inline">\(\frac{dl_{sz}^{\left[i\right]}}{dt} \leq 0\)</span> if
<span class="math inline">\(l_{sz}^{\left[i\right]}=l_{szmax}^{\left[i\right]}\)</span> with initial conditions
<span class="math inline">\(\left.\mathbf{l}_{sz}\right\rvert_{t}\)</span> to give
<span class="math inline">\(\left.\mathbf{l}_{sz}\right\rvert_{t+\Delta t}\)</span> using the lsoda algorithm in the
 package. The flows from the
saturated zone to the surface excess storage is estimated from these as
<span class="math display">\[
  \mathbf{q}_{sz} =
  \max\left(\mathbf{A}^{-1}\left(
  \mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\left.\mathbf{l}_{sz}\right\rvert_{t+\Delta
  t}+\mathbf{q}_{uz},
  \mathbf{0}\right)
  \]</span>
where the maximum is taken element wise.</p>
<p>Then an initial estimate of the storage deficit is given by
<span class="math display">\[ \tilde{\mathbf{s}}_{sz} = \left. \mathbf{s}_{sz}\right\rvert_{t} +
 \Delta t \left.\frac{d\mathbf{s}_{sz}}{dt}\right\rvert_{t+\Delta t} \]</span>
where the gradient term is evaluated as
<span class="math display">\[ \left.\frac{d\mathbf{s}_{sz}}{dt}\right\rvert_{t+\Delta t}=
 -\mathbf{q}_{uz} -
 \mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\left.\mathbf{l}_{sz}\right\rvert_{t
   + \Delta t}
    + \left.\mathbf{q}_{sz}\right\rvert_{t
   + \Delta t}\]</span></p>
<p>The resulting saturated storage deficit is computed from this as
<span class="math display">\[
  \left.\mathbf{s}_{sz}\right\rvert_{t + \Delta t} =
  \max\left( \tilde{\mathbf{s}}_{sz},
  \mathbf{0}\right)
  \]</span></p>
<p>The final estimate of the surface excess store can now be computed by adding
the volume of water coming from the saturated zone to give
<span class="math display">\[
\left.\mathbf{s}_{ex}\right\rvert_{t+\Delta t} =
\tilde{\mathbf{s}}_{ex} + \Delta t \left.\mathbf{q}_{sz}\right\rvert_{t+\Delta
t} +
\left.\mathbf{s}_{sz}\right\rvert_{t + \Delta t} - \tilde{\mathbf{s}}_{sz}
\]</span></p>
<p>The flow from the saturated zone to the river channels is used to give
<span class="math display">\[
\left.\mathbf{s}_{ch}\right\rvert_{t+\Delta t} =
\tilde{\mathbf{s}}_{ch} + \Delta t \mathbf{F}_{sz} \left.\mathbf{l}_{sz}\right\rvert_{t+\Delta
t}\]</span></p>
<div id="comments-3" class="section level3">
<h3 class="hasAnchor">
<a href="#comments-3" class="anchor"></a>Comments</h3>
<ol style="list-style-type: decimal">
<li>The most computationally intensive part of evaluating the gradients
required in the numerical solution is evaluating
<span class="math inline">\(\mathbf{q}_{sz}\)</span> is the evaluation of
<span class="math inline">\(\mathbf{A}^{-1}\left(\mathbf{W}_{sz}-\mathbf{I}\right)\mathbf{A}\mathbf{l}_{sz}\)</span>. However
this only needs to be evaluated once to get both the flux and storage
gradient terms
and <span class="math inline">\(\mathbf{q}_{sz}\)</span>. This suggests that a potentially more accurate numerical
solution using the  package to integrate for <span class="math inline">\(\mathbf{l}_{sz}\)</span>, <span class="math inline">\(\mathbf{s}_{sz}\)</span> and the integral of
<span class="math inline">\(\mathbf{q}_{sz}\)</span> may not be that much more computationally expensive.</li>
<li>An alternative approximate solution can be derived by ignoring the limits
on the flux and storage (hence <span class="math inline">\(\mathbf{q}_{sz}\)</span>) and solving the resulting
multivariate non-homogeneous ODE problem for estimates of <span class="math inline">\(\mathbf{l}_{sz}\)</span>
and <span class="math inline">\(\mathbf{s}_{sz}\)</span>. These could then be corrected with an implicit
estimate of <span class="math inline">\(\mathbf{q}_{sz}\)</span> similar to that above.</li>
</ol>
</div>
</div>
<div id="step-6-estimating-channel-flow" class="section level2">
<h2 class="hasAnchor">
<a href="#step-6-estimating-channel-flow" class="anchor"></a>Step 6: Estimating Channel Flow</h2>
<p>The average flow to the channels over the time step in cumecs is given by
<span class="math display">\[\frac{ \mathbf{A}_{ch} \left.\mathbf{s}_{ch}\right\rvert_{t+\Delta t}}{3600\Delta t}\]</span></p>
</div>
</div>
<div id="ordinary-differential-equations-solutions" class="section level1">
<h1 class="hasAnchor">
<a href="#ordinary-differential-equations-solutions" class="anchor"></a>Ordinary Differential Equations Solutions</h1>
<p>For completeness the solutions to the ODEs made use of above are
documented here.</p>
<div id="single-variable-non-homogeneous-ode-with-constant-input" class="section level2">
<h2 class="hasAnchor">
<a href="#single-variable-non-homogeneous-ode-with-constant-input" class="anchor"></a>Single variable non-homogeneous ODE with constant input</h2>
<p>The initial condition
problem<span class="math display">\[\frac{dx\left(t\right)}{dt} = a - b x\left(t\right) \quad x\left(0\right) = x_0\]</span>
or more compactly
<span class="math display">\[x^{\prime}\left(t\right) = a - b x\left(t\right) \quad x\left(t_0\right) = x_0\]</span>
involves the solution of first order linear system. This can be solved
explicitly using an ‘integrating factor’. Let
<span class="math inline">\(\mu = \exp\left(\int\limits_t b dt\right) = \exp\left(bt\right)\)</span>.
Multiplying both sides by <span class="math inline">\(\mu\)</span> then integrating (noting the LHS is the
result of the product formula in differentiation) gives
<span class="math display">\[\exp\left(bt\right) x = \int\limits_{t} a\exp\left(bt\right) dt = \frac{a}{b}\exp\left(bt\right) + K\]</span>
The constant <span class="math inline">\(K\)</span> can be evaluates using the initial conditions as
<span class="math inline">\(K=x_{0}-\frac{a}{b}\)</span>. Substitution and rearrangement then gives
<span class="math display">\[x = x_{0}\exp\left(-bt\right) + \frac{a}{b}\left(1-\exp\left(-bt\right)\right)\]</span>
Note that <span class="math display">\[\begin{array}{c}
        x\rightarrow0 \quad\mathrm{as}\quad b\rightarrow\infty\\
        x\rightarrow x_{0} + at \quad\mathrm{as}\quad b\rightarrow0\\
    \end{array}\]</span></p>
</div>
<div id="multiple-variable-homogeneous-ode" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-variable-homogeneous-ode" class="anchor"></a>Multiple variable homogeneous ODE</h2>
<p>The solution to the initial value problem
<span class="math display">\[\frac{d\mathbf{x}\left(t\right)}{dt} = \mathbf{A} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0\]</span>
or more compactly
<span class="math display">\[\mathbf{x}^{\prime}\left(t\right) = \mathbf{A} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0\]</span>
is computed using the eigen value method.</p>
<p>Suppose <span class="math inline">\(\mathbf{x}\)</span> is of length <span class="math inline">\(n\)</span> and <span class="math inline">\(\mathbf{A}\)</span> has suitably unique eigen values
<span class="math inline">\(\mathbf{\lambda}\)</span>. Taking <span class="math inline">\(\mathbf{M}\)</span> to be the matrix of eigen vectors
<span class="math display">\[
\mathbf{x}\left(t\right) = \mathbf{M} \left[\begin{array}{c}
c_1 \exp\left(\lambda_1t\right) \\
\vdots \\
c_n \exp\left(\lambda_nt\right)
\end{array}
\right]
\]</span>
where the constant <span class="math inline">\(\mathbf{c}\)</span> can be estimated from the initial conditions
at time 0 as
<span class="math display">\[ \mathbf{c} = \mathbf{M}^{-1} \mathbf{x}_{0} \]</span></p>
<!-- By the method of “Variation of Parameters for Systems” the solution to -->
<!-- the initial value problem -->
<!-- $$\frac{d\mathbf{x}\left(t\right)}{dt} = \mathbf{a} - \mathbf{B} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$ -->
<!-- or more compactly -->
<!-- $$\mathbf{x}^{\prime}\left(t\right) = \mathbf{a} - \mathbf{B} \mathbf{x}\left(t\right) \quad \mathbf{x}\left(t_0\right) = \mathbf{x}_0$$ -->
<!-- is given by -->
<!-- $$\mathbf{x}\left(t\right) = e^{\mathbf{B}t}\mathbf{x}_0 + e^{\mathbf{B}t}\int_{t_0}^{t} e^{r\mathbf{B}} \mathbf{a} dr$$ -->
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#notation-and-nomenclature">Notation and nomenclature</a></li>
      <li>
<a href="#numerical-solution">Numerical Solution</a><ul class="nav nav-pills nav-stacked">
<li><a href="#step-1-initializing-the-channel-storage">Step 1: Initializing the channel storage</a></li>
      <li><a href="#step-2-surface-excess-redistribution">Step 2: Surface excess redistribution</a></li>
      <li><a href="#step-3-root-zone">Step 3: Root Zone</a></li>
      <li><a href="#step-4-unsaturated-zone">Step 4: Unsaturated Zone</a></li>
      <li><a href="#step-5-saturated-zone">Step 5: Saturated Zone</a></li>
      <li><a href="#step-6-estimating-channel-flow">Step 6: Estimating Channel Flow</a></li>
      </ul>
</li>
      <li>
<a href="#ordinary-differential-equations-solutions">Ordinary Differential Equations Solutions</a><ul class="nav nav-pills nav-stacked">
<li><a href="#single-variable-non-homogeneous-ode-with-constant-input">Single variable non-homogeneous ODE with constant input</a></li>
      <li><a href="#multiple-variable-homogeneous-ode">Multiple variable homogeneous ODE</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Paul Smith, Peter Metcalfe.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
