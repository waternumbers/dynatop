<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Dynamic TOPMODEL equations • dynatop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="The Dynamic TOPMODEL equations">
<meta property="og:description" content="dynatop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.101</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatop.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Notes_on_the_implimentation.html">UNKNOWN TITLE</a>
    </li>
    <li>
      <a href="../articles/Selected_References.html">Selected References</a>
    </li>
    <li>
      <a href="../articles/The_Model_Object.html">The Model Object</a>
    </li>
    <li>
      <a href="../articles/The_solution_of_Dynamic_TOPMODEL.html">The Dynamic TOPMODEL equations</a>
    </li>
    <li>
      <a href="../articles/Time_Delay_Channel_Routing.html">Time Delay Channel Routing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatop/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>The Dynamic TOPMODEL equations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatop/blob/master/../vignettes/The_solution_of_Dynamic_TOPMODEL.Rmd"><code>../vignettes/The_solution_of_Dynamic_TOPMODEL.Rmd</code></a></small>
      <div class="hidden name"><code>The_solution_of_Dynamic_TOPMODEL.Rmd</code></div>

    </div>

    
    
<p>The <code>dynatop</code> package represents an implimentation of the concepts behind a dynamic TOPMODEL.
One of the underlying principles of dynamic TOPMODEL is that the landscape can be broken up into
hydrologically similar regions, or Hydrological Similarity Units (HSUs), where
all the area within a HSU behaves in a hydrologically similar fashion.</p>
<p>While a Hydrological Similarity Unit (HSU) has typically been thought of as an
area of hillslope with, for example, simliar topgraphic, soil and upslope area
characteristics the idea may be generalised. In doing this a catchments is
concpetualised as a collection of HSUs of different type (e.g. hill slope,
channel, lake) which exchange fluxes at specified levels (e.g. saturated zone,
surface)</p>
<p>As well as the exchange of fluxes this documents considers two types of HSU. The first termed
“hill slope” solves the surface, root, unsaturated and saturated zones
for ‘similar’ areas of hill slope the catchment a each time step.
The second termed “channel” represents a length of river channel in a
simplified manner allowing the extraction of the inflow from the hillslope.</p>
<p>The solutions outlined below take an operator splitting approach allow
sequential solution of the HSUs and processes with the HSUs. In doing this the
choice has been made to represent the exchange of fluxes between and within
HSUs as volumes (integrals of the flux over the timestep).</p>
<div id="notation-and-nomenclature" class="section level1">
<h1 class="hasAnchor">
<a href="#notation-and-nomenclature" class="anchor"></a>Notation and nomenclature</h1>
<p>The notation used can be broken down as follows. Table <a href="#tab:exchange-notation">1</a> outlines the notation used for describing a fluxes exchanged between HSUs. These variables are common across all HSUs.
Table <a href="#tab:hs-notation">2</a> outlines the notation used for describing a hill
slope HSU.
All other notation is given in Table <a href="#tab:other-notation">3</a>.</p>
<p>The following conventions are used:</p>
<ul>
<li><p>All fluxes (<span class="math inline">\(q_{* \rightarrow *}\)</span> and <span class="math inline">\(l_{*}\)</span>) are considered to be greater or
equal to zero.</p></li>
<li><p>Superscript notation <span class="math inline">\(^{\left[i\right]}\)</span> indicates the property of
the <span class="math inline">\(i\)</span>th HSU</p></li>
<li><p><span class="math inline">\(\left.x\right\rvert_t\)</span> indicates the value of the
variable <span class="math inline">\(x\)</span> at time <span class="math inline">\(t\)</span></p></li>
<li><p>Where intermediate evaluations of some variables are compute these are distinguish by use of <span class="math inline">\(\tilde{}\)</span>. For example
<span class="math inline">\(\tilde{s}_{rz}\)</span> is an intermediate value in the computation of
<span class="math inline">\(s_{rz}\)</span>.</p></li>
</ul>
<table class="table">
<caption>
<span id="tab:exchange-notation">Table 1: </span> Outline of notation for describing the exchange between HSUs</caption>
<thead><tr class="header">
<th align="left">Quantity type</th>
<th align="center">Symbol</th>
<th align="left">Description</th>
<th align="center">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Lateral fluxes from HSUs</td>
<td align="center"><span class="math inline">\(l_{sf}\)</span></td>
<td align="left">Total lateral flux from surface store</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(l_{sz}\)</span></td>
<td align="left">Total lateral flux from saturated zone store</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td align="left">Other HSU properties</td>
<td align="center"><span class="math inline">\(f^{\left[k,j\right]}_{sf}\)</span></td>
<td align="left">Fraction of <span class="math inline">\(l_{sf}\)</span> going from <span class="math inline">\(j\)</span>th</td>
<td align="center">-</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"></td>
<td align="left">HSU to <span class="math inline">\(k\)</span>th HSU</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(f^{\left[k,j\right]}_{sz}\)</span></td>
<td align="left">Fraction of <span class="math inline">\(l_{sz}\)</span> going from <span class="math inline">\(j\)</span>th</td>
<td align="center">-</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"></td>
<td align="left">HSU to <span class="math inline">\(k\)</span>th HSU</td>
<td align="center"></td>
</tr>
</tbody>
</table>
<table class="table">
<caption>
<span id="tab:hs-notation">Table 2: </span> Outline of notation for describing hill slope
HSU</caption>
<thead><tr class="header">
<th align="left">Quantity type</th>
<th align="center">Symbol</th>
<th align="left">Description</th>
<th align="center">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Storage</td>
<td align="center"><span class="math inline">\(s_{sf}\)</span></td>
<td align="left">Surface excess storage</td>
<td align="center">m</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{rz}\)</span></td>
<td align="left">Root zone storage</td>
<td align="center">m</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{uz}\)</span></td>
<td align="left">Unsaturated zone storage</td>
<td align="center">m</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{sz}\)</span></td>
<td align="left">Saturated zone storage deficit</td>
<td align="center">m</td>
</tr>
<tr class="odd">
<td align="left">Vertical fluxes within HSU</td>
<td align="center"><span class="math inline">\(q_{sf \rightarrow rz}\)</span></td>
<td align="left">Flow from the surface excess store to the</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"></td>
<td align="left">root zone</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(q_{rz \rightarrow uz}\)</span></td>
<td align="left">Flow from the root zone to the unsaturated</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"></td>
<td align="left">zone</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(q_{rz \rightarrow sf}\)</span></td>
<td align="left">Flow from the root zone to the surface</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"></td>
<td align="left">excess storage</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(q_{uz \rightarrow sz}\)</span></td>
<td align="left">Flow from unsaturated to saturated zone</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(q_{sz \rightarrow sf}\)</span></td>
<td align="left">Flow from saturated zone to surface</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"></td>
<td align="left">excess storage</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">Other HSU properties</td>
<td align="center">a</td>
<td align="left">Area</td>
<td align="center">m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(q_{sfmax}\)</span></td>
<td align="left">Maximum flow rate from surface excess to</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"></td>
<td align="left">root zone</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(s_{rzmax}\)</span></td>
<td align="left">Maximum root zone storage</td>
<td align="center">m</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(T_d\)</span></td>
<td align="left">Unsaturated zone time constant per m of</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"></td>
<td align="left">saturated storage deficit.</td>
<td align="center">s/m</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(l_{szmax}\)</span></td>
<td align="left">Maximum lateral flux from saturated zone</td>
<td align="center">(m<span class="math inline">\(^3\)</span>/s)/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(T_{sf}\)</span></td>
<td align="left">Surface excess storage time constant</td>
<td align="center">s</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"><span class="math inline">\(m\)</span></td>
<td align="left">Exponential transmissivity constant</td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center"><span class="math inline">\(\Delta x\)</span></td>
<td align="left">Effective length of the hillslope HSU</td>
<td align="center">m</td>
</tr>
</tbody>
</table>
<table class="table">
<caption>
<span id="tab:other-notation">Table 3: </span> Eternal inputs to HSUs</caption>
<thead><tr class="header">
<th align="left">Symbol</th>
<th align="left">Description</th>
<th align="center">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\Delta t\)</span></td>
<td align="left">Timestep</td>
<td align="center">s</td>
</tr>
<tr class="even">
<td align="left">
<span class="math inline">\(p\)</span> Precipitation rate</td>
<td align="left">m/s</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">
<span class="math inline">\(e_p\)</span> Potential evapotran</td>
<td align="left">spiration rate m/s</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\mathcal{S}^{\left[i\right]}_{sf}\)</span></td>
<td align="left">The set of values <span class="math inline">\(j\)</span> for which <span class="math inline">\(f_{sf}^{\left[i,j\right]}&gt;0\)</span>
</td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\mathcal{S}^{\left[i\right]}_{sz}\)</span></td>
<td align="left">The set of values <span class="math inline">\(j\)</span> for which <span class="math inline">\(f_{sz}^{\left[i,j\right]}&gt;0\)</span>
</td>
<td align="center">-</td>
</tr>
</tbody>
</table>
</div>
<div id="order-of-hsus-and-the-exchange-of-fluxes" class="section level1">
<h1 class="hasAnchor">
<a href="#order-of-hsus-and-the-exchange-of-fluxes" class="anchor"></a>Order of HSUs and the exchange of fluxes</h1>
<p>Fluxes between the HSUs occur at two levels, the surface (<span class="math inline">\(l_{sf}\)</span>) and the
saturated zone (<span class="math inline">\(l_{sz}\)</span>).
If all the lateral flux from an HSU is redirected to HSUs within the catchment then
<span class="math display">\[
\sum\limits_{j} f^{\left[j,i\right]}_{sf} =
    \sum\limits_{k} f^{\left[k,i\right]}_{sz} =1
\]</span></p>
<p>The total incoming flux to the <span class="math inline">\(i\)</span>th HSU expressed in <span class="math inline">\(m^3/s\)</span> is for each
level given by</p>
<p><span class="math display">\[
\sum_{j \in \mathcal{S}^{\left[i\right]}_{*}} f_{*}^{\left[i,j\right]}a^{\left[j\right]}
l^{\left[j\right]}_{*}
\]</span></p>
<p>Over a time step <span class="math inline">\(\Delta t\)</span> the volume of the incoming flux in <span class="math inline">\(m^3\)</span> is</p>
<p><span class="math display">\[
\sum_{j \in \mathcal{S}^{\left[i\right]}_{*}} f_{*}^{\left[i,j\right]} a^{\left[j\right]}
\int_{\Delta t}l^{\left[j\right]}_{*}dt
\]</span></p>
<p>The solutions proposed for the individual HSUs are limited to the situation
that the HSUs can be ordered for each level so when solved in sequence the input fluxes from other HSUs (as given above) are known.</p>
</div>
<div id="hill-slope-hsu" class="section level1">
<h1 class="hasAnchor">
<a href="#hill-slope-hsu" class="anchor"></a>Hill Slope HSU</h1>
<p>The numerical solution implemented in the dynamic TOPMODEL code is based
on solving the ODE(s) governing the evolution of each of the stores in the
HSUs sequentially while approximating the flux between them.</p>
<p>The following sections present the solutions to the governing equations
in the order they are currently solved in the code for given time
step <span class="math inline">\(\Delta t\)</span> (seconds) starting at time <span class="math inline">\(t\)</span> over which the input fluxes (<span class="math inline">\(p\)</span> and <span class="math inline">\(e_p\)</span>) are
taken to be constant.</p>
<div id="step-1-surface-excess-redistribution" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1-surface-excess-redistribution" class="anchor"></a>Step 1: Surface excess redistribution</h2>
<p>For the <span class="math inline">\(i\)</span>th hill slope HSU the alteration of the surface excess store is
given by
<span class="math display">\[
\frac{ds^{\left[i\right]}_{sf}}{dt} =  
    \sum\limits_{j \in \mathcal{S}_{sf}^{\left[i\right]}} f^{\left[i,j\right]}_{sf}\frac{a^{\left[j\right]}}{a^{\left[i\right]}}l^{\left[j\right]}_{sf}
    - l^{\left[i\right]}_{sf}
    + q^{\left[i\right]}_{sz \rightarrow sf}
    + q^{\left[i\right]}_{rz \rightarrow sf}
    - q^{\left[i\right]}_{sf \rightarrow rz}
\]</span></p>
<p>The solution of this is approximated through two stages.
The first stage computes the lateral flux <span class="math inline">\(l^{\left[i\right]}_{sf}\)</span> from the HSU based on the storage at
the start of the time step; ignoring the potential
vertical flux within the HSU.
The second stage, carried out in Step 5 corrects for the vertical fluxes.</p>
<p>The computation of the lateral flux from the surface excess storage is based on two assumption</p>
<ol style="list-style-type: decimal">
<li>There are minimal non-linearities so the surface excess store of a hill slope HSU can be treated as linear tanks with
<span class="math inline">\(l^{\left[i\right]}_{sf} = \frac{1}{T^{\left[i\right]}_{sf}} s^{\left[i\right]}_{sf}\)</span>.</li>
<li>The inflow is approximatley constant during the timestep.</li>
</ol>
<p>Under these assumptions we write
<span class="math display">\[
\frac{d\tilde{s}_{sf}}{dt} = \frac{1}{\Delta t} \sum\limits_{j \in \mathcal{S}_{sf}^{\left[i\right]}} f^{\left[i,j\right]}_{sf}\frac{a^{\left[j\right]}}{a^{\left[i\right]}} \int_{\Delta t}l^{\left[j\right]}_{sf}dt
- \frac{1}{T_{sf}^{\left[i\right]}} \tilde{s}
\quad \left. \tilde{s}_{sf} \right\rvert_{t} = \left. s_{sf} \right\rvert_{t}
\]</span></p>
<p>which can be solved to give
<span class="math display">\[
\left. \tilde{s}_{sf} \right\rvert_{t+\Delta t} =
\left. s_{sf}^{\left[i\right]}\right\rvert_{t}
\sfp\left(-\frac{\Delta t}{T_{sf}^{\left[i\right]}}\right)
+ \left(1 - \exp\left(-\frac{\Delta t}{T_{sf}^{\left[i\right]}}\right)\right)
\frac{T_{sf}^{\left[i\right]}}{\Delta t} \sum\limits_{j \in \mathcal{S}_{sf}^{\left[i\right]}} f^{\left[i,j\right]}_{sf}\frac{a^{\left[j\right]}}{a^{\left[i\right]}} \int_{\Delta t}l^{\left[j\right]}_{sf}dt
\]</span></p>
<p>Mass balance gives
<span class="math display">\[
 \int_{\Delta t}l^{\left[i\right]}_{sf}dt 
 = \left. s_{sf}^{\left[i\right]}\right\rvert_{t}
 - \left. \tilde{s}_{sf}\right\rvert_{t+\Delta t}
+ \sum\limits_{j \in \mathcal{S}_{sf}^{\left[i\right]}} f^{\left[i,j\right]}_{sf}\frac{a^{\left[j\right]}}{a^{\left[i\right]}} \int_{\Delta t}l^{\left[j\right]}_{sf}dt
 \]</span></p>
</div>
<div id="step-2-root-zone" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2-root-zone" class="anchor"></a>Step 2: Root Zone</h2>
<p>For a single HSU
<span class="math display">\[
\frac{ds_{rz}}{dt}=p + q_{sf \rightarrow rz}
-\frac{s_{rx}}{s_{rzmax}}e_{p}-q_{rz \rightarrow sf} - q_{rz \rightarrow uz}
\]</span>
Assuming all the water in the surface excess store is available to the root
zone so long as <span class="math inline">\(q_{sf \rightarrow rz} \leq q_{sfmax}\)</span> the integral of the
flow from the surface excess store can be approximated by
<span class="math display">\[
\int\limits_{\Delta t} q_{sf \rightarrow rz} dt =
\min\left(q_{sfmax}\Delta t,\left.\tilde{s}_{sf}\right.\rvert_{t+\Delta t}\right)
\]</span>
Using this and assuming constant precipitation and potential
evapotranspiration rates over the time step the root zone is solved as a two step process. Firstly the ODE
<span class="math display">\[
\frac{d\tilde{s}_{rz}}{dt} = p
+ \frac{1}{\Delta t}\int\limits_{\Delta t} q_{sf \rightarrow rz} dt
- \frac{e_{p}}{s_{rzmax}}\tilde{s}_{rz} \quad
\left. \tilde{s}_{rz}\right\rvert_{t} = \left. s_{rz}\right\rvert_{t}
\]</span>
is solved to give
<span class="math display">\[
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} = 
\left. s_{rz}\right\rvert_{t} \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta
t\right)
+ \left(p
+ \frac{1}{\Delta t}\int\limits_{\Delta t} q_{sf \rightarrow rz} dt \right)
\frac{s_{srmax}}{e_p}
\left(1 - \exp\left(-\frac{e_{p}}{s_{rzmax}}\Delta t\right)\right)
\]</span>
which is the root zone storage not allowing for losses to the surfce excess
store or unsaturated zone. From this
<span class="math display">\[
\left. s_{rz}\right\rvert_{t + \Delta t} =
\min\left(\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t}, s_{rzmax}\right)
\]</span>
and the total water passed from the root zone is
<span class="math display">\[
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\]</span></p>
<p>The water passed from the root zone can be passed either to the surface excess
storage or the unsaturated zone. If <span class="math inline">\(\left. s_{sz}\right\rvert_{t} = 0\)</span> the
flux from the root zone is passed to the
surface excess store giving
<span class="math display">\[
\int_{\Delta t} q_{rz \rightarrow sf} dt =
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\quad
\int_{\Delta t} q_{rz \rightarrow uz} dt = 0
\]</span></p>
<p>If <span class="math inline">\(\left. s_{sz}\right\rvert_{t} &gt; 0\)</span> then the flux from the root zone is
passed to the unsaturated zone store by taking
<span class="math display">\[
\int_{\Delta t} q_{rz \rightarrow sf} dt = 0
\quad
\int_{\Delta t} q_{rz \rightarrow uz} dt =
\left. \tilde{s}_{rz}\right\rvert_{t + \Delta t} -
\left. s_{rz}\right\rvert_{t + \Delta t}
\]</span></p>
</div>
<div id="step-3-unsaturated-zone" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3-unsaturated-zone" class="anchor"></a>Step 3: Unsaturated Zone</h2>
<p>For a single HSU the unsaturated zone representation of a non-linear tank whose time
constant is dependent upon the saturation deficit:
<span class="math display">\[
\frac{ds_{uz}}{dt}=q_{rz \rightarrow uz}-\frac{s_{uz}}{s_{sz}T_{d}}
\]</span></p>
<p>In keeping with the root zone the
solution to the governing ODE is approximated by
<span class="math display">\[
\frac{d\tilde{s}_{uz}}{dt} =
\frac{1}{\Delta t}\int_{\Delta t} q_{rz \rightarrow uz} dt
- \frac{\tilde{s}_{uz}}{\left.s_{sz}\right\rvert_{t}T_{d}} \quad
\left.\tilde{s}_{uz}\right\rvert_{t} = \left.s_{uz}\right\rvert_{t}
\]</span></p>
<p>which is given by
<span class="math display">\[
\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t} =
\left.s_{uz}\right\rvert_{t}\exp\left(-\frac{\Delta
  t}{\left.s_{sz}\right\rvert_{t}T_d}\right)
+ \frac{1}{\left.s_{sz}\right\rvert_{t}T_{d}\Delta t}
\int_{\Delta t} q_{rz \rightarrow uz} dt
 \left(1 -
 \exp\left(-\frac{\Delta t}{\left. s_{sz}\right\rvert_{t}T_{d}}\right)\right)
\]</span>
Mass balance then gives
<span class="math display">\[
\int_{\Delta t} q_{uz \rightarrow sz} dt =  \left.s_{uz}\right\rvert_{t} + \int_{\Delta t}
q_{rz \rightarrow uz} dt - \left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}
\]</span></p>
<p>The above solution ensures that <span class="math inline">\(\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}\)</span>
equals 0 if <span class="math inline">\(\left.s_{sz}\right\rvert_{t}=0\)</span>. However to ensure that
<span class="math inline">\(\left.s_{uz}\right\rvert_{t+\Delta t} =0\)</span> if <span class="math inline">\(\left.s_{sz}\right\rvert_{t+\Delta  t}=0\)</span> the estimate <span class="math inline">\(\left.\tilde{s}_{uz}\right\rvert_{t+\Delta t}\)</span> is revised
after computation of the saturated zone in Step 5.</p>
</div>
<div id="step-4-saturated-zone" class="section level2">
<h2 class="hasAnchor">
<a href="#step-4-saturated-zone" class="anchor"></a>Step 4: Saturated Zone</h2>
<p>For the <span class="math inline">\(i\)</span> th hill slope HSU the change in saturated zone storage deficit is
evaluated using a kinematic wave approximation.
For an infinitesimal slab
<span class="math display">\[
\frac{dA}{dt} + \frac{dQ}{dx} -r = 0
\]</span>
where <span class="math inline">\(A\)</span>, <span class="math inline">\(Q\)</span> and <span class="math inline">\(r\)</span> are the cross sectional flow area, lateral flow and
recharge for the infinitesimal slab.</p>
<p>Consider the HSU to be a rectangle of area <span class="math inline">\(a\)</span> with inflow and outflow
occuring at parallel edges seperated by a distance <span class="math inline">\(\Delta x\)</span> giving an
effective width if <span class="math inline">\(w=\frac{a}{\Delta x}\)</span>. Taking a height
<span class="math inline">\(h\)</span> gives <span class="math inline">\(A = hw\)</span>. Further noting that <span class="math inline">\(h=h_0-z\)</span> for some
datum <span class="math inline">\(h_0\)</span> and storage deficit <span class="math inline">\(z\)</span> (expressed as a length) gives
<span class="math display">\[
\frac{dA}{dt} = w\frac{dh}{dt}=-w\frac{dz}{dt}
\]</span></p>
<p>The storage deficit <span class="math inline">\(z\)</span> and <span class="math inline">\(Q\)</span> are linked by a one-to-one montotonically
decreasing, continuously differentiable function
<span class="math inline">\(g: \mathcal{R}\rightarrow \mathcal{R}^{+}\)</span> which returns the lateral flow on
a unit width such that <span class="math inline">\(Q = w g\left(z\right)\)</span>.
This relationships can be used to express the change in deficit over time in
terms of lateral flow as follows:
<span class="math display">\[
\frac{dz}{dt} =  \frac{dz}{dQ}\frac{dQ}{dt} =
=  \frac{1}{w}\left(\frac{d}{dz}g\left(z\right)\right)^{-1}\frac{dQ}{dt} =
-\frac{1}{w c\left(z\right)}\frac{dQ}{dt}
\]</span>
where <span class="math inline">\(c\left(z\right)=-\frac{d}{dz}g\left(z\right)\)</span> is the kinematic velocity
expressed as a function of lateral flow per unit width.</p>
<p>Subsitution gives
<span class="math display">\[
\frac{1}{c\left(z\right)}\frac{dQ}{dt} + \frac{dQ}{dx} -r = 0
\]</span>
to which a numerical solution is sort.
Let <span class="math inline">\(Q^{+}\)</span> and <span class="math inline">\(Q^{-}\)</span> be the lateral flows at the foot and head of the slope
respectivly and ${r} a constant inflow per unit length.</p>
<p>One possible four-point or box scheme for a constant recharge is given by
<span class="math display">\[
\begin{split}
&amp; \left(1-\omega\right)\frac{\left.Q^{-}\right\rvert_{t+1}-\left.Q^{-}\right\rvert_{t}}{\Delta t} +
\omega\frac{\left.Q^{+}\right\rvert_{t+1}-\left.Q^{+}\right\rvert_{t}}{\Delta t} +
\left(1-\theta\right)c\left(\left.z\right\rvert_{t}\right)
\left(\frac{\left.Q^{+}\right\rvert_{t}-\left.Q^{-}\right\rvert_{t}}{\Delta x} -\bar{r}\right)
+ \\
&amp; \theta c\left(\left.z\right\rvert_{t+1}\right)\left(\frac{\left.Q^{+}\right\rvert_{t+1}-\left.Q^{-}\right\rvert_{t+1}}{\Delta x} -\bar{r}\right)
= 0
\end{split}
\]</span></p>
<p>It certain conditions it has been shown that this scheme
is unlikely to be numerical stable for all <span class="math inline">\(\Delta t\)</span> while the alternate
scheme replacing <span class="math inline">\(c\left(z\right)\)</span> with a ‘typical’ value <span class="math inline">\(\bar{c}\)</span>
<span class="math display">\[
\begin{split}
&amp; \left(1-\omega\right)\frac{\left.Q^{-}\right\rvert_{t+\Delta t}-\left.Q^{-}\right\rvert_{t}}{\Delta t} +
\omega\frac{\left.Q^{+}\right\rvert_{t+\Delta t}-\left.Q^{+}\right\rvert_{t}}{\Delta t} +
\left(1-\theta\right)\bar{c}
\left(\frac{\left.Q^{+}\right\rvert_{t}-\left.Q^{-}\right\rvert_{t}}{\Delta x} - \bar{r}\right)
+ \\
&amp; \theta \bar{c}\left(\frac{\left.Q^{+}\right\rvert_{t+\Delta t}-\left.Q^{-}\right\rvert_{t+\Delta t}}{\Delta x} - \bar{r}\right)
= 0
\end{split}
\]</span>
is stable for <span class="math inline">\(\omega \geq 0.5\)</span>, <span class="math inline">\(\theta \geq 0.5\)</span>.</p>
<p>Rearranging this and taking
<span class="math display">\[
\lambda = \frac{\bar{c}\Delta t}{\Delta x}
\]</span>
gives</p>
<p><span class="math display">\[
\begin{split}
  \left( \omega + \theta \lambda \right) &amp;
  \left.Q^{+}\right\rvert_{t+\Delta t} +
  \left(1 - \omega - \theta \lambda \right) \left. Q^- \right\rvert_{t+\Delta t} \\
  &amp; - \left( \omega - \left(1-\theta\right)\lambda \right) \left.Q^{+}\right\rvert_{t}
  - \left(1 - \omega + \left(1 - \theta\right)\lambda \right) \left. Q^- \right\rvert_{t}
\\
&amp; - \lambda \Delta x \bar{r} =0
\end{split}
\]</span></p>
<p>Consider the <span class="math inline">\(i\)</span> th HSU. The impact of saturation at
<span class="math inline">\(s^{\left[i\right]}_{sz}=0\)</span> is to limits the lateral flow to <span class="math inline">\(l^{\left[i\right]}_{szmax}\)</span> all points and times producing return flow to the
surface excess store. There is however no guarentee that the inflow to the
saturated zone store from other HSUs, given by</p>
<p><span class="math display">\[
\sum_{j\in\mathcal{S}^{\left[i\right]}_{sz}}f_{sz}^{\left[i,j\right]}\frac{a^{\left[j\right]}}{a^{\left[i\right]}}l^{\left[j\right]}_{sz}. 
\]</span></p>
<p>is less then <span class="math inline">\(l_{szmax}^{\left[i\right]}\)</span>. In estimating
<span class="math inline">\(l_{sz}^{\left[i\right]}\)</span> the solution proposed allows lateral flow to
occur at values exceeding <span class="math inline">\(l^{\left[i\right]}_{szmax}\)</span> within the HSU, but
limits the fluxes transfered to and from the HSU.</p>
<p>Suppose that <span class="math inline">\(l_{szmaz}\geq\left.l_{sz}^{\left[i\right]}\right\rvert_{t}\geq 0\)</span>.
This provides an estimate of <span class="math inline">\(\left.Q^{+}\right\rvert_{t}\)</span>.
Since the inflow from the other HSUs is represented as a volume take
<span class="math display">\[
\bar{Q}^{-} = \left.Q^{-}\right\rvert_{t} =
\left.Q^{-}\right\rvert_{t+\Delta t} =
\min\left(\frac{1}{a^{\left[i\right]}\Delta t}
\sum_{j}f_{sz}^{\left[i,j\right]}a^{\left[j\right]}\int_{\Delta
  t}l^{\left[j\right]}_{sz} dt,
l_{szmax}^{\left[i\right]}\right)
\]</span></p>
<p>Constant recharge for every cross section means that
<span class="math inline">\(\int_{\Delta t} q_{uz\rightarrow sz} dt = r \Delta x \Delta t\)</span>.</p>
<p>An initial estimate of the lateral flux from the saturated zone at the end of
the time step <span class="math inline">\(\left.\tilde{l}^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t}\)</span>
is thus given by</p>
<p><span class="math display">\[
\left( \omega + \theta \lambda^{\left[i\right]} \right)
\left.\tilde{l}^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t} =
\left( \omega - \left(1-\theta\right)\lambda^{\left[i\right]} \right)
\left.l^{\left[i\right]}_{sz}\right\rvert_{t} +
\frac{\lambda^{\left[i\right]}}{\Delta t}\left(\bar{Q}^{\left[i\right]}\Delta t +
\int_{\Delta t} q^{\left[i\right]}_{uz\rightarrow sz} dt \right)
\]</span>
Assuming <span class="math inline">\(\bar{c}^{\left[i\right]}\)</span> and hence <span class="math inline">\(\lambda^{\left[i\right]}\)</span> is not dependent upon
<span class="math inline">\(\left.\tilde{l}^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t}\)</span> then this
leads a simple solution for
<span class="math inline">\(\left.l^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t}\)</span>
as
<span class="math display">\[
\left.l^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t} = \min\left(
\left.\tilde{l}^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t},
l^{\left[i\right]}_{szmax}\right)
\]</span></p>
<div id="determining-the-storage-deficit" class="section level3">
<h3 class="hasAnchor">
<a href="#determining-the-storage-deficit" class="anchor"></a>Determining the storage deficit</h3>
<p>The above scheme determines the flows at the head and foot of the HSU at
descrete times. Linearly approximating between the time points gives
<span class="math display">\[
\int_{\Delta t} l_{sz} dt = \frac{\Delta t}{2} \left(
\left.l_{sz}\right\rvert_{t+\Delta t} + \left.l_{sz}\right\rvert_{t}\right)
\]</span>
From this
<span class="math display">\[
\tilde{s}_{sz} =
\left.s^{\left[i\right]}_{sz}\right\rvert_{t} + \int_{\Delta t}
l^{\left[i\right]}_{sz} dt
- \sum_{j}f_{sz}^{\left[i,j\right]}\frac{a^{\left[j\right]}}{a^{\left[i\right]}}\int_{\Delta t}
l^{\left[j\right]}_{sz} dt
- \int_{\Delta t} q^{\left[i\right]}_{uz\rightarrow sz} dt
\]</span>
from which can be computed
<span class="math display">\[
\left.s^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t} =
\max\left(0,\tilde{s}_{sz}\right)
\]</span> and
<span class="math display">\[
\left.\int_{\Delta t} q^{\left[i\right]}_{sz\rightarrow sf} dt \right\rvert_{t+\Delta t} =
\left.s^{\left[i\right]}_{sz}\right\rvert_{t+\Delta t} - \tilde{s}_{sz}
\]</span></p>
</div>
<div id="estimating-barc" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-barc" class="anchor"></a>Estimating <span class="math inline">\(\bar{c}\)</span>
</h3>
<p>The above solution relies on the estimate of an “average”
value <span class="math inline">\(\bar{c}\)</span>. A relatively simple approach to
constructing <span class="math inline">\(\bar{c}\)</span> is to take
<span class="math display">\[
\bar{c} = c\left(\bar{z}\right)
\]</span>
where <span class="math inline">\(\bar{z}\)</span> is a estimate of average (in space and time) of the storage
deficit. This is approximated by <span class="math inline">\(\left.s_{sz}\right\rvert_{t}\)</span>.</p>
</div>
</div>
<div id="step-5-correcting-vertical-stores" class="section level2">
<h2 class="hasAnchor">
<a href="#step-5-correcting-vertical-stores" class="anchor"></a>Step 5: Correcting vertical stores</h2>
<p>Having evaluated the stores in the direction of gravity there is the need to
correct for vertical fluxes returning water to the surface thus increase
<span class="math inline">\(s_{sf}\)</span>.</p>
<p>If saturation has occured, that is
<span class="math inline">\(\left. s_{sz}\right. \rvert_{t+\Delta t}=0\)</span>,
then there can be no water stored in the unsaturated zone. Let
<span class="math display">\[
\int_{\Delta t} q_{uz \rightarrow sf}dt = \left\{ \begin{array}{cc}
  \left.\tilde{s}_{uz}\right. \rvert_{t+\Delta t} &amp;
  \left. s_{sz}\right. \rvert_{t+\Delta t}=0\\
  0 &amp; \mathrm{otherwise}
\end{array}
\right.
\]</span></p>
<p>The correction of the stores then takes the form
<span class="math display">\[
\left. s_{sf} \right. \rvert_{t+\Delta t} =
\left.\tilde{s}_{sf}\right. \rvert_{t+\Delta t}  + \int_{\Delta t} q_{rz
  \rightarrow sf} dt + \int_{\Delta t} q_{sz \rightarrow sf} dt + \int_{\Delta t} q_{uz \rightarrow sf} dt
\]</span>
and
<span class="math display">\[
\left. s_{uz} \right. \rvert_{t+\Delta t} =
\left.\tilde{s}_{uz}\right. \rvert_{t+\Delta t} - \int_{\Delta t} q_{uz
  \rightarrow sf} dt
\]</span></p>
</div>
</div>
<div id="channel-hsu" class="section level1">
<h1 class="hasAnchor">
<a href="#channel-hsu" class="anchor"></a>Channel HSU</h1>
<p>The current implimentation of the channel HSU calculates the average discharge
to the channel over the time step in <span class="math inline">\(m^3/s\)</span>. This is given for the <span class="math inline">\(k\)</span> th channel HSU as
<span class="math display">\[
\frac{1}{\Delta t} \left(
\sum\limits_{j}
f^{\left[k,j\right]}_{sf}a^{\left[j\right]}l^{\left[j\right]}_{sf} +
\sum\limits_{j}
f^{\left[k,j\right]}_{sz}a^{\left[j\right]}l^{\left[j\right]}_{sz} \right) + p
\]</span></p>
</div>
<div id="appendix-ordinary-differential-equations-solutions" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix-ordinary-differential-equations-solutions" class="anchor"></a>Appendix: Ordinary Differential Equations Solutions</h1>
<p>For completeness the solutions to the ODEs made use of above are
documented here.</p>
<div id="single-variable-non-homogeneous-ode-with-constant-input" class="section level2">
<h2 class="hasAnchor">
<a href="#single-variable-non-homogeneous-ode-with-constant-input" class="anchor"></a>Single variable non-homogeneous ODE with constant input</h2>
<p>The initial condition
problem<span class="math display">\[\frac{dx\left(t\right)}{dt} = a - b x\left(t\right) \quad x\left(0\right) = x_0\]</span>
or more compactly
<span class="math display">\[x^{\prime}\left(t\right) = a - b x\left(t\right) \quad x\left(t_0\right) = x_0\]</span>
involves the solution of first order linear system. This can be solved
explicitly using an ‘integrating factor’. Let
<span class="math inline">\(\mu = \exp\left(\int\limits_t b dt\right) = \exp\left(bt\right)\)</span>.
Multiplying both sides by <span class="math inline">\(\mu\)</span> then integrating (noting the LHS is the
result of the product formula in differentiation) gives
<span class="math display">\[\exp\left(bt\right) x = \int\limits_{t} a\exp\left(bt\right) dt = \frac{a}{b}\exp\left(bt\right) + K\]</span>
The constant <span class="math inline">\(K\)</span> can be evaluates using the initial conditions as
<span class="math inline">\(K=x_{0}-\frac{a}{b}\)</span>. Substitution and rearrangement then gives
<span class="math display">\[x = x_{0}\exp\left(-bt\right) + \frac{a}{b}\left(1-\exp\left(-bt\right)\right)\]</span>
Note that <span class="math display">\[\begin{array}{c}
        x\rightarrow0 \quad\mathrm{as}\quad b\rightarrow\infty\\
        x\rightarrow x_{0} + at \quad\mathrm{as}\quad b\rightarrow0\\
    \end{array}\]</span></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul Smith, Peter Metcalfe.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
