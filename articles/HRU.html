<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The HRU • dynatop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="The HRU">
<meta property="og:description" content="dynatop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.0.1005</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dynatop.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/HRU.html">The HRU</a>
    </li>
    <li>
      <a href="../articles/Notes_on_the_implementation_of_Dynamic_TOPMODEL.html">Notes on the implementation of Dynamic TOPMODEL</a>
    </li>
    <li>
      <a href="../articles/The_Model_Object.html">The Model Object</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatop/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>The HRU</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatop/blob/HEAD/vignettes/HRU.Rmd" class="external-link"><code>vignettes/HRU.Rmd</code></a></small>
      <div class="hidden name"><code>HRU.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="conceptual-model">Conceptual model<a class="anchor" aria-label="anchor" href="#conceptual-model"></a>
</h2>
<p>One of the underlying principles of dynamic TOPMODEL is that the landscape can
be broken up into hydrologically similar regions, or Hydrological Response
Units (HRUs), where all the area within a HRU behaves in a hydrologically
similar fashion. Further discussion and the connection of HRUs is outlined <a href="Notes_on_the_implementation_of_Dynamic_TOPMODEL.html">elsewhere</a>.</p>
<p>This document outlines the conceptual structure and computational
implementation of the HRU. The HRU is a representation of
an area of the catchment with, for example, similar topographic, soil and upslope area
characteristics.</p>
<p>The HRU is considered to be a area of catchment with outflow
occurring across a specified width of it boundary.
It is formed of four zones representing the surface water, which
passes water between HRUs and drains to the root zone. The root zone characterises
the interactions between evapotranspiration and precipitation and when full spills to
the unsaturated zone. This drains to the saturated zone which also interacts
with other HRUs. The behaviour of the saturated zone is modelled using a kinematic wave
approximation. The zones and variables used below are shown in the schematic diagram.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-1"></span>
<img src="Hillslope_HRU.png" alt="Schematic of the Hill slope HRU" width="75%"><p class="caption">
Figure 1: Schematic of the Hill slope HRU
</p>
</div>
<p>In the following section the governing equations of the HRU are
given in a finite volume form. Approximating equations for the solution of the
governing equations are then derived with associated implicit and semi-implicit numerical
schemes. These are valid for the wide range of surface zone and saturated zone
transmissivity profiles presented in the vignette.</p>
<p>In this section a finite volume formulation of the Dynamic TOPMODEL equations
is derived for the evolution of the states over the time step <span class="math inline">\(t\)</span> to <span class="math inline">\(t + \Delta t\)</span>. The lateral flux rates are considered at the start and end of the
time step. The vertical flux rates are considered as constant throughout the
time step, allowing for a semi-analytical solution of some storage zones.</p>
<p>Two appendices provide supporting information justifying the numerical schemes
and an alternative derivation of the governing equations based on the
infinitesimal vertical slab used in the original derivation of Dynamic TOPMODEL.</p>
</div>
<div class="section level2">
<h2 id="notation">Notation<a class="anchor" aria-label="anchor" href="#notation"></a>
</h2>
<p>Table <a href="#tab:hs-x-notation">1</a> outlines the notation used for describing an
infinitesimal slab across the hillslope HRU.</p>
<p>The following conventions are used:</p>
<ul>
<li><p>All properties such as slope angles and time constants are considered
uniform along the hillslope.</p></li>
<li><p>Precipitation and Potential Evapotranspiration occur at spatially uniform
rates.</p></li>
<li><p>All vertical fluxes <span class="math inline">\(r_{\star \rightarrow \star}\)</span> are considered to
spatially uniform and to be positive when
travelling in the direction of the arrow, but can, in some cases be negative.</p></li>
<li><p>All lateral fluxes <span class="math inline">\(q_{\star}\)</span> and <span class="math inline">\(q_{\star}\)</span> are considered to be positive flows travelling downslope.</p></li>
<li><p>The superscripts <span class="math inline">\(^+\)</span> and <span class="math inline">\(^-\)</span> are used to denote variables for the outflow
and inflow to the hillslope.</p></li>
<li><p><span class="math inline">\(\left.y\right\rvert_t\)</span> indicates the value of the
variable <span class="math inline">\(y\)</span> at time <span class="math inline">\(t\)</span></p></li>
<li><p>In the derivation storage values at a given cross section of the HRU are
expressed as a depth and denoted with a <span class="math inline">\(\bar{}\)</span>. So integrating
over the length of the hillslope we find</p></li>
</ul>
<p><span class="math display">\[\begin{equation}
\int w \bar{y} dx = y
\end{equation}\]</span></p>
<table class="table">
<caption>
<span id="tab:hs-x-notation">Table 1: </span> Outline of notation for describing a cross
section of the hillslope HRU</caption>
<colgroup>
<col width="20%">
<col width="18%">
<col width="54%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th>Quantity type</th>
<th>Symbol</th>
<th>Description</th>
<th>unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Storage</td>
<td><span class="math inline">\(s_{sf}\)</span></td>
<td>Surface excess storage</td>
<td>m<span class="math inline">\(^3\)</span>
</td>
</tr>
<tr class="even">
<td></td>
<td><span class="math inline">\(s_{rz}\)</span></td>
<td>Root zone storage</td>
<td>m<span class="math inline">\(^3\)</span>
</td>
</tr>
<tr class="odd">
<td></td>
<td><span class="math inline">\(s_{uz}\)</span></td>
<td>Unsaturated zone storage</td>
<td>m<span class="math inline">\(^3\)</span>
</td>
</tr>
<tr class="even">
<td></td>
<td><span class="math inline">\(s_{sz}\)</span></td>
<td>Saturated zone storage deficit</td>
<td>m<span class="math inline">\(^3\)</span>
</td>
</tr>
<tr class="odd">
<td>Vertical fluxes</td>
<td><span class="math inline">\(r_{sf \rightarrow rz}\)</span></td>
<td>Flow from the surface excess store to the root zone</td>
<td>m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="even">
<td></td>
<td><span class="math inline">\(r_{rz \rightarrow uz}\)</span></td>
<td>Flow from the root zone to the unsaturated zone</td>
<td>m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="odd">
<td></td>
<td><span class="math inline">\(r_{uz \rightarrow sz}\)</span></td>
<td>Flow from unsaturated to saturated zone</td>
<td>m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="even">
<td>Lateral fluxes</td>
<td><span class="math inline">\(q_{sf}\)</span></td>
<td>Lateral flow in the hillslope surface zone</td>
<td>m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="odd">
<td></td>
<td><span class="math inline">\(q_{sz}\)</span></td>
<td>Lateral inflow to the hillslope surface zone</td>
<td>m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="even">
<td>Vertical fluxes to the HRU</td>
<td><span class="math inline">\(p\)</span></td>
<td>Precipitation rate</td>
<td>m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="odd">
<td></td>
<td><span class="math inline">\(e_p\)</span></td>
<td>Potential Evapotranspiration rate</td>
<td>m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="even">
<td>Other HRU properties</td>
<td><span class="math inline">\(A\)</span></td>
<td>Plan area</td>
<td>m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="odd">
<td></td>
<td><span class="math inline">\(w\)</span></td>
<td>Width of a hill slope cross section</td>
<td>m</td>
</tr>
<tr class="even">
<td></td>
<td><span class="math inline">\(\Delta x\)</span></td>
<td>Effective length of the hillslope HRU (x = A/w$)</td>
<td>m</td>
</tr>
<tr class="odd">
<td></td>
<td><span class="math inline">\(\Theta_{sf}\)</span></td>
<td>Further properties and parameters for the solution of the surface zone</td>
<td>:-:</td>
</tr>
<tr class="even">
<td></td>
<td><span class="math inline">\(\Theta_{rz}\)</span></td>
<td>Further properties and parameters for the solution of the root zone</td>
<td>:-:</td>
</tr>
<tr class="odd">
<td></td>
<td><span class="math inline">\(\Theta_{uz}\)</span></td>
<td>Further properties and parameters for the solution of the saturated zone</td>
<td>:-:</td>
</tr>
<tr class="even">
<td></td>
<td><span class="math inline">\(\Theta_{sz}\)</span></td>
<td>Further properties and parameters for the solution of the saturated zone</td>
<td>:-:</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="surface-zone">Surface Zone<a class="anchor" aria-label="anchor" href="#surface-zone"></a>
</h2>
<p>The storage in the surface zone satisfies the mass balance equation</p>
<p><span class="math display">\[
\frac{ds_{sf}}{dt} = q^{-}_{sf} - r_{sf \rightarrow rz} - q^{+}_{sf}
\]</span></p>
<p>where surface storage is increased by lateral downslope flow from upslope HRUs.
Water flows to the root zone at a constant rate <span class="math inline">\(r_{sf \rightarrow rz}\)</span>, unless limited by
the available storage at the surface or the ability of the root zone to
receive water (for example if the saturation storage deficit is 0 and the root zone storage is full).</p>
<p>In cases where lateral flows in the saturated zone produce
saturation storage deficits water may be returned from the root
zone to the surface giving negative values of <span class="math inline">\(r_{sf \rightarrow rz}\)</span>.</p>
<p>The following subsections present the various options for the surface zone
solution starting from the first, that of the constant parameter Muskingham method.</p>
<div class="section level3">
<h3 id="constant-parameter-muskingham-solution">Constant Parameter Muskingham solution<a class="anchor" aria-label="anchor" href="#constant-parameter-muskingham-solution"></a>
</h3>
<p>The constant parameter Muskingham method offers a parsimonious for capturing a
range of surface dynamics. This sub-section outlines the key equations and shows
how they may be used to capture a range of conceptual models.</p>
<p>Muskingham routing can be derived in a number of ways. The surface storage <span class="math inline">\(s_{sf}\)</span> in a reach or hillslope of length <span class="math inline">\(\Delta x\)</span> can be expressed in terms of the representative flow <span class="math inline">\(q_{sf}\)</span> and velocity <span class="math inline">\(v_{sf}\)</span>
as
<span class="math display">\[
s_{sf} = \frac{q_{sf} \Delta x}{v_{sf}}
\]</span>
The representative flow is realted to the inflow <span class="math inline">\(q_{sf}^{-}\)</span> and outflow
<span class="math inline">\(q_{sf}^{+}\)</span> using the parameter <span class="math inline">\(\eta\)</span> through
<span class="math display">\[
q_{sf} = \eta q_{sf}^{-} + \left(1-\eta\right) q_{sf}^{+}
\]</span>
gives
<span class="math display">\[
s_{sf} = \frac{\Delta x}{v_{sf}} \left(\eta q_{sf}^{-} + \left(1-\eta\right) q_{sf}^{+} \right)
\]</span>
Taking vertical inflow <span class="math inline">\(r\)</span> the mass balance can be written
<span class="math display">\[
\frac{ds}{dt} = q^{-} + r - q^{+}
\]</span>
where by substitution
<span class="math display">\[
\frac{ds}{dt} = q^{-} + r - \max\left(0, \frac{1}{1-\eta}\left(\frac{sv}{\Delta x} - \eta q^{-}  \right) \right)
\]</span>
where the maximum ensures that outflow is positive.</p>
<p>The numerical scheme is based on the implicit solution of the ODE. Let the initial state be <span class="math inline">\(s_{t}\)</span> and the input rates <span class="math inline">\(q^{-}_{t+\Delta t}\)</span> and <span class="math inline">\(r_{t+\Delta t}\)</span> be known so</p>
<p><span class="math display">\[
s_{t+\Delta t} = \max\left(0, s_{t} + \Delta t \left( q^{-}_{t+\Delta t} + r_{t+\Delta t} -
\frac{1}{1-\eta_{t+\Delta t}}\max\left(0,\frac{s_{t+\Delta t}v}{\Delta x} - \eta_{t} q^{-}_{t+\Delta t}  \right) \right) \right)
\]</span></p>
<p>where the outer maximum ensures that states are not negative.
The maximum possible values of <span class="math inline">\(s_{t+\Delta t}\)</span> is <span class="math inline">\(s_{m}=\max\left(0, s_{t} + \Delta t \left( q^{-}_{t+\Delta t} + r_{t+\Delta t}\right)\right)\)</span> as the maximum possible values of <span class="math inline">\(s_{t+\Delta t}\)</span> and outflow starts at <span class="math inline">\(s_{c} = \frac{\eta q^{-}_{t+\Delta t}\Delta x}{v}\)</span></p>
<p>If <span class="math inline">\(s_{m} \leq s_{c}\)</span> then outflow cannnot occur and <span class="math inline">\(s_{t+\Delta t} = \max\left(0, s_{t} + \Delta t \left( q^{-}_{t+\Delta t} + r_{t+\Delta t} \right)\right)\)</span> where for mass balance the value of <span class="math inline">\(r\)</span> is limites so that <span class="math inline">\(\int_{t}^{t+\Delta t} r dt = s_{t+\Delta t} - s_{t} - \Delta t q^{-}_{t+\Delta t}\)</span>.</p>
<p>If <span class="math inline">\(s_{m} &gt; s_{c}\)</span> then outflow can occur and their exists a value <span class="math inline">\(s_{c} &lt; s_{t+\Delta t} &lt; s_{m}\)</span> such that
<span class="math display">\[
s_{t+\Delta t} = s_{t} + \Delta t \left( q^{-}_{t+\Delta t} + r_{t+\Delta t} -
\frac{1}{1-\eta_{t+\Delta t}}\left(\frac{s_{t+\Delta t}v}{\Delta x} - \eta_{t} q^{-}_{t+\Delta t}  \right) \right)
\]</span></p>
<p>which is given by</p>
<p><span class="math display">\[
s_{sf_{t+\Delta t}} = \frac{ \left(1-\eta\right) \Delta x}{
\left(1-\eta\right) \Delta x + v_{sf}\Delta t} \left(
s_{_sf_t} + \Delta t \left( \frac{1}{1-\eta} q^{-}_{sf_{t+\Delta t}} + r_{t+\Delta t} \right)\right)
\]</span></p>
<div class="section level4">
<h4 id="compound-channel">Compound channel<a class="anchor" aria-label="anchor" href="#compound-channel"></a>
</h4>
<p>In a compound channel the convayance descriptors change from <span class="math inline">\(\left\{ v_{1}, \eta{1} \right\}\)</span> to <span class="math inline">\(\left\{ v_{2}, \eta{2} \right\}\)</span> when <span class="math inline">\(s&gt;s_{1}\)</span>. The implicit solution for the mass balance can then be written as</p>
<p><span class="math display">\[
s_{t+\Delta t} = \max\left(0, s_{t} + \Delta t \left( q^{-}_{t+\Delta t} + r_{t+\Delta t} -
\frac{1}{1-\eta_{1}}\max\left(0,\frac{\min\left(s_{1},s_{t+\Delta t}\right)v}{\Delta x} - \eta_{1} q^{-}_{1}  \right) -
\frac{1}{1-\eta_{2}}\max\left(0,\frac{\min\left(0,s_{t+\Delta t}-s_{1}\right)v}{\Delta x} - \eta_{2} q^{-}_{2}  \right)
\right) \right)
\]</span></p>
<p>the storage exced</p>
<p>= (0, s_{t} + t ( q^{-}<em>{t+t} + r</em>{t+t} ))$ where for mass balance the value of <span class="math inline">\(r\)</span> is limites so that <span class="math inline">\(\int_{t}^{t+\Delta t} r dt = s_{t+\Delta t} - s_{t} - \Delta t q^{-}_{t+\Delta t}\)</span>.</p>
<p><span class="math display">\[
\frac{ds}{dt} = q^{-}_{t+\Delta t} + r_{t+\Delta t} - \max\left(0, \frac{1}{1-\eta}\left(\frac{sv}{\Delta x} - \eta q^{-}_{t+\Delta t}  \right) \right)
\]</span></p>
<p>The solutions fall into four cases:</p>
<ul>
<li>Case 1: <span class="math inline">\(s_{t} \leq \frac{\eta q^{-}_{t+\Delta t}\Delta x}{v}\)</span> and <span class="math inline">\(q^{-}_{t+\Delta t} + r_{t+\Delta t} \leq 0\)</span>. In this case there is no outflow at the insitial state and the storage volume it not increasing, hence outflow will not occur later in the time step so
<span class="math inline">\(\int_{t}^{t+\Delta t} q^{+} dt = 0\)</span>, <span class="math inline">\(s_{t+\Delta t} = max\left(0,s_{t} + \Delta t\left(q^{-}_{t+\Delta t} + r_{t+ \Delta t}\right)\right)\)</span> and to ensure mass balance <span class="math inline">\(\int_{t}^{t+\Delta t} r dt = s_{t+\Delta t} - s_{t} - \Delta t q^{-}_{t+\Delta t}\)</span>
where the maximum ensures that outflow is positive.</li>
</ul>
<p>given by
<span class="math display">\[
s_{sf_{t+\Delta t}} = \frac{ \left(1-\eta\right) \Delta x}{
\left(1-\eta\right) \Delta x + v_{sf}\Delta t} \left(
s_{_sf_t} + \Delta t \left( \frac{1}{1-\eta} q^{-}_{sf_{t+\Delta t}} + r_{t+\Delta t} \right)\right)
\]</span>
subject to the constraint <span class="math inline">\(q_{sf_{t+\Delta t}}^{+} \geq 0\)</span></p>
</div>
<div class="section level4">
<h4 id="approximating-tank-models">Approximating Tank Models<a class="anchor" aria-label="anchor" href="#approximating-tank-models"></a>
</h4>
<p>Taking <span class="math inline">\(\eta=0\)</span> gives
<span class="math display">\[
\frac{ds}{dt} = q^{-} + r - \frac{sv}{\Delta x}
\]</span>
which is the equation of a tank model with possibly varying time constant <span class="math inline">\(T = \frac{\Delta x}{v}\)</span></p>
</div>
<div class="section level4">
<h4 id="approximating-diffusion-wave-routing">Approximating Diffusion Wave Routing<a class="anchor" aria-label="anchor" href="#approximating-diffusion-wave-routing"></a>
</h4>
<p>Diffuse routing with lateral inflow can be expressed as the parabolic
equation (see for example <a href="https://doi.org/10.1016/j.advwatres.2005.08.008" class="external-link">doi:10.1016/j.advwatres.2005.08.008</a>)</p>
<p><span class="math display">\[
\frac{dq}{dt} + c\frac{dq}{dx} - D \frac{d^2 q}{dx^2} = cl - D \frac{dl}{dx}
\]</span>
where <span class="math inline">\(l\)</span> is lateral inflow per unit length. Simplify this by
considering that the lateral inflow <span class="math inline">\(r\)</span> uniformly
distributed so that <span class="math inline">\(l=\frac{r}{\Delta x}\)</span> and <span class="math inline">\(\frac{dl}{dx}=0\)</span> to give</p>
<p><span class="math display">\[
\frac{dq}{dt} + c\frac{dq}{dx} - D \frac{d^2 q}{dx^2} = cl
\]</span></p>
<p>Let us relate this to the Muskingham Solution using the relationship
<span class="math display">\[
q = \eta q^{-} + \left(1-\eta\right) q^{+}
\]</span></p>
<p>Taking Taylor series expansions for <span class="math inline">\(q^{-}\)</span> and
<span class="math inline">\(q^{+}\)</span> based on <span class="math inline">\(q\)</span> gives</p>
<p><span class="math display">\[
q^{+} \approx q + \eta \Delta x \frac{dq}{dx} + \frac{1}{2}\eta^2\Delta x^2 \frac{d^2 q}{dx^2}
\]</span>
and
<span class="math display">\[
q^{-} \approx q - \left(1-\eta\right) \Delta x \frac{dq}{dx} + \frac{1}{2}\left(1-\eta\right)^2 \Delta x^2 \frac{d^2 q}{dx^2}
\]</span></p>
<p>Subtracting the expression for <span class="math inline">\(q^{-}\)</span> from that for <span class="math inline">\(q^{+}\)</span> gives</p>
<p><span class="math display">\[
q^{-} - q^{+} \approx
-\Delta x \frac{dq}{dx} +
\frac{1}{2}\left(1-2\eta\right) \Delta x^2 \frac{d^2 q}{dx^2}
\]</span></p>
<p>From the mass balance condition
<span class="math display">\[
\frac{ds}{dt} \approx \Delta x l -\Delta x \frac{dq}{dx} +
\frac{1}{2}\left(1-2\eta\right)\Delta x^2 \frac{d^2 q}{dx^2}
\]</span></p>
<p>Using the expression for storage and relationship between flow and area
<span class="math display">\[
\frac{dq}{dt} = \frac{dq}{da} \frac{da}{dt} = \frac{c}{\Delta x} \frac{ds}{dt}
\]</span></p>
<p>Then combining this with the approximation produces
<span class="math display">\[
\frac{dq}{dt} + c\frac{dq}{dx} -
\frac{c}{2}\left(1-2\eta\right)\Delta x \frac{d^2 q}{dx^2}
\approx c l
\]</span></p>
<p>Comparison to the original diffuse routing equation shows that
<span class="math display">\[
\eta \approx \frac{1}{2} - \frac{D}{c \Delta x}
\]</span></p>
<p>The value of <span class="math inline">\(\eta\)</span> is limited to between 0 and <span class="math inline">\(\frac{1}{2}\)</span>. Firstly <span class="math inline">\(\eta = 1/2\)</span> results from <span class="math inline">\(D=0\)</span>; that is the Kinematic wave equation. Taking <span class="math inline">\(\eta=0\)</span>
produces the maximum dispersion of <span class="math inline">\(D = \frac{c\Delta x}{2}\)</span>, which is given by
the linear tank.</p>
</div>
</div>
<div class="section level3">
<h3 id="numerical-scheme">Numerical scheme<a class="anchor" aria-label="anchor" href="#numerical-scheme"></a>
</h3>
<p>The numerical scheme is based on the implicit solution of</p>
<p><span class="math display">\[
\frac{ds}{dt} = q^{-} + r - \frac{1}{1-\eta}\left(\frac{sv}{\Delta x} - \eta q^{-}  \right)
\]</span></p>
<p>given by
<span class="math display">\[
s_{t+\Delta t} = s_{t} + \Delta t \left( q^{-}_{t+\Delta t} + r_{t+\Delta t} -
\frac{1}{1-\eta_{t+\Delta t}}\max\left(0,q_{t+\Delta t} - \eta_{t} q^{-}_{t+\Delta t}  \right) \right)
\]</span></p>
<p>where the maximum ensures that <span class="math inline">\(q^{+}_{t+\Delta t}\)</span> does not become negative. The
implementation outlines is equivalent to the addition of dispersion to
ensure non-negative outflows.</p>
<p>For known <span class="math inline">\(\eta_{t + \Delta t}\)</span> it is clear that the left hand side of the expression is
increasing and the right hand side decreasing so long as <span class="math inline">\(\frac{dq}{ds} = \frac{1}{\Delta x}\frac{dq}{da} \geq 0\)</span>. If <span class="math inline">\(\eta_{t+ \Delta t}\)</span> is a function of
<span class="math inline">\(s_{t+ \Delta t}\)</span> then it is required that
<span class="math display">\[
\frac{1}{\left(1-\eta\right)^{2}}\left(\frac{d\eta}{ds}\left(q-q^{-}\right) +
\left(1-\eta\right)\frac{dq}{ds}\right) \geq 0
\]</span>
A simpler, more general, semi-implicit solution is implemented in the code
where <span class="math inline">\(\eta_{t + \Delta t}\)</span> is taken to be a function of <span class="math inline">\(s_{t}\)</span>, hence a
known value.</p>
</div>
</div>
<div class="section level2">
<h2 id="finite-volume-formulation">Finite Volume Formulation<a class="anchor" aria-label="anchor" href="#finite-volume-formulation"></a>
</h2>
<p>In this section a finite volume formulation of the Dynamic TOPMODEL equations
is derived for the evolution of the states over the time step <span class="math inline">\(t\)</span> to <span class="math inline">\(t + \Delta t\)</span>. The lateral flux rates are considered at the start and end of the
time step. The vertical flux rates are considered as constant throughout the
time step, allowing for a semi-analytical solution of some storage zones.</p>
<div class="section level3">
<h3 id="surface-zone-1">Surface zone<a class="anchor" aria-label="anchor" href="#surface-zone-1"></a>
</h3>
<p>The storage in the surface zone satisfies the mass balance equation</p>
<p><span class="math display">\[
\frac{ds_{sf}}{dt} = q^{-}_{sf} - r_{sf \rightarrow rz} - q^{+}_{sf}
\]</span></p>
<p>where surface storage is increased by lateral downslope flow from upslope HRUs.
Water flows to the root zone at a constant rate <span class="math inline">\(r_{sf \rightarrow rz}\)</span>, unless limited by
the available storage at the surface or the ability of the root zone to
receive water (for example if the saturation storage deficit is 0 and the root zone storage is full).</p>
<p>In cases where lateral flows in the saturated zone produce
saturation storage deficits water may be returned from the root
zone to the surface giving negative values of <span class="math inline">\(r_{sf \rightarrow rz}\)</span>.</p>
<p>To determine the outflow <span class="math inline">\(q^{+}_{sf}\)</span> a second relationship between
<span class="math inline">\(q^{-}_{sf}\)</span>, <span class="math inline">\(s_{sf}\)</span> and <span class="math inline">\(q^{+}_{sf}\)</span> is required. This is given by the
Muskingham formulation where
<span class="math display">\[
\mathcal{F}\left(s_{sf},\Theta_{sf}\right) = q_{sf} = \eta_{sf}q_{sf}^{-} +
\left(1-\eta_{sf}\right)q_{sf}^{+}
\]</span>
and
<span class="math display">\[
\mathcal{F}_{\eta}\left(s_{sf},\Theta_{sf}\right) = \eta_{sf}
\]</span></p>
<p>The different formulation available in the model are given in Table
<a href="#tab:surface">2</a> with their parameters outlined in Table
<a href="#tab:surface-param">3</a></p>
<table class="table">
<caption>
<span id="tab:surface">Table 2: </span> Outline formulations for the storage-flow relationship in the surface zone.</caption>
<colgroup>
<col width="0%">
<col width="10%">
<col width="5%">
<col width="33%">
<col width="7%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>Description</th>
<th>Parameters</th>
<th><span class="math inline">\(\mathcal{F}\left(s_{sf},\Theta_{sf}\right)\)</span></th>
<th><span class="math inline">\(\mathcal{F}_{\eta}\left(s_{sf},\Theta_{sf}\right)\)</span></th>
<th><span class="math inline">\(q_{sf}^{+}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>cnst</td>
<td>Linear Tank coupled below a constant parameter diffusive wave solution</td>
<td><span class="math inline">\(t_{raf}, s_{raf},c_{sf}, d_{sf}\)</span></td>
<td><span class="math display">\[ \left\{ \begin{array}{cl} \frac{s_{sf}}{t_{raf}} &amp; s_{sf} \leq s_{raf} \\ \frac{s_{raf}}{t_{raf}} + \frac{c_{sf}}{\Delta x}(s_{sf}-s_{raf}) &amp; \mathrm{otherwise} \end{array} \right.\]</span></td>
<td><span class="math inline">\(\frac{1}{2} - \frac{d_{sf}}{c_{sf}\Delta x}\)</span></td>
<td><span class="math display">\[ \left\{ \begin{array}{cl} \frac{s_{sf}}{t_{raf}} &amp; s_{sf} \leq s_{raf} \\ \frac{s_{raf}}{t_{raf}} + \frac{ \frac{c_{sf}}{\Delta x}(s_{sf}-s_{raf}) - \eta_{sf}\max\left(0,q_{sf}^{-}- \frac{s_{raf}}{t_{raf}}\right)}{1-\eta_{sf}}&amp; \mathrm{otherwise} \end{array} \right.\]</span></td>
</tr>
<tr class="even">
<td>kin</td>
<td>Linear tank with Kinematic Wave for remaining flow</td>
<td><span class="math inline">\(t_{raf}, s_{raf}, n, w_{sf}, g_{sf}\)</span></td>
<td><span class="math display">\[ \left\{ \begin{array}{cl} \frac{s_{sf}}{t_{raf}} &amp; s_{sf} \leq s_{raf} \\ \frac{s_{raf}}{t_{raf}} + \frac{g_{sf}^{1/2}}{n w_{sf}^{2/3}} \left(\frac{s_{sf}-s_{raf}}{\Delta x}\right)^{5/3} &amp; \mathrm{otherwise} \end{array} \right.\]</span></td>
<td><span class="math inline">\(\frac{1}{2}\)</span></td>
<td><span class="math display">\[ \left\{ \begin{array}{cl} \frac{s_{sf}}{t_{raf}} &amp; s_{sf} \leq s_{raf} \\ \frac{s_{raf}}{t_{raf}} + 2\frac{g_{sf}^{1/2}}{n w_{sf}^{2/3}} \left(\frac{s_{sf}-s_{raf}}{\Delta x}\right)^{5/3} - \max\left(0,q_{sf}^{-}- \frac{s_{raf}}{t_{raf}}\right) &amp; \mathrm{otherwise} \end{array} \right.\]</span></td>
</tr>
</tbody>
</table>
<table class="table">
<caption>
<span id="tab:surface-param">Table 3: </span> Parameters used in the surface zone storage-flow
relationships.</caption>
<colgroup>
<col width="14%">
<col width="65%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th>Symbol</th>
<th>Description</th>
<th>unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(t_{raf}\)</span></td>
<td>Time constant of the runoff attenuation feature</td>
<td>s</td>
</tr>
<tr class="even">
<td><span class="math inline">\(c_{sf}\)</span></td>
<td>Free flowing surface water velocity</td>
<td>ms<span class="math inline">\(^{-1}\)</span>
</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(s_{raf}\)</span></td>
<td>storage of the runoff attenuation feature</td>
<td>m<span class="math inline">\(^3\)</span>
</td>
</tr>
<tr class="even">
<td><span class="math inline">\(d_{sf}\)</span></td>
<td>Free flowing surface water diffusion rate</td>
<td>m<span class="math inline">\(^2\)</span>s<span class="math inline">\(^{-1}\)</span>
</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(w_{sf}\)</span></td>
<td>Width of surface channel</td>
<td>m</td>
</tr>
<tr class="even">
<td><span class="math inline">\(g_{sf}\)</span></td>
<td>Gradient of surface channel</td>
<td>-</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(n\)</span></td>
<td>Manning <span class="math inline">\(n\)</span> coefficent for roughness</td>
<td>sm<span class="math inline">\(^{-1/3}\)</span>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="root-zone">Root zone<a class="anchor" aria-label="anchor" href="#root-zone"></a>
</h3>
<p>The root zone gains water from precipitation and the surface zone. It loses water through
evaporation and to the unsaturated zone. All vertical fluxes are
considered to be spatially uniform. The root zone storage satisfies</p>
<p><span class="math display">\[\begin{equation} 0 \leq s_{rz} \leq s_{rzmax} \end{equation}\]</span></p>
<p>with the governing ODE
<span class="math display">\[\begin{equation}
\frac{ds_{rz}}{dt} = p - \frac{e_p}{s_{rzmax}} s_{rz} +
r_{sf\rightarrow rz} - r_{rz \rightarrow uz}
\end{equation}\]</span></p>
<p>Fluxes from the surface and to the unsaturated zone are
controlled by the level of root zone storage along with the state of the unsaturated
and saturated zones.</p>
<p>For <span class="math inline">\(s_{rz} \leq s_{rzmax}\)</span> then <span class="math inline">\(r_{rz \rightarrow uz} \leq 0\)</span>. Negative
values of <span class="math inline">\(r_{rz \rightarrow uz}\)</span> may occur only when water is returned from the
unsaturated zone due to saturation caused by lateral inflow to the saturated zone.</p>
<p>When <span class="math inline">\(s_{rz} = s_{rzmax}\)</span> then
<span class="math display">\[\begin{equation}
p - e_p + r_{sf\rightarrow rz} - r_{rz \rightarrow uz} \leq 0
\end{equation}\]</span>
In this case <span class="math inline">\(r_{rz \rightarrow uz}\)</span> may be positive if
<span class="math display">\[\begin{equation}
p - e_p + r_{sf\rightarrow rz} &gt; 0
\end{equation}\]</span>
so long as the unsaturated zone can receive the water. If <span class="math inline">\(r_{rz \rightarrow uz}\)</span> is ‘throttled’ by the rate at which the unsaturated zone can
receive water, then <span class="math inline">\(r_{sf\rightarrow rz}\)</span> is adjusted (potentially becoming
negative) to ensure the equality is met.</p>
</div>
<div class="section level3">
<h3 id="unsaturated-zone">Unsaturated Zone<a class="anchor" aria-label="anchor" href="#unsaturated-zone"></a>
</h3>
<p>The unsaturated zone acts as a non-linear tank subject to the constraint
<span class="math display">\[\begin{equation} 0 \leq s_{uz} \leq s_{sz} \end{equation}\]</span></p>
<p>The governing ODE is written as
<span class="math display">\[\begin{equation}
\frac{ds_{uz}}{dt} = r_{rz \rightarrow uz} - \frac{A s_{uz}}{T_d s_{sz}}
\end{equation}\]</span></p>
<p>If water is able to pass freely to the saturated zone, then it flows at the rate
<span class="math inline">\(\frac{A s_{uz}}{T_d s_{sz}}\)</span>.
In the situation where <span class="math inline">\(s_{sz}=s_{uz}\)</span> the subsurface below
the root zone can be considered saturated, as in there is no further available
storage for water, but separated into parts: an upper part with vertical
flow and a lower part with lateral flux.</p>
<p>It is possible that the downward flux is constrained by the ability of the saturated zone to receive water. If
this is the case <span class="math inline">\(r_{uz \rightarrow sz}\)</span> occurs at the maximum
possible rate and <span class="math inline">\(r_{rz \rightarrow uz}\)</span> is limited to ensure that
<span class="math inline">\(s_{uz} \leq s_{sz}\)</span>.</p>
</div>
<div class="section level3">
<h3 id="saturated-zone">Saturated Zone<a class="anchor" aria-label="anchor" href="#saturated-zone"></a>
</h3>
<p>For a HRU the alteration of the storage in the saturated zone is
given by the kinematic equation implemented through the Muskingham
approximation. This gives a mass balance equation considered
in terms of storage deficits as:</p>
<p><span class="math display">\[
\frac{ds_{sz}}{dt} = q^{+}_{sz} - r_{sf \rightarrow rz} - q^{-}_{sz}
\]</span>
with the relationships between the flows and storage given by
and
<span class="math display">\[
q_{sz} = \mathcal{G}\left(s_{sz},\Theta_{sz}\right) \\
q_{sz}^{+} = 2q_{sz} - q_{sz}^{-}
\]</span>
Not that the assumption of increasing flow with storage means that
<span class="math display">\[
- \frac{d}{ds_{sz}} \mathcal{G}\left(s_{sz},\Theta_{sz}\right) \geq 0
\]</span></p>
<p>The function <span class="math inline">\(\mathcal{G}\left(s_{sz},\Theta_{sz}\right)\)</span> is related to the
HRU width through the transmissivity function. Table
<a href="#tab:hs-transmissivity">4</a> gives <span class="math inline">\(\mathcal{G}\left(s_{sz},\Theta_{sz}\right)\)</span> for various the transmissivity profiles present as options within the <code>dynatop</code>
package, the corresponding value to use for the <code>type</code> value
in the saturated zone specification and the additional parameters
required. The additional parameters are defined in Table <a href="#tab:hs-transmissivity-param">5</a>.</p>
<table style="width:100%;" class="table">
<caption>
<span id="tab:hs-transmissivity">Table 4: </span> Transmissivity profiles available with the <code>dynatop</code> package.</caption>
<colgroup>
<col width="6%">
<col width="54%">
<col width="8%">
<col width="4%">
<col width="24%">
<col width="0%">
</colgroup>
<thead><tr class="header">
<th>Name</th>
<th><span class="math inline">\(G\left(\bar{s}_{sz},\Theta_{sz}\right)\)</span></th>
<th><span class="math inline">\(\Theta_{sz}\)</span></th>
<th>
<code>type</code> value</th>
<th>Notes</th>
<th></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Exponential</td>
<td><span class="math inline">\(T_{0}w\sin\left(\beta\right)\exp\left(-\frac{\cos\beta}{Am}s_{sz}\right)\)</span></td>
<td><span class="math inline">\(T_0,\beta,m\)</span></td>
<td>exp</td>
<td>Originally given in <a href="https://doi.org/10.1002/hyp.252" class="external-link">Beven &amp; Freer 2001</a>
</td>
<td></td>
</tr>
<tr class="even">
<td>Bounded Exponential</td>
<td><span class="math inline">\(T_{0}w\sin\left(\beta\right)\left(\exp\left(-\frac{\cos\beta}{Am}s_{sz}\right) - \exp\left(-\frac{\cos\beta}{m}D\right)\right)\)</span></td>
<td><span class="math inline">\(T_0,\beta,m,D\)</span></td>
<td>bexp</td>
<td>Originally given in <a href="https://doi.org/10.1002/hyp.252" class="external-link">Beven &amp; Freer 2001</a>
</td>
<td></td>
</tr>
<tr class="odd">
<td>Constant Celerity</td>
<td><span class="math inline">\(\frac{c_{sz}w}{A}\left(AD-s_{sz}\right)\)</span></td>
<td><span class="math inline">\(c_{sz},D\)</span></td>
<td>cnst</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Double Exponential</td>
<td><span class="math inline">\(T_{0}w\sin\left(\beta\right)\left( \omega\exp\left(-\frac{\cos\beta}{Am}s_{sz}\right) + \left(1-\omega\right)\exp\left(\frac{\cos\beta}{Am_2}s_{sz}\right)\right)\)</span></td>
<td><span class="math inline">\(T_0,\beta,m,m_2,\omega\)</span></td>
<td>dexp</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<table class="table">
<caption>
<span id="tab:hs-transmissivity-param">Table 5: </span> Additional parameters used in the transmissivity profiles.</caption>
<colgroup>
<col width="15%">
<col width="70%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th>Symbol</th>
<th>Description</th>
<th>unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(T_0\)</span></td>
<td>Transmissivity at saturation</td>
<td>m<span class="math inline">\(^2\)</span>/s</td>
</tr>
<tr class="even">
<td>
<span class="math inline">\(m\)</span>,<span class="math inline">\(m_2\)</span>
</td>
<td>Exponential transmissivity constants</td>
<td>m<span class="math inline">\(^{-1}\)</span>
</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\beta\)</span></td>
<td>Angle of hill slope</td>
<td>rad</td>
</tr>
<tr class="even">
<td><span class="math inline">\(c_{sz}\)</span></td>
<td>Saturated zone celerity</td>
<td>m/s</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(D\)</span></td>
<td>Storage deficit at which zero lateral flow occurs</td>
<td>m</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\omega\)</span></td>
<td>weighting parameter</td>
<td>-</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="numerical-solution">Numerical Solution<a class="anchor" aria-label="anchor" href="#numerical-solution"></a>
</h2>
<p>No analytical solution yet exists for simultaneous integration of the system of
ODEs outlined above. In the following an implicit scheme, where fluxes
between stores are considered constant over the time step and gradients are
evaluated at the final state, is presented.</p>
<p>The basis of the solution is that a gravity driven system will maximise
the downward flow of water within each timestep of size <span class="math inline">\(\Delta t\)</span>. Hence on
the first downward pass through the stores the maximum downward volumes of the vertical
fluxes <span class="math inline">\(\hat{v}_{* \rightarrow *} = \Delta t \hat{r}_{* \rightarrow *}\)</span> are determined. These then moderated by the
solution of the saturated zone, with an upward pass gives the final states.</p>
<div class="section level3">
<h3 id="downward-pass">Downward Pass<a class="anchor" aria-label="anchor" href="#downward-pass"></a>
</h3>
<div class="section level4">
<h4 id="surface-excess">Surface excess<a class="anchor" aria-label="anchor" href="#surface-excess"></a>
</h4>
<p>The implicit solution of the Muskingham methodology gives</p>
<p><span class="math display">\[
\left. s_{sf} \right\rvert_{t+\Delta t} = \left. s_{sf} \right\rvert_{t} +
\Delta t
\left( \left. q_{sf}^{-} \right\rvert_{t+\Delta t} -
\frac{1}{1 - \left. \eta_{sf} \right\rvert_{t+\Delta t} }
\max\left(0,
\left. q_{sf} \right\rvert_{t+\Delta t} -
\left. \eta_{sf} \right\rvert_{t+\Delta t}
\left. q_{sf}^{-} \right\rvert_{t+\Delta t}
\right) \right) -
\left. v_{sf \rightarrow rz} \right\rvert_{t+\Delta t}
\]</span></p>
<p>So the maximum downward flux volume is
<span class="math display">\[
\left. \hat{v}_{sf \rightarrow rz} \right\rvert_{t+\Delta t} =  \left. s_{sf}
\right\rvert_{t} + \Delta t \left. q_{sf}^{-} \right\rvert_{t+\Delta t}
\]</span></p>
</div>
<div class="section level4">
<h4 id="root-zone-1">Root Zone<a class="anchor" aria-label="anchor" href="#root-zone-1"></a>
</h4>
<p>The implicit formulation for the root zone gives
<span class="math display">\[\begin{equation}
\left. s_{rz} \right.\rvert_{t + \Delta t} =
\left( 1 + \frac{e_{p}\Delta t}{s_{rzmax}} \right)^{-1}
\left(
\left. s_{rz} \right.\rvert_{0}
+ \Delta t p +
v_{sf \rightarrow rz} - v_{rz \rightarrow uz} \right)
\end{equation}\]</span></p>
<p>Since flow to the unsaturated zone occur only to keep
<span class="math inline">\(s_{rz} \leq s_{rzmax}\)</span> then
<span class="math display">\[\begin{equation}
\hat{v}_{rz \rightarrow uz} = \max\left(0,
\left. s_{rz} \right.\rvert_{0}
+ \Delta t \left( p -e_{p}\right)
+ \hat{v}_{sf \rightarrow rz}
- s_{rzmax}
\right)
\end{equation}\]</span></p>
</div>
<div class="section level4">
<h4 id="unsaturated-zone-1">Unsaturated Zone<a class="anchor" aria-label="anchor" href="#unsaturated-zone-1"></a>
</h4>
<p>The implicit expression for the unsaturated zone is given in terms of
<span class="math inline">\(\left. s_{uz} \right.\rvert_{t+\Delta t}\)</span> and
<span class="math inline">\(\left. s_{sz} \right.\rvert_{t+\Delta t}\)</span> as</p>
<p><span class="math display">\[\begin{equation}
\left. s_{uz} \right.\rvert_{t+\Delta t} =
\frac{T_{d}\left. s_{sz} \right.\rvert_{t+\Delta t}}{
T_{d}\left. s_{sz} \right.\rvert_{t+\Delta t} + A \Delta t}
\left( \left. s_{uz} \right.\rvert_{t} +
v_{rz \rightarrow uz}\right)
\end{equation}\]</span></p>
<p>Since <span class="math inline">\(\left. s_{uz} \right.\rvert_{t+\Delta t} \leq \left. s_{sz}  \right.\rvert_{t+\Delta t}\)</span> this places an additional condition of
<span class="math display">\[\begin{equation}
\left. s_{uz} \right.\rvert_{t} + v_{rz \rightarrow uz} \leq
\left. s_{sz} \right.\rvert_{t+\Delta t} + \frac{A \Delta t}{T_d}
\end{equation}\]</span></p>
<p>By mass balance this gives the maximum downward flux volume as
<span class="math display">\[
\hat{v}_{uz \rightarrow sz} = A\Delta t \min\left(
\frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}
{T_{d}\left. s_{sz} \right.\rvert_{t+\Delta t} + A \Delta t}, \frac{1}{T_{d}} \right)
\]</span></p>
<p>This is a function of <span class="math inline">\(\left. s_{sz} \right.\rvert_{t+\Delta t}\)</span>.</p>
</div>
<div class="section level4">
<h4 id="saturated-zone-1">Saturated Zone<a class="anchor" aria-label="anchor" href="#saturated-zone-1"></a>
</h4>
<p>Building on the generic solution the implicit scheme for the Muskingham model gives</p>
<p><span class="math display">\[
\left. s_{sz} \right\rvert_{t+\Delta t} = \left. s_{sz} \right\rvert_{t} -
\Delta t  \left. q_{sz}^{-} \right\rvert_{t+\Delta t} -
\left. v_{uz \rightarrow sz} \right\rvert_{t+\Delta t} +
\Delta t \min\left(q_{sz}^{max},\max\left( 0, 2 \left. q_{sz} \right\rvert_{t+\Delta t} - \left. q_{sz}^{-}
\right\rvert_{t+\Delta t}
\right)\right)
\]</span></p>
<p>where the maxima stops the outflow becoming negative. The minima derives from
a further condition on the saturated zone; based on the maximum outflow give by
<span class="math inline">\(f_{sz}\left(0\right) = q_{sz}^{max}\)</span>. Applying this flow limit to every
cross section of the saturated zone mean <span class="math inline">\(q_{sz}^{-}\leq q_{sz}^{max}\)</span> and
<span class="math inline">\(q_{sz}^{+}\leq q_{sz}^{max}\)</span>.
The inflow inequality to handled by reassigning an inflow greater then the
limit to the surface inflow. The outflow inequality results in the
minima.</p>
<p>Alternatively the upper flow limit could be evaluated by finding
<span class="math inline">\(s_{sz}^{max}\)</span> for which
<span class="math display">\[
\mathcal{G}\left(s_{sz}^{max},\Theta_{sz}\right) = \frac{
q_{sz}^{max} + \left. q_{sz}^{-}\right\rvert_{t+\Delta t} }{2}
\]</span>
and treating this as the saturated deficit at which point water is returned from
the saturated to unsaturated zone. In contrast to this the minima solution
holds the water in the saturated zone. This is preferred both conceptually,
since the water remains immediately available for future lateral flow, and also
computationally since it avoids the need to invert the function relating
storage to flow.</p>
<p>Consider the pseudo-function
<span class="math display">\[
\mathcal{H}\left(z\right) =
z -
\left. s_{sz}\right.\rvert_{t} +
\Delta t  \left. q_{sz}^{-} \right\rvert_{t+\Delta t} +
A\Delta t \min\left(
\frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}
{T_{d}z + A \Delta t}, \frac{1}{T_{d}} \right) - \\
\Delta t \min\left(q_{sz}^{max},\max\left( 0, 2 \mathcal{G}\left(z,\Theta_{sz}\right) - \left. q_{sz}^{-}
\right\rvert_{t+\Delta t}
\right)\right)
\]</span></p>
<p>adapted from the approximating equation for the saturated zone storage.
In Appendix A it is
shown that <span class="math inline">\(\mathcal{H}\left(z\right)\)</span> is a monotonic increasing function of
<span class="math inline">\(z &gt; 0\)</span> and <span class="math inline">\(\mathcal{H}\left(D\right) \geq 0\)</span>.
Hence if <span class="math inline">\(\mathcal{H}\left(0\right) \lt 0\)</span> unique solution for
<span class="math inline">\(\left. s_{sz}\right.\rvert_{\Delta t}\)</span> can be found.
If <span class="math inline">\(\mathcal{H}\left(0\right) \geq 0\)</span> then the incoming fluxes are enough to
produce saturation in the subsurface and
<span class="math inline">\(\left. s_{sz}\right.\rvert_{\Delta t} = 0\)</span>.</p>
<p>Maintaining a water (mass) balance and
correct limits on the state values
depends upon the accuracy of the solution of
<span class="math inline">\(\mathcal{H}\left(z\right)=0\)</span>. Since each evaluation of
<span class="math inline">\(\mathcal{H}\left(z\right)\)</span> requires an evaluation of the transmissivity
profile the search for <span class="math inline">\(z\)</span> such that <span class="math inline">\(\mathcal{H}\left(z\right)=0\)</span> can
rapidly become the most expensive part of the code.</p>
<p>Use of a numerical scheme which allows mass balance to maintained
regardless of the accuracy of the solution of <span class="math inline">\(\mathcal{H}\left(z\right)=0\)</span>
allows scope for compromises based on computational time.
If <span class="math inline">\(\mathcal{H}\left(z\right)=0\)</span> is
solved by a bracketing algorithm then at each iteration the lower and upper
limits of the bracket satisfy <span class="math inline">\(z^{l} &lt; \left. s_{sz}\right.\rvert_{\Delta t} &lt; z^{u}\)</span>. Iterating until; for some
tolerance <span class="math inline">\(\epsilon&gt;0\)</span>; <span class="math inline">\(z^{u} - z^{l} &lt; \epsilon\)</span> take <span class="math inline">\(\left. s_{sz}\right.\rvert_{\Delta t} = z^{u}\)</span>. In both is
and the saturated case <span class="math inline">\(\mathcal{H}\left(\left. s_{sz}\right.\rvert_{\Delta t}\right)&gt;0\)</span> and the upward pass can proceed as outlined in the following
section without compromising the mass conservation.</p>
</div>
</div>
<div class="section level3">
<h3 id="upward-pass">Upward Pass<a class="anchor" aria-label="anchor" href="#upward-pass"></a>
</h3>
<p>Given an estimate of <span class="math inline">\(\left. s_{sz}\right.\rvert_{\Delta t}\)</span> such that
<span class="math inline">\(\mathcal{H}\left(\left. s_{sz}\right.\rvert_{\Delta t}\right)&gt;0\)</span> compute the
vertical flux volumes in the following fashion</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(\left. q_{sz}^{+}\right.\rvert_{t+\Delta t} = \min\left(q_{sz}^{max},\max\left( 0, 2 \mathcal{G}\left(\left. s_{sz}\right.\rvert_{t+\Delta t},\Theta_{sz}\right) - \left. q_{sz}^{-} \right\rvert_{t+\Delta t} \right)\right)\)</span></li>
<li><span class="math inline">\(v_{uz \rightarrow sz} = \left. s_{sz}\right.\rvert_{t} + \Delta t \left(\left. q_{sz}^{+}\right.\rvert_{t+\Delta t} - \left. q_{sz}^{-} \right\rvert_{t+\Delta t}\right) - \left. s_{sz}\right.\rvert_{t+\Delta t}\)</span></li>
<li><span class="math inline">\(\left. s_{uz}\right.\rvert_{t+\Delta t} = \min\left(\left. s_{sz}\right.\rvert_{t+\Delta t},\left. s_{uz}\right.\rvert_{t} + \hat{v}_{rz \rightarrow uz} - v_{uz \rightarrow sz}\right)\)</span></li>
<li><span class="math inline">\(v_{rz \rightarrow uz} = \left. s_{uz}\right.\rvert_{t+\Delta t} -\left. s_{uz}\right.\rvert_{t} + v_{uz \rightarrow sz}\)</span></li>
<li><span class="math inline">\(v_{sf \rightarrow rz} = \min\left(\hat{v}_{sf \rightarrow rz}, s_{rzmax} - \left. \bar{s}_{rz} \right.\rvert_{0} - \Delta t \left( p - e_p \right) + {v}_{rz  \rightarrow uz} \right)\)</span></li>
<li>Solve for <span class="math inline">\(\left. s_{rz}\right.\rvert_{t+\Delta t}\)</span> using the equation
already given.</li>
<li>Compute the volume loss to evapotranspiration as
<span class="math inline">\(\left. v_{e_{p}}\right.\rvert_{t+\Delta t} = \left. s_{rz}\right.\rvert_{t} + v_{sf \rightarrow rz} - v_{rz \rightarrow uz} + \Delta t p - \left. s_{rz}\right.\rvert_{t+\Delta t}\)</span>
</li>
</ol>
<p>This leaves the solution of the surface zone</p>
<div class="section level4">
<h4 id="surface-zone-2">Surface Zone<a class="anchor" aria-label="anchor" href="#surface-zone-2"></a>
</h4>
<p>For the surface zone we take a semi implicit scheme where <span class="math inline">\(\eta_{sf}\)</span> is
evaluated with the initial state giving
<span class="math display">\[
\left. \eta_{sf} \right\rvert_{t+\Delta t} = \mathcal{F}_{\eta}\left(\left. s_{sf} \right\rvert_{t},\Theta_{sf}\right)
\]</span></p>
<p>Proceeding in a similar fashion to the saturated zone consider the pseudo-function
<span class="math display">\[
\mathcal{S}\left(w\right) =
\left. s_{sf} \right\rvert_{t} +
\Delta t
\left( \left. q_{sf}^{-} \right\rvert_{t+\Delta t} -
\frac{1}{1 - \left. \eta_{sf} \right\rvert_{t+\Delta t} }
\max\left(0,
\mathcal{F}\left(w,\Theta_{sf}\right) -
\left. \eta_{sf} \right\rvert_{t+\Delta t}
\left. q_{sf}^{-} \right\rvert_{t+\Delta t}
\right) \right) -
\left. v_{sf \rightarrow rz} \right\rvert_{t+\Delta t} - w
\]</span>
which is monotonically decreasing for <span class="math inline">\(w \geq 0\)</span> with
<span class="math inline">\(\mathcal{S}\left(0\right)\geq 0\)</span>.</p>
<p>A bracketing solution algorithm gives at any iteration <span class="math inline">\(w^{l} &lt; \left. s_{sf} \right\rvert_{t+\Delta t} &lt; w^{u}\)</span>. An initial value of <span class="math inline">\(w^{u}\)</span> can be computed
as <span class="math inline">\(\left. s_{sf} \right\rvert_{t} + \Delta t\left. q_{sf}^{-} \right\rvert_{t+\Delta t} - \left. v_{sf \rightarrow rz} \right\rvert_{t+\Delta t}\)</span>. Iterating until; for some
tolerance <span class="math inline">\(\epsilon&gt;0\)</span>; <span class="math inline">\(w^{u} - w^{l} &lt; \epsilon\)</span> take <span class="math inline">\(\left. s_{sf}\right.\rvert_{\Delta t} = w^{l}\)</span>.
In this case <span class="math inline">\(\mathcal{S}\left(\left. s_{sf}\right.\rvert_{\Delta t}\right) &gt; 0\)</span> hence mass conservation can be maintained by taking
<span class="math display">\[
\left. q_{sf}^{+} \right\rvert_{t+\Delta t} =
\left. q_{sf}^{-} \right\rvert_{t+\Delta t} +
\frac{1}{\Delta t}\left(
\left. s_{sf} \right\rvert_{t} -
\left. v_{sf \rightarrow rz} \right\rvert_{t+\Delta t} -
\left. s_{sf}\right.\rvert_{t + \Delta t}\right)
\]</span></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="appendix-a---monotonicity-of-mathcalhleftzright">Appendix A - Monotonicity of <span class="math inline">\(\mathcal{H}\left(z\right)\)</span><a class="anchor" aria-label="anchor" href="#appendix-a---monotonicity-of-mathcalhleftzright"></a>
</h2>
<p>By definition <span class="math inline">\(\left. s_{uz} \right.\rvert_{t}\)</span>, <span class="math inline">\(\Delta t\)</span>, A, <span class="math inline">\(T_d\)</span>, <span class="math inline">\(\hat{v}_{rz \rightarrow uz}\)</span> and <span class="math inline">\(z\)</span> are all greater or equal to 0. To show that the
gradient of</p>
<p><span class="math display">\[
\mathcal{H}\left(z\right) =
z -
\left. s_{sz}\right.\rvert_{t} +
\Delta t  \left. q_{sz}^{-} \right\rvert_{t+\Delta t} +
A\Delta t \min\left(
\frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}
{T_{d}z + A \Delta t}, \frac{1}{T_{d}} \right) - \\
\Delta t \min\left(q_{sz}^{max},\max\left( 0, 2 \mathcal{G}\left(z,\Theta_{sz}\right) - \left. q_{sz}^{-}
\right\rvert_{t+\Delta t}
\right)\right)
\]</span></p>
<p>is strictly positive consider first the gradient of the last term which takes
the value</p>
<p><span class="math display">\[
\frac{d}{dz} \min\left(q_{sz}^{max},\max\left( 0, 2 \mathcal{G}\left(z,\Theta_{sz}\right) - \left. q_{sz}^{-}
\right\rvert_{t+\Delta t}
\right)\right) = \left\{ \begin{array}{cl}
0 &amp; 2 \mathcal{G}\left(z,\Theta_{sz}\right) &lt; \left. q_{sz}^{-} \right\rvert_{t+\Delta t}\\
0 &amp; 2 \mathcal{G}\left(z,\Theta_{sz}\right) - \left. q_{sz}^{-} \right\rvert_{t+\Delta t}&gt; q_{sz}^{max} \\
2 \frac{d}{dz} \mathcal{G}\left(z,\Theta_{sz}\right) &amp; \mathrm{otherwise}
\end{array}
\right.
\]</span></p>
<p>By definition <span class="math inline">\(-\frac{d}{dz} \mathcal{G}\left(z,\Theta_{sz}\right) \geq 0\)</span>
hence</p>
<p><span class="math display">\[
\frac{d}{dz} \mathcal{H}\left(z\right) \geq
1 +
A\Delta t \frac{d}{dz} \min\left(
\frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}
{T_{d}z + A \Delta t}, \frac{1}{T_{d}} \right)
\]</span></p>
<p>Separating the range of <span class="math inline">\(z\)</span> into two sections gives</p>
<p><span class="math display">\[
\frac{d}{dz} \mathcal{H}\left(z\right) \geq \left\{ \begin{array}{cl}
1 &amp; \frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}
{T_{d}z + A \Delta t} \geq \frac{1}{T_{d}} \\
1 - T_{d} A\Delta t
\frac{\left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}}
{\left(T_{d}z + A \Delta t\right)^2} &amp; frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}{T_{d}z + A \Delta t} \leq
\frac{1}{T_{d}}
\end{array}
\right.
\]</span></p>
<p>Further using the range of <span class="math inline">\(z\)</span> valid for the second case</p>
<p><span class="math display">\[
\frac{d}{dz} \mathcal{H}\left(z\right) \geq \left\{ \begin{array}{cl}
1 &amp; \frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}
{T_{d}z + A \Delta t} \geq \frac{1}{T_{d}} \\
1 - \frac{A\Delta t}{T_{d}z + A \Delta t} &amp; \frac{\left( \left. s_{uz} \right.\rvert_{t} + \hat{v}_{rz \rightarrow uz}\right)}{T_{d}z + A \Delta t} \leq
\frac{1}{T_{d}}
\end{array}
\right.
\]</span></p>
<p>From this it can be seen that <span class="math inline">\(\frac{d}{dz} \mathcal{H}\left(z\right) \geq 0\)</span> with
equality possible when <span class="math inline">\(z=0\)</span>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Paul Smith, Peter Metcalfe.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
