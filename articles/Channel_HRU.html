<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Channel HRU â€¢ dynatop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Channel HRU">
<meta property="og:description" content="dynatop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9035</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dynatop.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Channel_HRU.html">Channel HRU</a>
    </li>
    <li>
      <a href="../articles/Hillslope_HRU.html">The Hillslope HRU</a>
    </li>
    <li>
      <a href="../articles/Notes_on_the_implementation_of_Dynamic_TOPMODEL.html">Notes on the implementation of Dynamic TOPMODEL</a>
    </li>
    <li>
      <a href="../articles/Selected_References.html">Selected References</a>
    </li>
    <li>
      <a href="../articles/The_Model_Object.html">The Model Object</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatop/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Channel HRU</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatop/blob/master/vignettes/Channel_HRU.Rmd"><code>vignettes/Channel_HRU.Rmd</code></a></small>
      <div class="hidden name"><code>Channel_HRU.Rmd</code></div>

    </div>

    
    
<p>The <code>dynatop</code> function in the dynamic TOPMODEL R package implements a set of numerical solutions to the
governing equations of the dynamic TOPMODEL hillslope formulation. This
returns the inflow to the channel reachs specified in the model.
This vignette documents the formulation and the numerical solution used to
route these channel inflows, along with other diffuse and point inputs to the
model.</p>
<div id="notation-and-nomenclature" class="section level1">
<h1 class="hasAnchor">
<a href="#notation-and-nomenclature" class="anchor"></a>Notation and nomenclature</h1>
<p>Table @ref(tab:ch-notation} outlines the notation used in this document.</p>
<table class="table">
<caption>
<span id="tab:ch-notation">Table 1: </span> Outline of notation for describing the Channel HRU
section of the hillslope HRU</caption>
<colgroup>
<col width="15%">
<col width="10%">
<col width="63%">
<col width="10%">
</colgroup>
<thead><tr class="header">
<th>Quantity type</th>
<th align="center">Symbol</th>
<th>Description</th>
<th align="center">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Dischage from a reach at time <span class="math inline">\(t\)</span>
</td>
<td align="center"><span class="math inline">\(q\left(t\right)\)</span></td>
<td>Instananeous discharge</td>
<td align="center">m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="even">
<td>Dischage from a reach at time <span class="math inline">\(t\)</span>
</td>
<td align="center"><span class="math inline">\(g\left(t\right)\)</span></td>
<td>Instananeous discharge</td>
<td align="center">m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="odd">
<td>Diffuse inflow</td>
<td align="center"><span class="math inline">\(d\left(t\right)\)</span></td>
<td>Instantaneous inflow from diffuse inputs to the channel HRU</td>
<td align="center">m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="even">
<td>Point inflow</td>
<td align="center"><span class="math inline">\(p\left(t\right)\)</span></td>
<td>Instantaneous inflow from a point source to the head of the Channel HRU</td>
<td align="center">m<span class="math inline">\(^3\)</span>/s</td>
</tr>
<tr class="odd">
<td>Velocity</td>
<td align="center"><span class="math inline">\(v_{ch}\)</span></td>
<td>Effective velocity of water convience within the Channel HRUnetwork</td>
<td align="center">m/s</td>
</tr>
</tbody>
</table>
</div>
<div id="inputs-to-a-channel-hru" class="section level1">
<h1 class="hasAnchor">
<a href="#inputs-to-a-channel-hru" class="anchor"></a>Inputs to a Channel HRU</h1>
<p>A Channel HRU is considered as representing a channel reach of length
<span class="math inline">\(L\)</span>. Each Channel HRU has two types of inflow, labelled diffuse
and point. Diffuse inflows are external inputs which occur at a
constant rate over the length of the reach. These include precipitation, the
inflow from Hillslope HRUs and time series specified in the <code>diffuse_inputs</code>
table.</p>
<p>Point inflows are considered to occur at the head of the channel reach. These
consist of the inflow from upstream channel HRUs and time series specified in the <code>point_inputs</code> table.</p>
</div>
<div id="time-delay-channel-routing" class="section level1">
<h1 class="hasAnchor">
<a href="#time-delay-channel-routing" class="anchor"></a>Time Delay Channel Routing</h1>
<p>The time delay channel routing is selected by setting the <code>channel_solver</code>
value in the model options vector to <code>histogram</code>. The method offers a basic representation of the movement of
water in which a constant velocity to assigned to each channel reach.</p>
<p>For the diffuse inputs to a single channel reach of length <span class="math inline">\(L\)</span> the
contribution to the outflow at time <span class="math inline">\(t\)</span> is given by
<span class="math display">\[
\frac{1}{L} \int\limits_{l=0}^{L} d\left(t - \frac{l}{v_{ch}}\right) dl
\]</span>
where as for a point input to the same channel the contribution is
<span class="math display">\[
p\left(t - \frac{L}{v_{ch}}\right)
\]</span>
such that
<span class="math display">\[
q\left(t\right) = \frac{1}{L} \int\limits_{l=0}^{L} d\left(t -
\frac{l}{v_{ch}}\right) dl + p\left(t - \frac{L}{v_{ch}}\right)
\]</span></p>
<p>Consider next a change of variables by taking <span class="math inline">\(\tau = l/v_{ch}\)</span> and defining
<span class="math inline">\(\tau_{L} = L/v_{ch}\)</span> so that
<span class="math display">\[
q\left(t\right) =
\frac{v_{ch}}{L} \int\limits_{\tau=0}^{\tau_{L}} d\left(t - \tau\right) d\tau +
p\left(t - \tau_{L}\right)
\]</span></p>
<p>Since the action on the point inputs is purely advective the flow at a gauged
location can be written as the summation of the diffuse and external point
inflows to the Channel
HRUs (reachs) above the location. For the <span class="math inline">\(k\)</span>th Channel HRU above the gauge let
<span class="math inline">\(\tau_{0}^{\left[k\right]}\)</span> be the advective time delay between water leaving the reach and
arriving at the gauge. This is readily computed from the channel HRU
connectivity, reach lengths and velocities. The gauged flow can thus be
expressed as</p>
<p><span class="math display">\[
g\left(t\right) = \sum_{k}
\frac{v_{ch}^{\left[k\right]}}{L^{\left[k\right]}}
\int\limits_{\tau_{0}^{\left[k\right]}}^{\tau_{0}^{\left[k\right]} + \tau_{L}^{\left[k\right]}} d\left(t -
\tau \right) d\tau +
\hat{p}\left(t - \tau_{0}^{\left[k\right]} - \tau_{L}^{\left[k\right]}\right)
\]</span></p>
<p>To solve for the gauge flow on a discrete time step <span class="math inline">\(\Delta t\)</span> suppose that
<span class="math inline">\(t = i\Delta t\)</span> and that the flow index by the time subscript is valid over
the preceeding time step; for example
<span class="math display">\[
d\left(t\right) = d_{i\Delta t} \quad \left(i-1\right)\Delta t \leq t &lt;i\Delta t
\]</span></p>
<p>Then to evaluate <span class="math inline">\(g_{i\Delta t}\)</span> while maintaing mass
conservation in the formulation, the gauged flows must be integrated over the
time period. Consider one of the contributing
HRUs, then (dropping the superscript <span class="math inline">\(k\)</span>) the contribution of the point inflow
is
<span class="math display">\[
\frac{1}{\Delta t}\int\limits_{\left(i-1\right)\Delta t}^{i\Delta
  t} \hat{p}\left(t - \tau_{0} - \tau_{L}\right) dt
=
\frac{\left(r_{L}+1\right)\Delta t - \left(\tau_{0}+\tau_{L}\right)}{\Delta t}
\hat{p}_{\left(i-r_L\right)\Delta t} +
\frac{\tau_0 + \tau_L- r_L \Delta t}{\Delta t}
\hat{p}_{\left(i-1-r_L\right)\Delta t}
\]</span>
where <span class="math inline">\(r_L\)</span> is the largest integer for which
<span class="math inline">\(r_{L}\Delta t \leq \tau_0 + \tau_L\)</span>.
The right hand side of this expression gives the time delay histogram for the
point inflow.</p>
<p>As similar expression holds for each value of <span class="math inline">\(\tau\)</span> along the HRU, such that
the average inflow at that point over the time step is given by
<span class="math display">\[
\frac{1}{\Delta t}\int\limits_{\left(i-1\right)\Delta t}^{i\Delta
  t} d\left(t - \tau\right) dt
=
\frac{\left(r_{\tau}+1\right)\Delta t - \tau}{\Delta t}
d_{\left(i-r_{\tau}\right)\Delta t} +
\frac{\tau- r_{\tau} \Delta t}{\Delta t}
d_{\left(i-1-r_{\tau}\right)\Delta t}
\]</span>
where <span class="math inline">\(r_\tau\)</span> is the largest integer for which
<span class="math inline">\(r_{\tau}\Delta t \leq \tau\)</span>.
Next consider the integral of the difuse inflows over <span class="math inline">\(\tau\)</span>; that is
<span class="math display">\[
\int\limits_{\tau_{0}}^{\tau_{0} +
  \tau_{L}}
\frac{\left(r_{\tau}+1\right)\Delta t - \tau}{\Delta t}
d_{\left(i-r_{\tau}\right)\Delta t} +
\frac{\tau- r_{\tau} \Delta t}{\Delta t}
d_{\left(i-1-r_{\tau}\right)\Delta t} d\tau
\]</span></p>
<p>The range of <span class="math inline">\(\tau\)</span> can be divided into intervals which share the same value
of <span class="math inline">\(r_{\tau}\)</span>. Defining the minimum value of <span class="math inline">\(r_\tau\)</span> as
<span class="math inline">\(r_{0} = r_{\tau_{0}}\)</span> then if <span class="math inline">\(r_{L}&gt;r_{0}\)</span> the intervals are given by
<span class="math display">\[
\left(\tau_0,\left(r_{0}+1\right)\Delta t\right),
\left(\left(r_{0}+1\right)\Delta t,\left(r_{0}+2\right)\Delta t\right),
\ldots,
\left(\left(r_{0}+n\right)\Delta t,\tau_{0}+\tau_{L}\right)
\]</span></p>
<p>For <span class="math inline">\(j=1,\ldots,n-1\)</span> the integral over an interval of <span class="math inline">\(\Delta t\)</span> gives
<span class="math display">\[
\int\limits_{\left(r_{0}+j\right)\Delta t}^{\left(r_{0}+j+1\right)\Delta t}
\frac{\left(r_{0}+j+1\right)\Delta t - \tau}{\Delta t}
d_{\left(i-r_{0}-j\right)\Delta t} +
\frac{\tau- \left(r_{0}+j\right) \Delta t}{\Delta t}
d_{\left(i-r_{0}-j-1\right)\Delta t} d\tau \\
= \frac{\Delta t}{2}
\left(\left(r_{0}+j+1\right)-\left(r_{0}+j\right)\right)^2
d_{\left(i-r-j\right)\Delta t} +
\frac{\Delta t}{2}
\left(\left(r_{0}+j+1\right)-\left(r_{0}+j\right)\right)^2
d_{\left(i-r-j-1\right)\Delta t} \\
=  \frac{\Delta t}{2} d_{\left(i-r_{0}-j\right)\Delta t} +
\frac{\Delta t}{2} d_{\left(i-r_{0}-j-1\right)\Delta t}
\]</span></p>
<p>For the initial interval
<span class="math display">\[
\int\limits_{\tau_{0}}^{\left(r_{0}+1\right)\Delta t}
\frac{\left(r_{0}+1\right)\Delta t - \tau}{\Delta t}
d_{\left(i-r_{0}\right)\Delta t} +
\frac{\tau- r_{0}\Delta t}{\Delta t}
d_{\left(i-r_{0}-1\right)\Delta t} d\tau \\
= \frac{1}{2\Delta t} \left(\left(r_0+1\right)\Delta t - \tau_{0}\right)^2
d_{\left(i-r_{0}\right)\Delta t} +
\left\{
\frac{1}{2\Delta t} \left(\left(r_0+1\right)\Delta t - \tau_{0}\right)^2 +
\frac{ \left(\tau_{0} - r_{0}\Delta t\right)\left(\left(r_0+1\right)\Delta t -
  \tau_{0}\right)}{\Delta t} \right\}
d_{\left(i-r_{0}-1\right)\Delta t}
\]</span></p>
<p>and the final interval and noting that <span class="math inline">\(r_{0}+n = r_{L}\)</span>
<span class="math display">\[
\int\limits_{r_{L}\Delta t}^{\tau_0+\tau_L}
\frac{\left(r_{L}+1\right)\Delta t - \tau}{\Delta t}
d_{\left(i-r_{L}\right)\Delta t} +
\frac{\tau- r_{L} \Delta t}{\Delta t}
d_{\left(i-r_{L}-1\right)\Delta t} d\tau \\
= 
\left\{
\frac{1}{2\Delta t} \left(\tau_0 + \tau_{L} - r_L\Delta t\right)^2 +
\frac{ \left(\tau_0 + \tau_{L} - r_L\Delta t\right)\left(\left(r_L + 1
  \right)\Delta t - \tau_{0} - \tau_L\right)}{\Delta t}
\right\}d_{\left(i-r_{L}\right)\Delta t} +
\frac{1}{2\Delta t} \left(\tau_0 + \tau_{L} - r_L\Delta t\right)^2
d_{\left(i-r_{L}-1\right)\Delta t}
\]</span></p>
<p>By grouping the terms for the individual inputs together and multiply through
by <span class="math inline">\(v_{ch}/L\)</span> time delay histograms
can be constructed for each HRU draining to the gauge. Table <a href="#tab:table-full">2</a> shows the solution for
<span class="math inline">\(r_{L}&gt;r_0+1\)</span> and Table <a href="#tab:table-three">3</a> for the case <span class="math inline">\(r_{L}=r_0+1\)</span>.</p>
<table class="table">
<caption>
<span id="tab:table-full">Table 2: </span> Outline of the time delay histogram for the diffuse input in the case <span class="math inline">\(r_{L}&gt;r_0+1\)</span>
</caption>
<colgroup>
<col width="30%">
<col width="38%">
<col width="30%">
</colgroup>
<thead><tr class="header">
<th>Delay</th>
<th>Inflow</th>
<th>Weight</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(r=0,\ldots,r_0-1\)</span></td>
<td><span class="math inline">\(d_{\left(i-r\right)\Delta t}\)</span></td>
<td>0</td>
</tr>
<tr class="even">
<td><span class="math inline">\(r_0\)</span></td>
<td><span class="math inline">\(d_{\left(i-r_0\right)\Delta t}\)</span></td>
<td><span class="math inline">\(\frac{v_{ch}}{2L\Delta t} \left(\left(r_0+1\right)\Delta t - \tau_{0}\right)^2\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(r_0+1\)</span></td>
<td><span class="math inline">\(d_{\left(i-r_0-1\right)\Delta t}\)</span></td>
<td><span class="math inline">\(\frac{v_{ch}\Delta t}{2L} + \frac{v_{ch}}{2L\Delta t} \left(\left(r_0+1\right)\Delta t - \tau_{0}\right)^2 + \frac{ v_{ch}\left(\tau_{0} - r_{0}\Delta t\right)\left(\left(r_0+1\right)\Delta t - \tau_{0}\right)}{L\Delta t}\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(r=r_{0}+2,\ldots,r_{L}-1\)</span></td>
<td><span class="math inline">\(d_{\left(i-r\right)\Delta t}\)</span></td>
<td><span class="math inline">\(\frac{v_{ch}\Delta t}{L}\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(r_{L}\)</span></td>
<td><span class="math inline">\(d_{\left(i-r_{L}\right)\Delta t}\)</span></td>
<td><span class="math inline">\(\frac{v_{ch}\Delta t}{2L} + \frac{v_{ch}}{2L\Delta t} \left(\tau_0 + \tau_{L} - r_L\Delta t\right)^2 + \frac{ v_{ch}\left(\tau_0 + \tau_{L} - r_L\Delta t\right)\left(\left(r_L + 1 \right)\Delta t - \tau_{0} - \tau_L\right)}{L\Delta t}\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(r_{L}+1\)</span></td>
<td><span class="math inline">\(d_{\left(i-r_{L}-1\right)\Delta t}\)</span></td>
<td><span class="math inline">\(\frac{v_{ch}}{2L\Delta t} \left(\tau_0 + \tau_{L} - r_L\Delta t\right)^2\)</span></td>
</tr>
</tbody>
</table>
<table class="table">
<caption>
<span id="tab:table-three">Table 3: </span> Outline of the time delay histogram for the diffuse input in the case <span class="math inline">\(r_{L}=r_0+1\)</span>
</caption>
<colgroup>
<col width="30%">
<col width="38%">
<col width="30%">
</colgroup>
<thead><tr class="header">
<th>Delay</th>
<th>Inflow</th>
<th>Weight</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(r=0,\ldots,r_0-1\)</span></td>
<td><span class="math inline">\(d_{\left(i-r\right)\Delta t}\)</span></td>
<td>0</td>
</tr>
<tr class="even">
<td><span class="math inline">\(r_0\)</span></td>
<td><span class="math inline">\(d_{\left(i-r_0\right)\Delta t}\)</span></td>
<td><span class="math inline">\(\frac{v_{ch}}{2L\Delta t} \left(\left(r_0+1\right)\Delta t - \tau_{0}\right)^2\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(r_0+1 = r_{L}\)</span></td>
<td><span class="math inline">\(d_{\left(i-r_0-1\right)\Delta t}\)</span></td>
<td><span class="math display">\[\frac{v_{ch}}{2L\Delta t}\left(\left(r_0+1\right)\Delta t -
\tau_{0}\right)^2
+
\frac{v_{ch}\left(\tau_{0} - r_{0}\Delta
 t\right)\left(\left(r_0+1\right)\Delta t- \tau_{0}\right)}{L\Delta t}
+\\
\frac{v_{ch}}{L\Delta t}\left(\tau_0 + \tau_{L} - r_L\Delta t\right)^2
+
\frac{
 v_{ch}\left(\tau_0 + \tau_{L} - r_L\Delta t\right)\left(\left(r_L + 1
 \right)\Delta t - \tau_{0} - \tau_L\right)}{L\Delta t}\]</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(r_{L}+1\)</span></td>
<td><span class="math inline">\(d_{\left(i-r_{L}-1\right)\Delta t}\)</span></td>
<td><span class="math inline">\(\frac{v_{ch}}{2L\Delta t} \left(\tau_0 + \tau_{L} - r_L\Delta t\right)^2\)</span></td>
</tr>
</tbody>
</table>
<p>The final case to consider is <span class="math inline">\(r_{0} = r_{L}\)</span>. In this case there is a single
integral to evaluate:
<span class="math display">\[
\int\limits_{\tau_{0}}^{\tau_{0}+\tau_{L}}
\frac{\left(r_{0}+1\right)\Delta t - \tau}{\Delta t}
d_{\left(i-r_{0}\right)\Delta t} +
\frac{\tau- r_{0} \Delta t}{\Delta t}
d_{\left(i-r_{0}-1\right)\Delta t} d\tau \\
= \frac{\tau_{L}}{\Delta t}
\left(\left(r_{0}+1\right)\Delta t - \tau_{0} - \tau_{L}/2 \right)
d_{\left(i-r_{0}\right)\Delta t} +
\frac{\tau_{L}}{\Delta t}
\left(\tau_{)} + \tau_{L}/2 - r_{0}\Delta t\right)
d_{\left(i-r_{0}-1\right)\Delta t}
\]</span></p>
<div id="examples" class="section level2">
<h2 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h2>
<p>In this section some example histograms are generated based upon the length,
velocity and <span class="math inline">\(\tau_0\)</span> of the Channel HRU alond with the time step <span class="math inline">\(\Delta t\)</span>.</p>
<div id="point-input" class="section level3">
<h3 class="hasAnchor">
<a href="#point-input" class="anchor"></a>Point input</h3>
<p>First a function for defining the histrogram for a point inflow can be coded
as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## L is length of channel</span>
<span class="co">## vch is channel velocity</span>
<span class="co">## Dt is the time step</span>
<span class="co">## tau0 is the time delay between the gauge and foot of the reach</span>
<span class="va">fp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">L</span>,<span class="va">vch</span>,<span class="va">Dt</span>,<span class="va">tau0</span><span class="op">)</span><span class="op">{</span>
  <span class="va">tauL</span> <span class="op">&lt;-</span> <span class="va">L</span><span class="op">/</span><span class="va">vch</span>
  <span class="va">rL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="op">(</span><span class="va">tau0</span><span class="op">+</span><span class="va">tauL</span><span class="op">)</span><span class="op">/</span><span class="va">Dt</span><span class="op">)</span>
  <span class="va">irL</span> <span class="op">&lt;-</span> <span class="va">rL</span><span class="op">+</span><span class="fl">1</span> <span class="co">## index in vector since R starts at 1 not zero</span>
  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">irL</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>
  <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">rL</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">Dt</span> <span class="op">-</span> <span class="va">tau0</span><span class="op">-</span><span class="va">tauL</span><span class="op">)</span><span class="op">/</span><span class="va">Dt</span>
  <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tau0</span><span class="op">+</span><span class="va">tauL</span> <span class="op">-</span> <span class="va">rL</span><span class="op">*</span><span class="va">Dt</span><span class="op">)</span><span class="op">/</span><span class="va">Dt</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>For the first example all the input should occur with one time step delay
(second element in output vector) since <span class="math inline">\(L/v_ch\)</span> exactly matches the time step
and <span class="math inline">\(\tau_{0}=0\)</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fp</span><span class="op">(</span>L<span class="op">=</span><span class="fl">100</span>,vch<span class="op">=</span><span class="fl">0.5</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt; [1] 0 1 0</span></code></pre></div>
<p>In this example <span class="math inline">\(\tau_{0}+L/v_ch = \frac{7}{2}\Delta t\)</span>; so the first non zero
value of the vector should be the 4th element with the 4th and 5th
elements being equal.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fp</span><span class="op">(</span>L<span class="op">=</span><span class="fl">100</span>,vch<span class="op">=</span><span class="fl">1</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">600</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.0 0.0 0.0 0.5 0.5</span></code></pre></div>
<p>This build upon the above example, altering the velocity such that the only
non-zero elements are the 4th and 5th, but with the 4th being larger then the 5th.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fp</span><span class="op">(</span>L<span class="op">=</span><span class="fl">100</span>,vch<span class="op">=</span><span class="fl">1.5</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">600</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.0000000 0.0000000 0.0000000 0.6666667 0.3333333</span></code></pre></div>
</div>
<div id="diffuse-inflow" class="section level3">
<h3 class="hasAnchor">
<a href="#diffuse-inflow" class="anchor"></a>Diffuse inflow</h3>
<p>The function for the difuse inflow is more complex since the special cases
have to be handled:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">L</span>,<span class="va">vch</span>,<span class="va">Dt</span>,<span class="va">tau0</span><span class="op">)</span><span class="op">{</span>
  <span class="va">tauL</span> <span class="op">&lt;-</span> <span class="va">L</span><span class="op">/</span><span class="va">vch</span>
  <span class="va">r0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">tau0</span><span class="op">/</span><span class="va">Dt</span><span class="op">)</span>
  <span class="va">ir0</span> <span class="op">&lt;-</span> <span class="va">r0</span><span class="op">+</span><span class="fl">1</span> <span class="co">## index in vector since R starts at 1 not zero</span>
  <span class="va">rL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="op">(</span><span class="va">tau0</span><span class="op">+</span><span class="va">tauL</span><span class="op">)</span><span class="op">/</span><span class="va">Dt</span><span class="op">)</span>
  <span class="va">irL</span> <span class="op">&lt;-</span> <span class="va">rL</span><span class="op">+</span><span class="fl">1</span> <span class="co">## index in vector since R starts at 1 not zero</span>
  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">irL</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="va">rL</span><span class="op">&gt;</span><span class="va">r0</span><span class="op">)</span><span class="op">{</span>
    <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">:</span><span class="op">(</span><span class="va">irL</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Dt</span> <span class="co"># inital values valid unless over written</span>
    <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span> <span class="op">(</span><span class="op">(</span><span class="va">r0</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">Dt</span> <span class="op">-</span> <span class="va">tau0</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">Dt</span><span class="op">)</span>
    <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span> <span class="op">(</span><span class="op">(</span><span class="va">r0</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">Dt</span> <span class="op">-</span> <span class="va">tau0</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">tau0</span> <span class="op">-</span> <span class="op">(</span><span class="va">r0</span><span class="op">*</span><span class="va">Dt</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">/</span> <span class="va">Dt</span>
    <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span> <span class="op">(</span><span class="va">tau0</span><span class="op">+</span><span class="va">tauL</span> <span class="op">-</span> <span class="op">(</span><span class="va">rL</span><span class="op">*</span><span class="va">Dt</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">Dt</span><span class="op">)</span>
    <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">]</span> <span class="op">+</span> <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span> <span class="op">(</span><span class="op">(</span><span class="va">tau0</span><span class="op">+</span><span class="va">tauL</span> <span class="op">-</span> <span class="op">(</span><span class="va">rL</span><span class="op">*</span><span class="va">Dt</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">rL</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">Dt</span> <span class="op">-</span> <span class="va">tau0</span><span class="op">-</span><span class="va">tauL</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">Dt</span> <span class="op">)</span> <span class="co">## added to self since rL could equal r0+1</span>
    <span class="kw">if</span><span class="op">(</span> <span class="va">rL</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">r0</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span>
      <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">Dt</span><span class="op">/</span><span class="fl">2</span>
      <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">[</span><span class="va">irL</span><span class="op">]</span> <span class="op">+</span> <span class="va">Dt</span><span class="op">/</span><span class="fl">2</span>
    <span class="op">}</span>
  <span class="op">}</span><span class="kw">else</span><span class="op">{</span>
    <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tauL</span><span class="op">/</span><span class="va">Dt</span><span class="op">)</span><span class="op">*</span><span class="op">(</span> <span class="op">(</span><span class="va">r0</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">Dt</span> <span class="op">-</span> <span class="va">tau0</span> <span class="op">-</span> <span class="op">(</span><span class="va">tauL</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">)</span>
    <span class="va">b</span><span class="op">[</span><span class="va">ir0</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">tauL</span><span class="op">/</span><span class="va">Dt</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">tau0</span> <span class="op">+</span> <span class="op">(</span><span class="va">tauL</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="va">r0</span><span class="op">*</span><span class="va">Dt</span> <span class="op">)</span>
  <span class="op">}</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">b</span><span class="op">*</span><span class="va">vch</span><span class="op">/</span><span class="va">L</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>In the first example there is no advective time delay and
<span class="math inline">\(L/v_{ch} = \Delta t\)</span>. This results in time delay historgram in which the
first two values equal 0.5. This is an example of the case <span class="math inline">\(r_{L}=r_{0}+1\)</span></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">fd</span><span class="op">(</span>L<span class="op">=</span><span class="fl">200</span>,vch<span class="op">=</span><span class="fl">1</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></code></pre></div>
<p><img src="Channel_HRU_files/figure-html/unnamed-chunk-7-1.png"><!-- --></p>
<p>Extending the previous example the velocity now altered to that
<span class="math inline">\(r_{L}=r_{0}\)</span>. The resulting non-negative histogram values are now the first
two in the vector.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">fd</span><span class="op">(</span>L<span class="op">=</span><span class="fl">200</span>,vch<span class="op">=</span><span class="fl">1.5</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></code></pre></div>
<p><img src="Channel_HRU_files/figure-html/unnamed-chunk-8-1.png"><!-- --></p>
<p>In contrast decreasing the channel velocity produces a more delayed
histogram. In this case <span class="math inline">\(r_{L}&gt;r_{0}+1\)</span>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">fd</span><span class="op">(</span>L<span class="op">=</span><span class="fl">200</span>,vch<span class="op">=</span><span class="fl">0.5</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></code></pre></div>
<p><img src="Channel_HRU_files/figure-html/unnamed-chunk-9-1.png"><!-- --></p>
<p>Finally we look at two cases where <span class="math inline">\(\tau_0\)</span> is posisitve; being either a
direct multiple of the time step</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">fd</span><span class="op">(</span>L<span class="op">=</span><span class="fl">600</span>,vch<span class="op">=</span><span class="fl">1</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">800</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></code></pre></div>
<p><img src="Channel_HRU_files/figure-html/unnamed-chunk-10-1.png"><!-- --></p>
<p>or not</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">fd</span><span class="op">(</span>L<span class="op">=</span><span class="fl">600</span>,vch<span class="op">=</span><span class="fl">1</span>,Dt<span class="op">=</span><span class="fl">200</span>,tau0<span class="op">=</span><span class="fl">850</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></code></pre></div>
<p><img src="Channel_HRU_files/figure-html/unnamed-chunk-11-1.png"><!-- --></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul Smith, Peter Metcalfe.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
