<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Dynamic TOPMODEL • dynatop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Dynamic TOPMODEL">
<meta property="og:description" content="dynatop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynatop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.0.1010</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dynatop.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/HRU.html">The HRU</a>
    </li>
    <li>
      <a href="../articles/Notes_on_the_implementation_of_Dynamic_TOPMODEL.html">Notes on the implementation of Dynamic TOPMODEL</a>
    </li>
    <li>
      <a href="../articles/The_Model_Object.html">The Model Object</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/waternumbers/dynatop/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using Dynamic TOPMODEL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/waternumbers/dynatop/blob/HEAD/vignettes/dynatop.Rmd" class="external-link"><code>vignettes/dynatop.Rmd</code></a></small>
      <div class="hidden name"><code>dynatop.Rmd</code></div>

    </div>

    
    
<p>The purpose of this vignette is to provide an outline of the steps
needed to perform a Dynamic TOPMODEL simulation and introduce the
formats of the data input and returned.</p>
<p>The data used in this example comes from Swindale and is contained
within the package and can be loaded with</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://waternumbers.github.io/dynatop/" class="external-link">dynatop</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"Swindale"</span><span class="op">)</span></span></code></pre></div>
<p>which returns a variable <code>Swindale</code> with the following
components:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Swindale</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "model" "obs"</span></span></code></pre></div>
<p>For better comparison with a likely analysis we separate these into a
model and observed data variables</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">swindale_model</span> <span class="op">&lt;-</span> <span class="va">Swindale</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="va">swindale_obs</span> <span class="op">&lt;-</span> <span class="va">Swindale</span><span class="op">$</span><span class="va">obs</span></span></code></pre></div>
<div class="section level2">
<h2 id="the-model-structure">The model structure<a class="anchor" aria-label="anchor" href="#the-model-structure"></a>
</h2>
<p>A dynamic TOPMODEL is described in a list object. The list has the
following elements</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">swindale_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "hru"         "output_flux" "map"</span></span></code></pre></div>
<p>which are described in <a href="The_Model_Object.html">associated
vignette</a>. The <a href="https://waternumbers.github.io/dynatopGIS/" class="external-link">dynatopGIS</a> package
can be used for constructing models.</p>
</div>
<div class="section level2">
<h2 id="setting-map-locations">Setting map locations<a class="anchor" aria-label="anchor" href="#setting-map-locations"></a>
</h2>
<p>While not required for simulations if the locations of the files
containing the locations of the HRUs are provided the states can be
visualised within dynatop.</p>
<p>The locations of the files are set in the <code>map</code> element of
the model. For this example the maps are located within the
<code>extdata</code> directory of the package and can be set using
commands</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">swindale_model</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,<span class="st">"Swindale.tif"</span>,package<span class="op">=</span><span class="st">"dynatop"</span>,mustWork<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preparing-input-data">Preparing input data<a class="anchor" aria-label="anchor" href="#preparing-input-data"></a>
</h2>
<p>The input to the model is expected to take the form of an
<code>xts</code> object with constant time step whose column names are
found in the ‘precip’ and ‘pet’ columns of the HRU tables in the model.
Helpful functions for creating and manipulating <code>xts</code> objects
can be found <a href="http://rstudio-pubs-static.s3.amazonaws.com/288218_117e183e74964557a5da4fc5902fc671.html" class="external-link">here</a>,
see also the <code>resample_xts</code> function in this package.</p>
<p>The discharge, precipitation and potential evapotranspiration (PET)
inputs for Swindale are contained with <code>swindale_obs</code> on a 15
minute time step.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">swindale_obs</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: object timezone (GMT) is different from system timezone (UTC)</span></span>
<span><span class="co">#&gt;   NOTE: set 'options(xts_check_TZ = FALSE)'to disable this warning</span></span>
<span><span class="co">#&gt;     This note is displayed once per session</span></span>
<span><span class="co">#&gt;                     flow precip          pet</span></span>
<span><span class="co">#&gt; 2009-11-18 16:00:00 2.78  4e-04 8.878467e-06</span></span>
<span><span class="co">#&gt; 2009-11-18 16:15:00 2.80  2e-04 4.762229e-06</span></span>
<span><span class="co">#&gt; 2009-11-18 16:30:00 2.85  4e-04 8.585708e-07</span></span>
<span><span class="co">#&gt; 2009-11-18 16:45:00 2.94  2e-04 0.000000e+00</span></span>
<span><span class="co">#&gt; 2009-11-18 17:00:00 3.02  2e-04 0.000000e+00</span></span>
<span><span class="co">#&gt; 2009-11-18 17:15:00 3.15  2e-04 0.000000e+00</span></span></code></pre></div>
<p>Note the discharge is in m<span class="math inline">\(^{3}\)</span>/s
while the precipitation and PET are in m accumulated over the time
step.</p>
<p>To use the data with the model we need to set the names of the time
series inputs within the model. In this case this is already done as can
be seen by inspecting the <code>precip</code> and <code>pet</code>
values for the individual HRU’s</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">swindale_model</span><span class="op">$</span><span class="va">hru</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">precip</span><span class="op">)</span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; [1] "precip"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $fraction</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">swindale_model</span><span class="op">$</span><span class="va">hru</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pet</span><span class="op">)</span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; [1] "pet"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $fraction</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="altering-parameters">Altering parameters<a class="anchor" aria-label="anchor" href="#altering-parameters"></a>
</h2>
<p>The parameter values are stored within the table describing the
hillslope and channel HRUs. Which parameters are present depends upon
the options selected for the transmissivity and channel solution.
Details can be found in the <a href="HRU.html">HRU</a> Vignettes.</p>
<p>Altering parameter values requires changing their values in the HRU
definitions. For this catchment all HRU have the same parameter values.
For this simulation we change the parameter vectors to be more
representative of the catchment</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hru</span> <span class="op">&lt;-</span> <span class="va">swindale_model</span><span class="op">$</span><span class="va">hru</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">hru</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">class</span><span class="op">$</span><span class="va">endNode</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co">## then HRU is not a channel</span></span>
<span>        <span class="co">## saturated zone parameters</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sz</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"m"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.0063</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sz</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"t_0"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">7.46</span><span class="op">)</span></span>
<span>        <span class="co">## unsaturated zone parameters</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">uz</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"t_d"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">8</span><span class="op">*</span><span class="fl">60</span><span class="op">*</span><span class="fl">60</span></span>
<span>        <span class="co">## root zone parameters</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rz</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"s_rzmax"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span>        <span class="co">## surface parameters</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sf</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"c_sf"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.4</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>        <span class="co">## then HRU is a channel - set so no subsurface response</span></span>
<span>        <span class="co">## saturated zone parameters</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sz</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"t_0"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.001</span></span>
<span>        <span class="co">## root zone parameters</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rz</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"s_rzmax"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.001</span></span>
<span>        <span class="co">## surface parameters</span></span>
<span>        <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sf</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="st">"c_sf"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.8</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co">## initialisation parameters</span></span>
<span>    <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">initialisation</span><span class="op">[</span><span class="st">"s_rz_0"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.98</span></span>
<span>    <span class="va">hru</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">initialisation</span><span class="op">[</span><span class="st">"r_uz_sz_0"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1.755582e-07</span> <span class="co">## initial outflow divided by catchment area</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-the-dynatop-object">Creating the dynatop Object<a class="anchor" aria-label="anchor" href="#creating-the-dynatop-object"></a>
</h2>
<p>Simulations are performed by embedding the model and the observed
data into a <code>dynatop</code> object. First the object is created
using the model in list form</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch_mdl</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/dynatop.html">dynatop</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">hru</span>,map<span class="op">=</span><span class="va">swindale_model</span><span class="op">$</span><span class="va">map</span><span class="op">)</span></span></code></pre></div>
<p>This step performs some basis checks on the model for consistency.
The data can then be added</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch_mdl</span><span class="op">$</span><span class="fu">add_data</span><span class="op">(</span><span class="va">swindale_obs</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-dynamic-topmodel">Running dynamic TOPMODEL<a class="anchor" aria-label="anchor" href="#running-dynamic-topmodel"></a>
</h2>
<p>The model currently consists of two types of HRU; hillslope and
channel. These can be run individually with the
<code>sim_hillslope</code> and <code>sim_channel</code> methods or
sequentially with the <code>sim</code> method. The individual methods
check that suitable input data is available, but not how it was
generated.</p>
<p>The initial states of the simulations can be specified in the model
object. If, as in the case of this example, the states are not specified
then any attempt to perform a simulation will fail.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch_mdl</span><span class="op">$</span><span class="fu">sim</span><span class="op">(</span><span class="va">swindale_model</span><span class="op">$</span><span class="va">output_flux</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in private$digest_output_defn(output_defn): Output definition does not</span></span>
<span><span class="co">#&gt; have scale - adding a vector of 1's</span></span>
<span><span class="co">#&gt; Error in ctch_mdl$sim(swindale_model$output_flux): Model states have non-finite values</span></span></code></pre></div>
<p>The states need to be initialised using the <code>initialise</code>
method which requires an initial recharge rate. In the following we
initialise the states and plot the initial saturated zone storage
deficit, using the chaining of commands.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch_mdl</span><span class="op">$</span><span class="fu">initialise</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">plot_state</span><span class="op">(</span><span class="st">"s_sz"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatop_files/figure-html/initialise-1.png" width="700"></p>
<p>The simulation can now be performed and the flow at the gauge
extracted with</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim1</span> <span class="op">&lt;-</span> <span class="va">ctch_mdl</span><span class="op">$</span><span class="fu">sim</span><span class="op">(</span><span class="va">swindale_model</span><span class="op">$</span><span class="va">output_flux</span><span class="op">)</span><span class="op">$</span><span class="fu">get_output</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in private$digest_output_defn(output_defn): Output definition does not</span></span>
<span><span class="co">#&gt; have scale - adding a vector of 1's</span></span></code></pre></div>
<p>Note that the states of the system are now those at the end of the
simulation for example:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctch_mdl</span><span class="op">$</span><span class="fu">plot_state</span><span class="op">(</span><span class="st">"s_sz"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatop_files/figure-html/new_states-1.png" width="700"></p>
<p>Rerunning the simulation with the new initial states will of course
produce different results. Output for the above examples can be plotted
against observed discharge for comparison as follows:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim2</span> <span class="op">&lt;-</span> <span class="va">ctch_mdl</span><span class="op">$</span><span class="fu">sim</span><span class="op">(</span><span class="va">swindale_model</span><span class="op">$</span><span class="va">output_flux</span><span class="op">)</span><span class="op">$</span><span class="fu">get_output</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in private$digest_output_defn(output_defn): Output definition does not</span></span>
<span><span class="co">#&gt; have scale - adding a vector of 1's</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">swindale_obs</span>,<span class="va">sim1</span><span class="op">)</span>,<span class="va">sim2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">swindale_obs</span><span class="op">)</span>,<span class="st">'sim_1'</span>,<span class="st">'sim_2'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'flow'</span>,<span class="st">'sim_1'</span>,<span class="st">'sim_2'</span><span class="op">)</span><span class="op">]</span>, main<span class="op">=</span><span class="st">"Discharge"</span>,ylab<span class="op">=</span><span class="st">"m3/s"</span>,legend.loc<span class="op">=</span><span class="st">"topright"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatop_files/figure-html/sim2-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="mass-balance">Mass balance<a class="anchor" aria-label="anchor" href="#mass-balance"></a>
</h2>
<p>It is possible to output the mass balance check for each time step of
the simulation using the <code>get_mass_errors</code> method. The
returned matrix gives the volumes in the states at the start and end of
the time step along with the other fluxes as volumes. This can easily be
used to plot the errors as shown below.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="va">ctch_mdl</span><span class="op">$</span><span class="fu">get_mass_errors</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">mb</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span> , main<span class="op">=</span><span class="st">"Mass Error"</span>, ylab<span class="op">=</span><span class="st">"[m^3]"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dynatop_files/figure-html/mass_check-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Paul Smith, Peter Metcalfe.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
